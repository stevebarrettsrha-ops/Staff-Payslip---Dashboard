<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>C.E.S.T.I.S - Payroll Management System</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<!-- Google Identity Services for OAuth -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#0c1220;--surface:#141c2e;--card:#1a2540;--border:#253354;
--primary:#3b82f6;--primary-glow:rgba(59,130,246,.15);
--accent:#f59e0b;--accent2:#10b981;--danger:#ef4444;
--text:#e2e8f0;--text-dim:#94a3b8;--text-muted:#64748b;
--gold:#f59e0b;--green:#10b981;--red:#ef4444;
}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.app{display:flex;min-height:100vh}

/* Sidebar */
.sidebar{width:240px;background:var(--surface);border-right:1px solid var(--border);padding:1rem 0;display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100}
.sidebar-brand{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);margin-bottom:.5rem}
.sidebar-brand h1{font-size:.85rem;font-weight:700;color:var(--accent);letter-spacing:2px;text-transform:uppercase}
.sidebar-brand p{font-size:.7rem;color:var(--text-dim);margin-top:.25rem;letter-spacing:.5px}
.sidebar-nav{flex:1;padding:.5rem}
.nav-item{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;border-radius:8px;cursor:pointer;color:var(--text-dim);font-size:.85rem;font-weight:500;transition:all .2s;margin-bottom:2px}
.nav-item:hover{background:var(--primary-glow);color:var(--text)}
.nav-item.active{background:var(--primary);color:#fff;box-shadow:0 4px 12px rgba(59,130,246,.3)}
.nav-item .icon{font-size:1.1rem;width:20px;text-align:center}
.sidebar-footer{padding:1rem 1.5rem;border-top:1px solid var(--border);font-size:.7rem;color:var(--text-muted)}

/* Main Content */
.main{margin-left:240px;flex:1;padding:1.5rem 2rem}
.page{display:none}
.page.active{display:block}

/* Header Bar */
.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
.page-header h2{font-size:1.35rem;font-weight:700;color:var(--text)}
.page-header .subtitle{font-size:.8rem;color:var(--text-dim);margin-top:.15rem}

/* Cards */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.25rem;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.stat-card.blue::before{background:var(--primary)}
.stat-card.gold::before{background:var(--gold)}
.stat-card.green::before{background:var(--green)}
.stat-card.red::before{background:var(--red)}
.stat-card .label{font-size:.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;font-weight:600}
.stat-card .value{font-size:1.5rem;font-weight:700;margin-top:.35rem;font-family:'JetBrains Mono',monospace}
.stat-card .sub{font-size:.7rem;color:var(--text-dim);margin-top:.25rem}

/* Panels */
.panel{background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:1.5rem;overflow:hidden}
.panel-head{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;border-bottom:1px solid var(--border)}
.panel-head h3{font-size:.95rem;font-weight:600}
.panel-body{padding:1.25rem}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:.4rem;padding:.5rem 1rem;border:none;border-radius:6px;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .15s}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:hover{background:#2563eb;box-shadow:0 4px 12px rgba(59,130,246,.3)}
.btn-success{background:var(--green);color:#fff}
.btn-success:hover{background:#059669}
.btn-warning{background:var(--gold);color:#000}
.btn-danger{background:var(--red);color:#fff}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text-dim)}
.btn-ghost:hover{border-color:var(--primary);color:var(--primary)}
.btn-sm{padding:.35rem .75rem;font-size:.75rem}
.btn-group{display:flex;gap:.5rem;flex-wrap:wrap}

/* Tables */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:.65rem .75rem;font-size:.7rem;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);background:rgba(0,0,0,.2);white-space:nowrap}
td{padding:.6rem .75rem;font-size:.82rem;border-bottom:1px solid rgba(37,51,84,.5);white-space:nowrap}
tr:hover td{background:rgba(59,130,246,.04)}
.mono{font-family:'JetBrains Mono',monospace;font-size:.78rem}
.text-right{text-align:right}
.text-center{text-align:center}
.tag{display:inline-block;padding:.15rem .5rem;border-radius:4px;font-size:.7rem;font-weight:600}
.tag-ft{background:rgba(59,130,246,.15);color:#60a5fa}
.tag-pt{background:rgba(245,158,11,.15);color:#fbbf24}

/* Forms */
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem}
.form-group{display:flex;flex-direction:column;gap:.3rem}
.form-group label{font-size:.75rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.3px}
.form-group input,.form-group select,.form-group textarea{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:.55rem .75rem;color:var(--text);font-family:inherit;font-size:.85rem}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}
.form-group input[type="number"]{font-family:'JetBrains Mono',monospace}

/* Modal */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:500;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-radius:14px;width:90%;max-width:600px;max-height:85vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:1.25rem 1.5rem;border-bottom:1px solid var(--border)}
.modal-header h3{font-size:1rem;font-weight:600}
.modal-close{background:none;border:none;color:var(--text-dim);font-size:1.3rem;cursor:pointer}
.modal-body{padding:1.5rem}
.modal-footer{padding:1rem 1.5rem;border-top:1px solid var(--border);display:flex;gap:.5rem;justify-content:flex-end}

/* Payslip Print */
.payslip-container{display:none}
@media print{
  @page{size:A4 portrait;margin:10mm 12mm}
  body *{visibility:hidden}
  .payslip-container,.payslip-container *{visibility:visible!important}
  .payslip-container{display:block!important;position:fixed;top:0;left:0;width:100%;background:#fff;z-index:9999;padding:0}
  .payslip-print{padding:0;max-width:100%;page-break-inside:avoid}
  .payslip-print .ps-header{padding-bottom:.5rem;margin-bottom:.75rem}
  .payslip-print .ps-info{gap:.25rem;margin-bottom:.75rem;font-size:.78rem}
  .payslip-print .ps-table{margin-bottom:.75rem}
  .payslip-print .ps-table th{padding:.35rem .5rem;font-size:.7rem}
  .payslip-print .ps-table td{padding:.3rem .5rem;font-size:.78rem}
  .payslip-print .ps-table .amt{font-size:.75rem}
  .payslip-print .ps-totals{gap:.75rem;margin-top:.75rem;padding-top:.5rem}
  .payslip-print .ps-totals .box{padding:.5rem}
  .payslip-print .ps-totals .box .val{font-size:1rem;margin-top:.15rem}
  .payslip-print .ps-footer{margin-top:1rem;padding-top:.5rem}
}
.payslip-print{background:#fff;color:#000;padding:2rem;max-width:700px;margin:0 auto;font-family:'DM Sans',sans-serif}
.payslip-print .ps-header{text-align:center;border-bottom:3px solid #1a2540;padding-bottom:1rem;margin-bottom:1.5rem}
.payslip-print .ps-header h2{font-size:1.1rem;color:#1a2540;letter-spacing:2px}
.payslip-print .ps-header p{font-size:.8rem;color:#666;margin-top:.25rem}
.payslip-print .ps-info{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:1.5rem;font-size:.82rem}
.payslip-print .ps-info .row{display:flex;gap:.5rem}
.payslip-print .ps-info .lbl{font-weight:700;color:#333;min-width:110px}
.payslip-print .ps-info .val{color:#555}
.payslip-print .ps-table{width:100%;border-collapse:collapse;margin-bottom:1.5rem}
.payslip-print .ps-table th{background:#1a2540;color:#fff;padding:.5rem .75rem;font-size:.75rem;text-transform:uppercase;letter-spacing:.5px;text-align:left}
.payslip-print .ps-table td{padding:.45rem .75rem;border-bottom:1px solid #e5e7eb;font-size:.82rem}
.payslip-print .ps-table .amt{font-family:'JetBrains Mono',monospace;text-align:right;font-size:.8rem}
.payslip-print .ps-totals{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;margin-top:1.5rem;padding-top:1rem;border-top:2px solid #1a2540}
.payslip-print .ps-totals .box{text-align:center;padding:.75rem;border:1px solid #e5e7eb;border-radius:6px}
.payslip-print .ps-totals .box .lbl{font-size:.7rem;color:#666;text-transform:uppercase;font-weight:600}
.payslip-print .ps-totals .box .val{font-size:1.1rem;font-weight:700;color:#1a2540;font-family:'JetBrains Mono',monospace;margin-top:.25rem}
.payslip-print .ps-footer{margin-top:2rem;padding-top:1rem;border-top:1px solid #e5e7eb;font-size:.7rem;color:#999;text-align:center}

/* Payslip Preview (on screen) */
.payslip-preview{background:#fff;color:#000;padding:2rem;border-radius:10px;max-width:700px;margin:1rem auto}
.payslip-preview .ps-header{text-align:center;border-bottom:3px solid #1a2540;padding-bottom:1rem;margin-bottom:1.5rem}
.payslip-preview .ps-header h2{font-size:1.1rem;color:#1a2540;letter-spacing:2px}
.payslip-preview .ps-header p{font-size:.8rem;color:#666;margin-top:.25rem}
.payslip-preview .ps-info{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:1.5rem;font-size:.82rem}
.payslip-preview .ps-info .row{display:flex;gap:.5rem}
.payslip-preview .ps-info .lbl{font-weight:700;color:#333;min-width:110px}
.payslip-preview .ps-info .val{color:#555}
.payslip-preview .ps-table{width:100%;border-collapse:collapse;margin-bottom:1.5rem}
.payslip-preview .ps-table th{background:#1a2540;color:#fff;padding:.5rem .75rem;font-size:.75rem;text-transform:uppercase;letter-spacing:.5px;text-align:left}
.payslip-preview .ps-table td{padding:.45rem .75rem;border-bottom:1px solid #e5e7eb;font-size:.82rem}
.payslip-preview .ps-table .amt{font-family:'JetBrains Mono',monospace;text-align:right;font-size:.8rem}
.payslip-preview .ps-totals{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;margin-top:1.5rem;padding-top:1rem;border-top:2px solid #1a2540}
.payslip-preview .ps-totals .box{text-align:center;padding:.75rem;border:1px solid #e5e7eb;border-radius:6px}
.payslip-preview .ps-totals .box .lbl{font-size:.7rem;color:#666;text-transform:uppercase;font-weight:600}
.payslip-preview .ps-totals .box .val{font-size:1.1rem;font-weight:700;color:#1a2540;font-family:'JetBrains Mono',monospace;margin-top:.25rem}
.payslip-preview .ps-footer{margin-top:2rem;padding-top:1rem;border-top:1px solid #e5e7eb;font-size:.7rem;color:#999;text-align:center}

/* Quarter Navigation Bar */
.quarter-nav{display:flex;align-items:center;gap:.75rem;margin-bottom:1.25rem;flex-wrap:wrap}
.fy-selector{display:flex;align-items:center;gap:0;background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden}
.fy-arrow{background:none;border:none;color:var(--text-dim);font-size:1rem;padding:.5rem .7rem;cursor:pointer;font-family:inherit;transition:all .15s;line-height:1}
.fy-arrow:hover{background:var(--primary-glow);color:var(--primary)}
.fy-label{padding:.45rem .9rem;font-size:.85rem;font-weight:700;color:var(--accent);letter-spacing:.5px;white-space:nowrap;border-left:1px solid var(--border);border-right:1px solid var(--border);user-select:none}
.quarter-tabs{display:flex;gap:0;border-radius:8px;overflow:hidden;border:1px solid var(--border)}
.quarter-tab{padding:.55rem 1.1rem;background:var(--surface);color:var(--text-dim);font-size:.8rem;font-weight:600;cursor:pointer;border:none;font-family:inherit;transition:all .2s;position:relative;white-space:nowrap}
.quarter-tab:not(:last-child){border-right:1px solid var(--border)}
.quarter-tab:hover{background:var(--primary-glow);color:var(--text)}
.quarter-tab.active{background:var(--primary);color:#fff;box-shadow:0 2px 8px rgba(59,130,246,.3)}
.quarter-tab .q-sub{font-weight:400;opacity:.7;margin-left:.3rem;font-size:.72rem}
.quarter-tab.active .q-sub{opacity:.85}
.qtr-nav-btns{display:flex;gap:.4rem;margin-left:auto}
.qtr-nav-btn{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:.45rem .85rem;color:var(--text-dim);font-size:.78rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s;white-space:nowrap}
.qtr-nav-btn:hover{background:var(--primary-glow);border-color:var(--primary);color:var(--primary)}

/* Month Cards */
.month-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin-bottom:1.25rem}
.month-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:.85rem 1rem;cursor:pointer;transition:all .2s;text-align:center;position:relative}
.month-card:hover{border-color:var(--primary);background:var(--primary-glow)}
.month-card.active{border-color:var(--primary);background:var(--primary-glow);box-shadow:0 0 0 2px rgba(59,130,246,.2)}
.month-card.completed{border-color:var(--green)}
.month-card.completed::after{content:'';position:absolute;top:6px;right:6px;width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 4px var(--green)}
.month-card .month-name{font-size:.85rem;font-weight:600;color:var(--text)}
.month-card .month-status{font-size:.7rem;color:var(--text-muted);margin-top:.2rem}
.month-card.completed .month-status{color:var(--green)}
.month-card.active .month-name{color:var(--primary)}

/* Quarter Summary Stats */
.quarter-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.75rem;margin-bottom:1.25rem}
.quarter-stat{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:.75rem 1rem;text-align:center}
.quarter-stat .qs-label{font-size:.65rem;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);font-weight:600}
.quarter-stat .qs-value{font-size:1.1rem;font-weight:700;font-family:'JetBrains Mono',monospace;margin-top:.2rem}

/* Quarter History */
.payslip-link{color:var(--primary);cursor:pointer;font-size:.78rem;font-weight:600;text-decoration:none;transition:color .15s}
.payslip-link:hover{color:#60a5fa;text-decoration:underline}

/* Salary Records */
#salaryRecordsTable table{min-width:1100px}
#salaryRecordsTable th,#salaryRecordsTable td{padding:.45rem .5rem;font-size:.75rem}
#quarterlyTable table{min-width:1000px}
#empQuarterlyTable table{min-width:900px}

/* Scrollbar */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--surface)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--text-muted)}

/* Responsive */
@media(max-width:768px){
  .sidebar{width:60px}
  .sidebar .nav-text,.sidebar-brand p,.sidebar-footer{display:none}
  .sidebar-brand h1{font-size:.6rem;text-align:center}
  .main{margin-left:60px;padding:1rem}
  .nav-item{justify-content:center;padding:.75rem}
  .stats-row{grid-template-columns:1fr 1fr}
}

/* Cloud Sync Section */
.cloud-section-label{font-size:.65rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:.5rem}
.cloud-status-row{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem;padding:.35rem .5rem;background:var(--surface);border-radius:6px}
.cloud-status-dot{width:10px;height:10px;border-radius:50%;background:var(--text-muted);display:inline-block;flex-shrink:0}
.cloud-status-dot.disconnected{background:var(--red)}
.cloud-status-dot.connected{background:var(--green);box-shadow:0 0 6px var(--green)}
.cloud-status-dot.syncing{background:var(--gold);animation:pulse 1s infinite;box-shadow:0 0 6px var(--gold)}
.cloud-status-label{font-size:.75rem;font-weight:600}
.cloud-status-label.connected{color:var(--green)}
.cloud-status-label.disconnected{color:var(--red)}
.cloud-status-label.syncing{color:var(--gold)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.spinning{display:inline-block;animation:spin 1s linear infinite}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

/* Cloud Sync Button */
.cloud-sync-btn{display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;font-family:inherit;font-size:0.75rem;font-weight:500;transition:all 0.2s;width:100%}
.cloud-sync-btn:hover{background:var(--primary-glow);border-color:var(--primary)}
.cloud-sync-btn .btn-arrow{margin-left:auto;font-size:0.6rem;color:var(--text-muted)}

/* Cloud Sync Info below button */
.cloud-sync-meta{font-size:.65rem;color:var(--text-muted);margin-top:.4rem;padding:0 .25rem;line-height:1.4}

/* Cloud Dropdown */
.cloud-dropdown{position:relative;display:block;width:100%}
.cloud-dropdown-content{display:none;position:absolute;left:0;bottom:100%;background:var(--card);min-width:220px;box-shadow:0 -8px 30px rgba(0,0,0,0.4);border-radius:10px;z-index:1000;overflow:hidden;margin-bottom:6px;border:1px solid var(--border)}
.cloud-dropdown-content.show{display:block}
.cloud-dropdown-item{padding:10px 14px;display:flex;align-items:center;gap:10px;cursor:pointer;font-size:0.8rem;font-weight:600;color:#fff;transition:all 0.2s;border-radius:0}
.cloud-dropdown-item:hover{filter:brightness(1.15)}
.cloud-dropdown-item.save-cloud{background:linear-gradient(135deg,#ec4899,#f43f5e)}
.cloud-dropdown-item.sync-cloud{background:linear-gradient(135deg,#10b981,#14b8a6)}
.cloud-dropdown-item.merge-cloud{background:linear-gradient(135deg,#3b82f6,#8b5cf6)}
.cloud-dropdown-item.browse-cloud{background:var(--surface);color:var(--text);font-weight:500}
.cloud-dropdown-item.browse-cloud:hover{background:var(--primary-glow)}
.cloud-dropdown-item.danger{background:none;color:var(--danger);font-weight:500}
.cloud-dropdown-item.danger:hover{background:rgba(239,68,68,0.1)}
.cloud-dropdown-divider{height:1px;background:var(--border);margin:2px 0}
.last-sync-info{padding:6px 14px;font-size:0.7rem;color:var(--text-muted)}

/* Google Auth Modal */
.google-auth-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;backdrop-filter:blur(4px)}
.google-auth-modal .modal-content{background:var(--card);border:1px solid var(--border);border-radius:14px;width:90%;max-width:560px;max-height:85vh;overflow-y:auto}
.google-auth-modal .modal-header{display:flex;justify-content:space-between;align-items:center;padding:1.25rem 1.5rem;border-bottom:1px solid var(--border)}
.google-auth-modal .modal-header h2{font-size:1rem;font-weight:600;color:var(--text)}
.google-auth-modal .close-btn{background:none;border:none;color:var(--text-dim);font-size:1.3rem;cursor:pointer}
.google-auth-modal .form-group label{font-weight:600;color:var(--text-dim);font-size:0.8rem}
.google-auth-modal .form-group textarea{background:var(--surface);border:2px solid var(--border);border-radius:6px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.75rem}
.google-auth-modal .form-group textarea:focus{outline:none;border-color:var(--primary)}
.google-auth-modal .btn-secondary{background:var(--surface);border:1px solid var(--border);color:var(--text-dim);display:inline-flex;align-items:center;gap:.4rem;padding:.5rem 1rem;border-radius:6px;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .15s}
.google-auth-modal .btn-secondary:hover{border-color:var(--primary);color:var(--primary)}

/* Browse Cloud Folder Modal */
.browse-cloud-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;backdrop-filter:blur(4px)}
.browse-cloud-modal .modal-content{background:var(--card);border:1px solid var(--border);border-radius:14px;width:90%;max-width:640px;max-height:85vh;overflow-y:auto}
.browse-cloud-modal .modal-header{display:flex;justify-content:space-between;align-items:center;padding:1.25rem 1.5rem;border-bottom:1px solid var(--border)}
.browse-cloud-modal .modal-header h2{font-size:1rem;font-weight:600;color:var(--text)}
.browse-cloud-modal .close-btn{background:none;border:none;color:var(--text-dim);font-size:1.3rem;cursor:pointer}
.browse-cloud-modal .browse-body{padding:1.25rem 1.5rem}
.browse-cloud-modal .browse-loading{text-align:center;padding:2rem;color:var(--text-dim);font-size:0.9rem}
.browse-cloud-modal .browse-empty{text-align:center;padding:2rem;color:var(--text-muted);font-size:0.85rem}
.browse-file-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px}
.browse-file-item{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;transition:all 0.2s}
.browse-file-item:hover{border-color:var(--primary);background:rgba(59,130,246,0.05)}
.browse-file-info{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
.browse-file-icon{font-size:1.3rem;flex-shrink:0}
.browse-file-details{min-width:0}
.browse-file-name{font-size:0.85rem;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.browse-file-meta{font-size:0.7rem;color:var(--text-muted);margin-top:2px}
.browse-file-actions{display:flex;gap:6px;flex-shrink:0}
.browse-file-actions button{padding:5px 10px;font-size:0.7rem;font-weight:600;border-radius:6px;border:none;cursor:pointer;font-family:inherit;transition:all 0.15s}
.btn-browse-open{background:var(--primary);color:#fff}
.btn-browse-open:hover{filter:brightness(1.15)}
.btn-browse-download{background:var(--surface);color:var(--text-dim);border:1px solid var(--border) !important}
.btn-browse-download:hover{border-color:var(--primary) !important;color:var(--primary)}
.btn-browse-delete{background:rgba(239,68,68,0.1);color:var(--danger)}
.btn-browse-delete:hover{background:rgba(239,68,68,0.2)}
.browse-folder-link{display:inline-flex;align-items:center;gap:6px;margin-top:1rem;padding:8px 14px;font-size:0.8rem;font-weight:600;color:var(--primary);background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:8px;text-decoration:none;transition:all 0.15s}
.browse-folder-link:hover{background:rgba(59,130,246,0.15);border-color:var(--primary)}
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-brand">
      <h1>C.E.S.T.I.S</h1>
      <p>Payroll System</p>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item active" onclick="showPage('dashboard')"><span class="icon">üìä</span><span class="nav-text">Dashboard</span></div>
      <div class="nav-item" onclick="showPage('employees')"><span class="icon">üë•</span><span class="nav-text">Employees</span></div>
      <div class="nav-item" onclick="showPage('payroll')"><span class="icon">üí∞</span><span class="nav-text">Run Payroll</span></div>
      <div class="nav-item" onclick="showPage('payslips')"><span class="icon">üßæ</span><span class="nav-text">Payslips</span></div>
      <div class="nav-item" onclick="showPage('salaryrecords')"><span class="icon">üìÜ</span><span class="nav-text">Salary Records</span></div>
      <div class="nav-item" onclick="showPage('deductions')"><span class="icon">üìã</span><span class="nav-text">Tax Summary</span></div>
      <div class="nav-item" onclick="showPage('settings')"><span class="icon">‚öôÔ∏è</span><span class="nav-text">Settings</span></div>
      <div style="border-top:1px solid var(--border);margin:0.5rem 0"></div>
      <a href="https://stevebarrettsrha-ops.github.io/CESTIS---Cashbook-Dashboard/" target="_blank" rel="noopener noreferrer" class="nav-item" style="text-decoration:none;color:inherit"><span class="icon">üìí</span><span class="nav-text">Cashbook Dashboard</span></a>
    </nav>
    <div class="sidebar-footer" style="padding:0.75rem 1rem">
      <div class="cloud-section-label nav-text">CLOUD SYNC</div>

      <!-- Cloud Sync: Not Connected -->
      <div id="cloudNotConnected">
        <div class="cloud-status-row">
          <span id="cloudStatusDot" class="cloud-status-dot disconnected"></span>
          <span class="cloud-status-label disconnected nav-text" id="cloudStatusText">Not connected</span>
        </div>
        <button class="cloud-sync-btn" onclick="connectToGoogleDrive()">
          <span>‚òÅÔ∏è</span>
          <span class="nav-text">Connect to Cloud</span>
        </button>
      </div>

      <!-- Cloud Sync: Connected -->
      <div id="cloudConnected" style="display:none;">
        <div class="cloud-status-row">
          <span id="cloudConnectedDot" class="cloud-status-dot connected"></span>
          <span class="cloud-status-label connected nav-text" id="cloudConnectedText">Connected</span>
        </div>
        <div class="cloud-dropdown">
          <button class="cloud-sync-btn" onclick="toggleCloudMenu()">
            <span id="cloudMenuIcon">‚òÅÔ∏è</span>
            <span class="nav-text">Cloud</span>
            <span class="btn-arrow nav-text">‚ñº</span>
          </button>
          <div class="cloud-dropdown-content" id="cloudDropdownMenu">
            <div class="cloud-dropdown-item save-cloud" onclick="saveToCloud()">
              <span>üíæ</span>
              <span>Save to Cloud</span>
            </div>
            <div class="cloud-dropdown-item sync-cloud" onclick="syncFromCloud()">
              <span>üîÑ</span>
              <span>Sync from Cloud</span>
            </div>
            <div class="cloud-dropdown-item merge-cloud" onclick="mergeFromCloud()">
              <span>üîÄ</span>
              <span>Merge from Cloud</span>
            </div>
            <div class="cloud-dropdown-divider"></div>
            <div class="cloud-dropdown-item browse-cloud" onclick="browseCloudFolder()">
              <span>üìÇ</span>
              <span>Browse All Backups</span>
            </div>
            <div class="cloud-dropdown-divider"></div>
            <div class="last-sync-info" id="lastSyncInfo">
              Last sync: Never
            </div>
            <div class="last-sync-info" id="lastSavedByInfo">
              Last saved by: --
            </div>
            <div class="cloud-dropdown-divider"></div>
            <div class="cloud-dropdown-item danger" onclick="disconnectFromGoogleDrive()">
              <span>üîå</span>
              <span>Disconnect</span>
            </div>
          </div>
        </div>
        <div class="cloud-sync-meta nav-text" id="sidebarSyncInfo">Last sync: Never</div>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">

    <!-- ===== DASHBOARD ===== -->
    <div id="page-dashboard" class="page active">
      <div class="page-header">
        <div><h2>Payroll Dashboard</h2><div class="subtitle">C.E.S.T.I.S ‚Äî Overview</div></div>
        <div class="btn-group">
          <button class="btn btn-ghost" onclick="exportAllData()">üì• Export Data</button>
          <button class="btn btn-primary" onclick="showPage('payroll')">‚ñ∂ Run Payroll</button>
        </div>
      </div>
      <div class="stats-row" id="dashStats"></div>
      <div class="panel">
        <div class="panel-head"><h3>Recent Payroll History</h3></div>
        <div class="panel-body"><div class="table-wrap" id="dashHistory"></div></div>
      </div>
      <div class="panel">
        <div class="panel-head"><h3>Employee Summary</h3></div>
        <div class="panel-body"><div class="table-wrap" id="dashEmployees"></div></div>
      </div>
    </div>

    <!-- ===== EMPLOYEES ===== -->
    <div id="page-employees" class="page">
      <div class="page-header">
        <div><h2>Employee Management</h2><div class="subtitle">Full-Time & Part-Time Staff Records</div></div>
        <button class="btn btn-primary" onclick="openEmployeeModal()">+ Add Employee</button>
      </div>
      <div class="panel">
        <div class="panel-head"><h3>All Employees</h3></div>
        <div class="panel-body"><div class="table-wrap" id="employeeTable"></div></div>
      </div>
    </div>

    <!-- ===== PAYROLL ===== -->
    <div id="page-payroll" class="page">
      <div class="page-header">
        <div><h2>Process Payroll</h2><div class="subtitle">Calculate deductions and generate payslips</div></div>
      </div>

      <!-- Quarter Navigation -->
      <div class="quarter-nav" id="quarterNav"></div>

      <!-- Month Cards -->
      <div class="month-cards" id="monthCards"></div>

      <!-- Quarter Summary Stats -->
      <div class="quarter-stats" id="quarterStats"></div>

      <!-- Payroll Input Form -->
      <div class="panel">
        <div class="panel-head"><h3 id="payrollFormTitle">Payroll Configuration</h3></div>
        <div class="panel-body">
          <div class="form-grid">
            <div class="form-group">
              <label>Pay Cycle Date</label>
              <input type="date" id="payCycleDate">
            </div>
            <div class="form-group">
              <label>Income Tax Threshold (Annual)</label>
              <input type="number" id="taxThreshold" value="1799376" step="1">
            </div>
          </div>
          <div style="margin-top:1.25rem">
            <h4 style="font-size:.85rem;margin-bottom:.75rem;color:var(--text-dim)">Employee Gross Earnings for this Cycle</h4>
            <div class="table-wrap" id="payrollInput"></div>
          </div>
          <div style="margin-top:1.25rem;display:flex;gap:.75rem">
            <button class="btn btn-success" onclick="calculatePayroll()">üßÆ Calculate Payroll</button>
            <button class="btn btn-ghost" onclick="fillDefaultSalaries()">üìã Fill Default Salaries</button>
          </div>
        </div>
      </div>
      <div class="panel" id="payrollResultsPanel" style="display:none">
        <div class="panel-head"><h3>Payroll Results</h3><button class="btn btn-primary btn-sm" onclick="savePayrollRun()">üíæ Save & Lock Payroll</button></div>
        <div class="panel-body"><div class="table-wrap" id="payrollResults"></div></div>
      </div>

      <!-- Quarter Payroll History -->
      <div class="panel" id="quarterHistoryPanel">
        <div class="panel-head"><h3 id="quarterHistoryTitle">Quarter Payroll History</h3></div>
        <div class="panel-body"><div class="table-wrap" id="quarterHistory"></div></div>
      </div>
    </div>

    <!-- ===== PAYSLIPS ===== -->
    <div id="page-payslips" class="page">
      <div class="page-header">
        <div><h2>Payslip Generator</h2><div class="subtitle">View, preview and print individual payslips</div></div>
      </div>
      <div class="panel">
        <div class="panel-head"><h3>Select Employee & Pay Cycle</h3></div>
        <div class="panel-body">
          <div class="form-grid">
            <div class="form-group">
              <label>Employee</label>
              <select id="payslipEmployee"></select>
            </div>
            <div class="form-group">
              <label>Pay Cycle</label>
              <select id="payslipCycle"></select>
            </div>
            <div class="form-group" style="justify-content:flex-end">
              <button class="btn btn-primary" onclick="generatePayslipPreview()">üëÅ Preview Payslip</button>
            </div>
          </div>
        </div>
      </div>
      <div id="payslipPreviewArea"></div>
      <div class="payslip-container" id="payslipPrintArea"></div>
    </div>

    <!-- ===== TAX SUMMARY ===== -->
    <div id="page-deductions" class="page">
      <div class="page-header">
        <div><h2>Tax Deductions Summary</h2><div class="subtitle">Statutory contributions by pay cycle</div></div>
      </div>
      <div class="panel">
        <div class="panel-head"><h3>Monthly Contribution Totals</h3></div>
        <div class="panel-body"><div class="table-wrap" id="taxSummaryTable"></div></div>
      </div>
      <div class="panel">
        <div class="panel-head"><h3>Per-Employee Breakdown</h3></div>
        <div class="panel-body">
          <div class="form-group" style="max-width:300px;margin-bottom:1rem">
            <label>Select Pay Cycle</label>
            <select id="taxCycleSelect" onchange="renderTaxBreakdown()"></select>
          </div>
          <div class="table-wrap" id="taxBreakdownTable"></div>
        </div>
      </div>
    </div>

    <!-- ===== SALARY RECORDS ===== -->
    <div id="page-salaryrecords" class="page">
      <div class="page-header">
        <div><h2>Salary Records</h2><div class="subtitle">Monthly &amp; Quarterly Salary Records for All Employees</div></div>
        <div class="btn-group">
          <button class="btn btn-ghost" onclick="exportSalaryRecordsCSV()">üì• Export CSV</button>
        </div>
      </div>
      <div class="panel">
        <div class="panel-head">
          <h3>Select Fiscal Year</h3>
          <div class="form-group" style="margin:0;min-width:160px">
            <select id="salaryRecordYear" onchange="renderSalaryRecords()"></select>
          </div>
        </div>
        <div class="panel-body">
          <div class="table-wrap" id="salaryRecordsTable" style="font-size:.8rem"></div>
        </div>
      </div>
      <div class="stats-row" id="salaryRecordStats"></div>
      <div class="panel">
        <div class="panel-head"><h3>Quarterly Summary</h3></div>
        <div class="panel-body"><div class="table-wrap" id="quarterlyTable"></div></div>
      </div>
      <div class="panel">
        <div class="panel-head"><h3>Per-Employee Quarterly Breakdown</h3></div>
        <div class="panel-body"><div class="table-wrap" id="empQuarterlyTable"></div></div>
      </div>
    </div>

    <!-- ===== SETTINGS ===== -->
    <div id="page-settings" class="page">
      <div class="page-header">
        <div><h2>Settings</h2><div class="subtitle">Tax rates and system configuration</div></div>
      </div>
      <div class="panel">
        <div class="panel-head">
          <h3>Jamaican Statutory Deduction Rates</h3>
          <button class="btn btn-primary" onclick="fetchCurrentRates()" id="fetchRatesBtn">üåê Fetch Current Rates</button>
        </div>
        <div id="ratesFetchStatus" style="display:none;padding:.75rem 1.25rem;font-size:.85rem;border-bottom:1px solid var(--border);"></div>
        <div class="panel-body">
          <div class="form-grid">
            <div class="form-group"><label>NIS Employee Rate (%)</label><input type="number" id="rateNISEmp" value="3" step="0.1"></div>
            <div class="form-group"><label>NIS Employer Rate (%)</label><input type="number" id="rateNISEr" value="3" step="0.1"></div>
            <div class="form-group"><label>NIS Monthly Wage Ceiling ($)</label><input type="number" id="nisCeilingMonthly" value="416667" step="1"></div>
            <div class="form-group"><label>Education Tax Employee (%)</label><input type="number" id="rateEdTaxEmp" value="2.25" step="0.01"></div>
            <div class="form-group"><label>Education Tax Employer (%)</label><input type="number" id="rateEdTaxEr" value="3.5" step="0.01"></div>
            <div class="form-group"><label>NHT Employee (%)</label><input type="number" id="rateNHTEmp" value="2" step="0.1"></div>
            <div class="form-group"><label>NHT Employer (%)</label><input type="number" id="rateNHTEr" value="3" step="0.1"></div>
            <div class="form-group"><label>HEART/NSTA Employer (%)</label><input type="number" id="rateHeartEr" value="3" step="0.1"></div>
            <div class="form-group"><label>Income Tax Standard Rate (%)</label><input type="number" id="rateIncomeTax" value="25" step="0.1"></div>
            <div class="form-group"><label>Income Tax Higher Rate (%)</label><input type="number" id="rateIncomeTaxHigher" value="30" step="0.1"></div>
            <div class="form-group"><label>Higher Rate Annual Threshold ($)</label><input type="number" id="higherBracketAnnual" value="6000000" step="1"></div>
            <div class="form-group"><label>Annual Income Tax Threshold ($)</label><input type="number" id="annualThreshold" value="1799376" step="1"></div>
          </div>
          <div style="margin-top:1.25rem;display:flex;gap:.75rem">
            <button class="btn btn-success" onclick="saveSettings()">üíæ Save Settings</button>
            <button class="btn btn-danger" onclick="if(confirm('Reset ALL data?')){localStorage.clear();location.reload()}">üóë Reset All Data</button>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-head"><h3>Data Management</h3></div>
        <div class="panel-body">
          <div class="btn-group">
            <button class="btn btn-primary" onclick="loadPresetData()">üì¶ Load Preset Employee Data</button>
            <button class="btn btn-ghost" onclick="exportAllData()">üì• Export JSON Backup</button>
            <button class="btn btn-ghost" onclick="document.getElementById('importFile').click()">üì§ Import JSON Backup</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- Employee Modal -->
<div class="modal-overlay" id="employeeModal">
  <div class="modal">
    <div class="modal-header"><h3 id="empModalTitle">Add Employee</h3><button class="modal-close" onclick="closeEmployeeModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label>Employee Name</label><input type="text" id="empName"></div>
        <div class="form-group"><label>Designation</label><input type="text" id="empDesignation"></div>
        <div class="form-group"><label>Type</label><select id="empType"><option value="FT">Full-Time</option><option value="PT">Part-Time</option></select></div>
        <div class="form-group"><label>Mobile No.</label><input type="text" id="empMobile"></div>
        <div class="form-group"><label>Date of Birth</label><input type="date" id="empDOB"></div>
        <div class="form-group"><label>TRN</label><input type="text" id="empTRN"></div>
        <div class="form-group"><label>NIS Number</label><input type="text" id="empNIS"></div>
        <div class="form-group"><label>Start Date</label><input type="date" id="empStart"></div>
        <div class="form-group"><label>Monthly Gross Salary ($)</label><input type="number" id="empSalary" step="0.01"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeEmployeeModal()">Cancel</button>
      <button class="btn btn-success" onclick="saveEmployee()">Save Employee</button>
    </div>
  </div>
</div>

<script>
// ==================== DATA STORE ====================
const STORAGE_KEY = 'cestisPayroll';
let DATA = loadStore();

function defaultData(){
  return {
    settings:{
      nisEmp:3,nisEr:3,edTaxEmp:2.25,edTaxEr:3.5,nhtEmp:2,nhtEr:3,
      incomeTax:25,incomeTaxHigher:30,higherBracketAnnual:6000000,
      annualThreshold:1799376,
      nisCeilingMonthly:416667,
      heartEr:3
    },
    employees:[],
    payrollRuns:[]
  };
}

function loadStore(){
  try{const d=localStorage.getItem(STORAGE_KEY);return d?JSON.parse(d):defaultData();}catch(e){return defaultData();}
}
function saveStore(){localStorage.setItem(STORAGE_KEY,JSON.stringify(DATA));}

// ==================== FORMATTING ====================
function fmt(n){return '$'+parseFloat(n||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmtDate(d){if(!d)return'‚Äî';const dt=new Date(d);return dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});}

// ==================== NAVIGATION ====================
function showPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  const navItems=document.querySelectorAll('.nav-item');
  const pages=['dashboard','employees','payroll','payslips','salaryrecords','deductions','settings'];
  const idx=pages.indexOf(name);
  if(idx>=0)navItems[idx].classList.add('active');
  if(name==='dashboard')renderDashboard();
  if(name==='employees')renderEmployees();
  if(name==='payroll')renderPayrollInput();
  if(name==='payslips')populatePayslipSelects();
  if(name==='salaryrecords')renderSalaryRecords();
  if(name==='deductions')renderTaxSummary();
  if(name==='settings')loadSettings();
}

// ==================== DASHBOARD ====================
function renderDashboard(){
  const emps=DATA.employees;
  const runs=DATA.payrollRuns;
  const ftCount=emps.filter(e=>e.type==='FT').length;
  const ptCount=emps.filter(e=>e.type==='PT').length;
  const lastRun=runs.length>0?runs[runs.length-1]:null;
  const totalGross=lastRun?lastRun.results.reduce((s,r)=>s+r.gross,0):0;
  const totalNet=lastRun?lastRun.results.reduce((s,r)=>s+r.netPay,0):0;

  document.getElementById('dashStats').innerHTML=`
    <div class="stat-card blue"><div class="label">Total Employees</div><div class="value">${emps.length}</div><div class="sub">${ftCount} Full-Time ¬∑ ${ptCount} Part-Time</div></div>
    <div class="stat-card gold"><div class="label">Last Gross Payroll</div><div class="value mono">${fmt(totalGross)}</div><div class="sub">${lastRun?fmtDate(lastRun.date):'No runs yet'}</div></div>
    <div class="stat-card green"><div class="label">Last Net Payroll</div><div class="value mono">${fmt(totalNet)}</div><div class="sub">After all deductions</div></div>
    <div class="stat-card red"><div class="label">Payroll Runs</div><div class="value">${runs.length}</div><div class="sub">Total processed cycles</div></div>
  `;

  let histHtml='<table><thead><tr><th>Pay Date</th><th class="text-right">Gross</th><th class="text-right">Net</th><th class="text-right">Emp Deductions</th><th class="text-right">Er Contributions</th><th>Employees</th></tr></thead><tbody>';
  if(runs.length===0)histHtml+='<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:2rem">No payroll runs yet</td></tr>';
  else runs.slice().reverse().forEach(r=>{
    const g=r.results.reduce((s,x)=>s+x.gross,0);
    const n=r.results.reduce((s,x)=>s+x.netPay,0);
    const ed=r.results.reduce((s,x)=>s+x.totalEmpDeductions,0);
    const er=r.results.reduce((s,x)=>s+x.totalErContributions,0);
    histHtml+=`<tr><td>${fmtDate(r.date)}</td><td class="mono text-right">${fmt(g)}</td><td class="mono text-right">${fmt(n)}</td><td class="mono text-right">${fmt(ed)}</td><td class="mono text-right">${fmt(er)}</td><td>${r.results.length}</td></tr>`;
  });
  histHtml+='</tbody></table>';
  document.getElementById('dashHistory').innerHTML=histHtml;

  let empHtml='<table><thead><tr><th>#</th><th>Name</th><th>Designation</th><th>Type</th><th>TRN</th><th>NIS</th></tr></thead><tbody>';
  emps.forEach((e,i)=>{
    empHtml+=`<tr><td>${i+1}</td><td>${e.name}</td><td>${e.designation}</td><td><span class="tag ${e.type==='FT'?'tag-ft':'tag-pt'}">${e.type}</span></td><td class="mono">${e.trn||'‚Äî'}</td><td class="mono">${e.nis||'‚Äî'}</td></tr>`;
  });
  if(emps.length===0)empHtml+='<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:2rem">No employees. Add some from Settings ‚Üí Load Preset Data</td></tr>';
  empHtml+='</tbody></table>';
  document.getElementById('dashEmployees').innerHTML=empHtml;
}

// ==================== EMPLOYEES ====================
let editingEmpIdx=-1;

function renderEmployees(){
  let html='<table><thead><tr><th>#</th><th>Name</th><th>Designation</th><th>Type</th><th>Mobile</th><th>DOB</th><th>TRN</th><th>NIS</th><th>Salary</th><th>Start</th><th>Actions</th></tr></thead><tbody>';
  DATA.employees.forEach((e,i)=>{
    html+=`<tr>
      <td>${i+1}</td><td>${e.name}</td><td>${e.designation||'‚Äî'}</td>
      <td><span class="tag ${e.type==='FT'?'tag-ft':'tag-pt'}">${e.type}</span></td>
      <td class="mono">${e.mobile||'‚Äî'}</td><td>${fmtDate(e.dob)}</td>
      <td class="mono">${e.trn||'‚Äî'}</td><td class="mono">${e.nis||'‚Äî'}</td>
      <td class="mono text-right">${fmt(e.salary)}</td><td>${fmtDate(e.startDate)}</td>
      <td><div class="btn-group"><button class="btn btn-ghost btn-sm" onclick="editEmployee(${i})">‚úèÔ∏è</button><button class="btn btn-danger btn-sm" onclick="deleteEmployee(${i})">üóë</button></div></td>
    </tr>`;
  });
  if(DATA.employees.length===0)html+='<tr><td colspan="11" style="text-align:center;color:var(--text-muted);padding:2rem">No employees added yet</td></tr>';
  html+='</tbody></table>';
  document.getElementById('employeeTable').innerHTML=html;
}

function openEmployeeModal(){
  editingEmpIdx=-1;
  document.getElementById('empModalTitle').textContent='Add Employee';
  ['empName','empDesignation','empMobile','empDOB','empTRN','empNIS','empStart','empSalary'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('empType').value='FT';
  document.getElementById('employeeModal').classList.add('show');
}

function closeEmployeeModal(){document.getElementById('employeeModal').classList.remove('show');}

function editEmployee(i){
  editingEmpIdx=i;const e=DATA.employees[i];
  document.getElementById('empModalTitle').textContent='Edit Employee';
  document.getElementById('empName').value=e.name;
  document.getElementById('empDesignation').value=e.designation||'';
  document.getElementById('empType').value=e.type;
  document.getElementById('empMobile').value=e.mobile||'';
  document.getElementById('empDOB').value=e.dob||'';
  document.getElementById('empTRN').value=e.trn||'';
  document.getElementById('empNIS').value=e.nis||'';
  document.getElementById('empStart').value=e.startDate||'';
  document.getElementById('empSalary').value=e.salary||'';
  document.getElementById('employeeModal').classList.add('show');
}

function saveEmployee(){
  const emp={
    name:document.getElementById('empName').value.trim(),
    designation:document.getElementById('empDesignation').value.trim(),
    type:document.getElementById('empType').value,
    mobile:document.getElementById('empMobile').value.trim(),
    dob:document.getElementById('empDOB').value,
    trn:document.getElementById('empTRN').value.trim(),
    nis:document.getElementById('empNIS').value.trim(),
    startDate:document.getElementById('empStart').value,
    salary:parseFloat(document.getElementById('empSalary').value)||0
  };
  if(!emp.name){alert('Employee name is required');return;}
  if(editingEmpIdx>=0)DATA.employees[editingEmpIdx]=emp;
  else DATA.employees.push(emp);
  saveStore();closeEmployeeModal();renderEmployees();
}

function deleteEmployee(i){
  if(!confirm('Delete '+DATA.employees[i].name+'?'))return;
  DATA.employees.splice(i,1);saveStore();renderEmployees();
}

// ==================== PAYROLL PROCESSING ====================
// Jamaican Fiscal Year: April ‚Äì March
// Q1=Apr-Jun, Q2=Jul-Sep, Q3=Oct-Dec, Q4=Jan-Mar
const QUARTER_MONTHS=[
  {q:1,label:'Q1',sub:'Apr\u2013Jun',months:[3,4,5],names:['April','May','June']},
  {q:2,label:'Q2',sub:'Jul\u2013Sep',months:[6,7,8],names:['July','August','September']},
  {q:3,label:'Q3',sub:'Oct\u2013Dec',months:[9,10,11],names:['October','November','December']},
  {q:4,label:'Q4',sub:'Jan\u2013Mar',months:[0,1,2],names:['January','February','March']}
];

// Fiscal year is identified by its start year (e.g. FY 2025/2026 ‚Üí fyStartYear=2025)
// Determine current FY: if current month >= April (3), FY starts this year; else last year
let fyStartYear=(function(){const now=new Date();return now.getMonth()>=3?now.getFullYear():now.getFullYear()-1;})();
let payrollQuarter=(function(){
  const m=new Date().getMonth();
  if(m>=3&&m<=5)return 0; // Q1
  if(m>=6&&m<=8)return 1; // Q2
  if(m>=9&&m<=11)return 2; // Q3
  return 3; // Q4 (Jan-Mar)
})();

function getFYLabel(startYear){return 'FY '+startYear+'/'+(startYear+1);}

// Get the calendar year for a given quarter within a fiscal year
function getCalendarYear(fyStart,qi){
  // Q1(Apr-Jun),Q2(Jul-Sep),Q3(Oct-Dec) are in fyStart year
  // Q4(Jan-Mar) is in fyStart+1 year
  return qi<=2?fyStart:fyStart+1;
}

function getQuarterRunsByMonth(fyStart,qDef,qi){
  const calYear=getCalendarYear(fyStart,qi);
  const result=[null,null,null];
  DATA.payrollRuns.forEach(run=>{
    const d=new Date(run.date);
    if(d.getFullYear()!==calYear)return;
    const m=d.getMonth();
    const idx=qDef.months.indexOf(m);
    if(idx>=0)result[idx]=run;
  });
  return result;
}

function changeFY(delta){
  fyStartYear+=delta;
  renderPayrollInput();
}

function changeQuarter(delta){
  payrollQuarter+=delta;
  if(payrollQuarter>3){payrollQuarter=0;fyStartYear++;}
  if(payrollQuarter<0){payrollQuarter=3;fyStartYear--;}
  renderPayrollInput();
}

function renderPayrollInput(){
  const qDef=QUARTER_MONTHS[payrollQuarter];
  const calYear=getCalendarYear(fyStartYear,payrollQuarter);
  const monthRuns=getQuarterRunsByMonth(fyStartYear,qDef,payrollQuarter);

  // Build quarter navigation ‚Äî matches screenshot exactly:
  // ‚óÑ  FY 2025/2026  ‚ñ∫   [Q1 ¬∑ Apr-Jun] [Q2 ¬∑ Jul-Sep] [Q3 ¬∑ Oct-Dec] [Q4 ¬∑ Jan-Mar]   ‚óÑ Prev Qtr | Next Qtr ‚ñ∫
  let navHtml='';

  // FY selector with arrows
  navHtml+=`<div class="fy-selector">`;
  navHtml+=`<button class="fy-arrow" onclick="changeFY(-1)" title="Previous Fiscal Year">\u25C4</button>`;
  navHtml+=`<span class="fy-label">${getFYLabel(fyStartYear)}</span>`;
  navHtml+=`<button class="fy-arrow" onclick="changeFY(1)" title="Next Fiscal Year">\u25BA</button>`;
  navHtml+=`</div>`;

  // Quarter tabs
  navHtml+=`<div class="quarter-tabs">`;
  QUARTER_MONTHS.forEach((q,qi)=>{
    navHtml+=`<button class="quarter-tab${qi===payrollQuarter?' active':''}" onclick="payrollQuarter=${qi};renderPayrollInput()">${q.label}<span class="q-sub">\u00B7 ${q.sub}</span></button>`;
  });
  navHtml+=`</div>`;

  // Prev/Next quarter buttons
  navHtml+=`<div class="qtr-nav-btns">`;
  navHtml+=`<button class="qtr-nav-btn" onclick="changeQuarter(-1)">\u25C4 Prev Qtr</button>`;
  navHtml+=`<button class="qtr-nav-btn" onclick="changeQuarter(1)">Next Qtr \u25BA</button>`;
  navHtml+=`</div>`;

  document.getElementById('quarterNav').innerHTML=navHtml;

  // Build month cards
  let monthHtml='';
  qDef.months.forEach((m,mi)=>{
    const run=monthRuns[mi];
    const isCompleted=run!==null;
    let statusText=isCompleted?'Payroll recorded':'Not yet recorded';
    if(isCompleted){
      const gross=run.results.reduce((s,r)=>s+r.gross,0);
      statusText='Recorded \u2014 '+fmt(gross);
    }
    monthHtml+=`<div class="month-card${isCompleted?' completed':''}" onclick="selectPayrollMonth(${calYear},${m})" title="${isCompleted?'View recorded payroll':'Run payroll for '+qDef.names[mi]}">
      <div class="month-name">${qDef.names[mi]}</div>
      <div class="month-status">${statusText}</div>
    </div>`;
  });
  document.getElementById('monthCards').innerHTML=monthHtml;

  // Build quarter summary stats
  let qGross=0,qNet=0,qDeductions=0,qErContr=0;
  monthRuns.forEach(run=>{
    if(!run)return;
    run.results.forEach(r=>{
      qGross+=r.gross;qNet+=r.netPay;qDeductions+=r.totalEmpDeductions;qErContr+=r.totalErContributions;
    });
  });
  const filledCount=monthRuns.filter(r=>r!==null).length;
  document.getElementById('quarterStats').innerHTML=`
    <div class="quarter-stat"><div class="qs-label">${qDef.label} Gross</div><div class="qs-value" style="color:var(--primary)">${fmt(qGross)}</div></div>
    <div class="quarter-stat"><div class="qs-label">${qDef.label} Net Pay</div><div class="qs-value" style="color:var(--green)">${fmt(qNet)}</div></div>
    <div class="quarter-stat"><div class="qs-label">${qDef.label} Deductions</div><div class="qs-value" style="color:var(--red)">${fmt(qDeductions)}</div></div>
    <div class="quarter-stat"><div class="qs-label">Months Recorded</div><div class="qs-value">${filledCount} / 3</div></div>
  `;

  // Update form title ‚Äî find the first unrecorded month in the quarter
  let defaultMonth=qDef.months[0];
  for(let mi=0;mi<3;mi++){
    if(!monthRuns[mi]){defaultMonth=qDef.months[mi];break;}
  }
  const defaultMonthName=MONTH_NAMES[defaultMonth];
  document.getElementById('payrollFormTitle').textContent='Run Payroll \u2014 '+defaultMonthName+' '+calYear;

  // Set date to end of the selected month
  const lastDay=new Date(calYear,defaultMonth+1,0);
  document.getElementById('payCycleDate').value=lastDay.toISOString().split('T')[0];
  document.getElementById('taxThreshold').value=DATA.settings.annualThreshold;

  // Sync the form title when pay cycle date changes
  document.getElementById('payCycleDate').onchange=function(){
    const d=new Date(this.value);
    if(!isNaN(d)){
      document.getElementById('payrollFormTitle').textContent='Run Payroll \u2014 '+MONTH_NAMES[d.getMonth()]+' '+d.getFullYear();
    }
  };

  // Employee gross input table
  let html='<table><thead><tr><th>#</th><th>Employee</th><th>Type</th><th>Default Salary</th><th>Gross Earnings This Cycle ($)</th></tr></thead><tbody>';
  DATA.employees.forEach((e,i)=>{
    html+=`<tr><td>${i+1}</td><td>${e.name}</td><td><span class="tag ${e.type==='FT'?'tag-ft':'tag-pt'}">${e.type}</span></td><td class="mono text-right">${fmt(e.salary)}</td><td><input type="number" step="0.01" id="grossInput_${i}" value="0" style="width:160px;background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:.4rem .6rem;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.82rem"></td></tr>`;
  });
  if(DATA.employees.length===0)html+='<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:2rem">Add employees first</td></tr>';
  html+='</tbody></table>';
  document.getElementById('payrollInput').innerHTML=html;
  document.getElementById('payrollResultsPanel').style.display='none';

  // Render quarter history
  renderQuarterHistory();
}

function selectPayrollMonth(year,month){
  const lastDay=new Date(year,month+1,0);
  document.getElementById('payCycleDate').value=lastDay.toISOString().split('T')[0];
  document.getElementById('payrollFormTitle').textContent='Run Payroll \u2014 '+MONTH_NAMES[month]+' '+year;

  // Check if this month already has payroll
  const existingRun=DATA.payrollRuns.find(r=>{
    const d=new Date(r.date);
    return d.getFullYear()===year&&d.getMonth()===month;
  });
  if(existingRun){
    let html='<table><thead><tr><th>Employee</th><th class="text-right">Gross</th><th class="text-right">NIS</th><th class="text-right">Ed. Tax</th><th class="text-right">Income Tax</th><th class="text-right">NHT</th><th class="text-right">HEART</th><th class="text-right">Total Ded.</th><th class="text-right">Net Pay</th><th>Payslip</th></tr></thead><tbody>';
    let totals={gross:0,nis:0,ed:0,it:0,nht:0,heart:0,ded:0,net:0};
    const runIdx=DATA.payrollRuns.indexOf(existingRun);
    existingRun.results.forEach(r=>{
      const empIdx=DATA.employees.findIndex(e=>e.name===r.empName);
      html+=`<tr><td>${r.empName}</td><td class="mono text-right">${fmt(r.gross)}</td><td class="mono text-right">${fmt(r.nisEmp)}</td><td class="mono text-right">${fmt(r.edTaxEmp)}</td><td class="mono text-right">${fmt(r.incomeTax)}</td><td class="mono text-right">${fmt(r.nhtEmp)}</td><td class="mono text-right">${fmt(r.heartEr)}</td><td class="mono text-right">${fmt(r.totalEmpDeductions)}</td><td class="mono text-right" style="color:var(--green);font-weight:600">${fmt(r.netPay)}</td><td>${empIdx>=0?'<span class="payslip-link" onclick="viewPayslipFromPayroll('+empIdx+','+runIdx+')">View Payslip</span>':''}</td></tr>`;
      totals.gross+=r.gross;totals.nis+=r.nisEmp;totals.ed+=r.edTaxEmp;totals.it+=r.incomeTax;totals.nht+=r.nhtEmp;totals.heart+=r.heartEr;totals.ded+=r.totalEmpDeductions;totals.net+=r.netPay;
    });
    html+=`<tr style="font-weight:700;border-top:2px solid var(--border)"><td>TOTAL</td><td class="mono text-right">${fmt(totals.gross)}</td><td class="mono text-right">${fmt(totals.nis)}</td><td class="mono text-right">${fmt(totals.ed)}</td><td class="mono text-right">${fmt(totals.it)}</td><td class="mono text-right">${fmt(totals.nht)}</td><td class="mono text-right">${fmt(totals.heart)}</td><td class="mono text-right">${fmt(totals.ded)}</td><td class="mono text-right" style="color:var(--green)">${fmt(totals.net)}</td><td></td></tr>`;
    html+='</tbody></table>';
    document.getElementById('payrollResults').innerHTML=html;
    document.getElementById('payrollResultsPanel').style.display='block';
    document.getElementById('payrollResultsPanel').querySelector('.panel-head h3').textContent='Recorded Payroll \u2014 '+MONTH_NAMES[month]+' '+year;
    const saveBtn=document.getElementById('payrollResultsPanel').querySelector('.btn-primary');
    if(saveBtn)saveBtn.style.display='none';
  }else{
    document.getElementById('payrollResultsPanel').style.display='none';
  }

  // Highlight active month card
  const cards=document.querySelectorAll('.month-card');
  const qDef=QUARTER_MONTHS[payrollQuarter];
  cards.forEach((card,i)=>{
    card.classList.remove('active');
    if(qDef.months[i]===month)card.classList.add('active');
  });
}

function renderQuarterHistory(){
  const qDef=QUARTER_MONTHS[payrollQuarter];
  const calYear=getCalendarYear(fyStartYear,payrollQuarter);
  const monthRuns=getQuarterRunsByMonth(fyStartYear,qDef,payrollQuarter);
  document.getElementById('quarterHistoryTitle').textContent=qDef.label+' Payroll History \u2014 '+getFYLabel(fyStartYear);

  let hasAny=monthRuns.some(r=>r!==null);
  if(!hasAny){
    document.getElementById('quarterHistory').innerHTML='<div style="text-align:center;color:var(--text-muted);padding:2rem">No payroll runs recorded for '+qDef.label+' '+getFYLabel(fyStartYear)+'</div>';
    return;
  }

  let html='<table><thead><tr><th>Month</th><th>Pay Date</th><th class="text-right">Gross</th><th class="text-right">Net Pay</th><th class="text-right">Emp Deductions</th><th class="text-right">Er Contributions</th><th>Employees</th><th>Actions</th></tr></thead><tbody>';
  qDef.months.forEach((m,mi)=>{
    const run=monthRuns[mi];
    if(!run){
      html+=`<tr><td>${qDef.names[mi]}</td><td colspan="6" style="color:var(--text-muted)">Not yet recorded</td><td><button class="btn btn-primary btn-sm" onclick="selectPayrollMonth(${calYear},${m})">Run Payroll</button></td></tr>`;
      return;
    }
    const g=run.results.reduce((s,x)=>s+x.gross,0);
    const n=run.results.reduce((s,x)=>s+x.netPay,0);
    const ed=run.results.reduce((s,x)=>s+x.totalEmpDeductions,0);
    const er=run.results.reduce((s,x)=>s+x.totalErContributions,0);
    html+=`<tr>
      <td style="font-weight:600">${qDef.names[mi]}</td>
      <td>${fmtDate(run.date)}</td>
      <td class="mono text-right">${fmt(g)}</td>
      <td class="mono text-right" style="color:var(--green)">${fmt(n)}</td>
      <td class="mono text-right">${fmt(ed)}</td>
      <td class="mono text-right">${fmt(er)}</td>
      <td>${run.results.length}</td>
      <td><span class="payslip-link" onclick="selectPayrollMonth(${calYear},${m})">View Details</span></td>
    </tr>`;
  });
  html+='</tbody></table>';
  document.getElementById('quarterHistory').innerHTML=html;
}

function viewPayslipFromPayroll(empIdx,runIdx){
  // Navigate to payslips page with selections pre-filled
  showPage('payslips');
  setTimeout(()=>{
    document.getElementById('payslipEmployee').value=empIdx;
    document.getElementById('payslipCycle').value=runIdx;
    generatePayslipPreview();
  },50);
}

function fillDefaultSalaries(){
  DATA.employees.forEach((e,i)=>{
    const inp=document.getElementById('grossInput_'+i);
    if(inp)inp.value=e.salary||0;
  });
}

function calculatePayroll(){
  const s=DATA.settings;
  const monthlyThreshold=s.annualThreshold/12;
  const monthlyHigherBracket=(s.higherBracketAnnual||6000000)/12;
  const nisCeiling=s.nisCeilingMonthly||416667;
  const results=[];

  DATA.employees.forEach((e,i)=>{
    const gross=parseFloat(document.getElementById('grossInput_'+i)?.value)||0;

    // NIS ‚Äî capped at ceiling
    const nisableGross=Math.min(gross,nisCeiling);
    const nisEmp=nisableGross*(s.nisEmp/100);
    const nisEr=nisableGross*(s.nisEr/100);

    // NHT ‚Äî no cap
    const nhtEmp=gross*(s.nhtEmp/100);
    const nhtEr=gross*(s.nhtEr/100);

    // Statutory income for Education Tax = Gross - NIS employee
    const statutoryIncome=gross-nisEmp;
    const edTaxEmp=statutoryIncome*(s.edTaxEmp/100);
    const edTaxEr=statutoryIncome*(s.edTaxEr/100);

    // HEART/NSTA ‚Äî employer only
    const heartEr=gross*((s.heartEr||3)/100);

    // Income Tax ‚Äî progressive: 25% up to $6M bracket, 30% above
    // Chargeable income = Gross - NIS - NHT (approved deductions)
    const chargeableIncome=gross-nisEmp-nhtEmp;
    let incomeTax=0;
    if(chargeableIncome>monthlyThreshold){
      const taxable=chargeableIncome-monthlyThreshold;
      const standardBand=monthlyHigherBracket-monthlyThreshold;
      if(taxable<=standardBand){
        incomeTax=taxable*(s.incomeTax/100);
      }else{
        incomeTax=standardBand*(s.incomeTax/100)+(taxable-standardBand)*((s.incomeTaxHigher||30)/100);
      }
    }

    const totalEmpDeductions=nisEmp+edTaxEmp+nhtEmp+incomeTax;
    const totalErContributions=nisEr+edTaxEr+nhtEr+heartEr;
    const netPay=gross-totalEmpDeductions;

    results.push({
      empName:e.name,empType:e.type,designation:e.designation,trn:e.trn,nis:e.nis,
      gross,nisEmp,nisEr,edTaxEmp,edTaxEr,nhtEmp,nhtEr,heartEr,incomeTax,
      totalEmpDeductions,totalErContributions,netPay
    });
  });

  // Display results
  let html='<table><thead><tr><th>Employee</th><th class="text-right">Gross</th><th class="text-right">NIS</th><th class="text-right">Ed. Tax</th><th class="text-right">Income Tax</th><th class="text-right">NHT</th><th class="text-right">HEART</th><th class="text-right">Total Ded.</th><th class="text-right">Net Pay</th></tr></thead><tbody>';
  let totals={gross:0,nis:0,ed:0,it:0,nht:0,heart:0,ded:0,net:0};
  results.forEach(r=>{
    html+=`<tr><td>${r.empName}</td><td class="mono text-right">${fmt(r.gross)}</td><td class="mono text-right">${fmt(r.nisEmp)}</td><td class="mono text-right">${fmt(r.edTaxEmp)}</td><td class="mono text-right">${fmt(r.incomeTax)}</td><td class="mono text-right">${fmt(r.nhtEmp)}</td><td class="mono text-right">${fmt(r.heartEr)}</td><td class="mono text-right">${fmt(r.totalEmpDeductions)}</td><td class="mono text-right" style="color:var(--green);font-weight:600">${fmt(r.netPay)}</td></tr>`;
    totals.gross+=r.gross;totals.nis+=r.nisEmp;totals.ed+=r.edTaxEmp;totals.it+=r.incomeTax;totals.nht+=r.nhtEmp;totals.heart+=r.heartEr;totals.ded+=r.totalEmpDeductions;totals.net+=r.netPay;
  });
  html+=`<tr style="font-weight:700;border-top:2px solid var(--border)"><td>TOTAL</td><td class="mono text-right">${fmt(totals.gross)}</td><td class="mono text-right">${fmt(totals.nis)}</td><td class="mono text-right">${fmt(totals.ed)}</td><td class="mono text-right">${fmt(totals.it)}</td><td class="mono text-right">${fmt(totals.nht)}</td><td class="mono text-right">${fmt(totals.heart)}</td><td class="mono text-right">${fmt(totals.ded)}</td><td class="mono text-right" style="color:var(--green)">${fmt(totals.net)}</td></tr>`;
  html+='</tbody></table>';
  document.getElementById('payrollResults').innerHTML=html;
  document.getElementById('payrollResultsPanel').style.display='block';
  document.getElementById('payrollResultsPanel').querySelector('.panel-head h3').textContent='Payroll Results';
  // Show the save button
  const saveBtn=document.getElementById('payrollResultsPanel').querySelector('.btn-primary');
  if(saveBtn)saveBtn.style.display='';
  window._pendingPayroll={date:document.getElementById('payCycleDate').value,results};
}

function savePayrollRun(){
  if(!window._pendingPayroll){alert('Calculate payroll first');return;}

  // Check if a payroll already exists for this month
  const pendingDate=new Date(window._pendingPayroll.date);
  const pendingMonth=pendingDate.getMonth();
  const pendingYear=pendingDate.getFullYear();
  const existing=DATA.payrollRuns.find(r=>{
    const d=new Date(r.date);
    return d.getFullYear()===pendingYear&&d.getMonth()===pendingMonth;
  });
  if(existing){
    if(!confirm('A payroll run already exists for '+MONTH_NAMES[pendingMonth]+' '+pendingYear+'. Replace it?'))return;
    const idx=DATA.payrollRuns.indexOf(existing);
    DATA.payrollRuns.splice(idx,1);
  }

  DATA.payrollRuns.push(window._pendingPayroll);
  saveStore();
  window._pendingPayroll=null;
  alert('Payroll saved successfully!');
  renderPayrollInput(); // Refresh to show updated quarter status
}

// ==================== PAYSLIPS ====================
function populatePayslipSelects(){
  const empSel=document.getElementById('payslipEmployee');
  const cycSel=document.getElementById('payslipCycle');
  empSel.innerHTML='<option value="">‚Äî Select ‚Äî</option>';
  DATA.employees.forEach((e,i)=>{empSel.innerHTML+=`<option value="${i}">${e.name} (${e.type})</option>`;});
  cycSel.innerHTML='<option value="">‚Äî Select ‚Äî</option>';
  DATA.payrollRuns.forEach((r,i)=>{cycSel.innerHTML+=`<option value="${i}">${fmtDate(r.date)}</option>`;});
}

function generatePayslipPreview(){
  const empIdx=parseInt(document.getElementById('payslipEmployee').value);
  const cycIdx=parseInt(document.getElementById('payslipCycle').value);
  if(isNaN(empIdx)||isNaN(cycIdx)){alert('Select both employee and pay cycle');return;}
  const emp=DATA.employees[empIdx];
  const run=DATA.payrollRuns[cycIdx];
  const result=run.results.find(r=>r.empName===emp.name);
  if(!result){alert('No payroll data found for this employee in selected cycle');return;}

  // Calculate YTD ‚Äî only for same calendar year
  const runYear=new Date(run.date).getFullYear();
  let ytd={nis:0,edTax:0,nht:0,incomeTax:0,gross:0,heartEr:0,netPay:0};
  DATA.payrollRuns.forEach((r,ri)=>{
    if(ri>cycIdx)return;
    if(new Date(r.date).getFullYear()!==runYear)return;
    const match=r.results.find(x=>x.empName===emp.name);
    if(match){ytd.nis+=match.nisEmp;ytd.edTax+=match.edTaxEmp;ytd.nht+=match.nhtEmp;ytd.incomeTax+=match.incomeTax;ytd.gross+=match.gross;ytd.heartEr+=(match.heartEr||0);ytd.netPay+=match.netPay;}
  });

  const psHtml=buildPayslipHTML(emp,result,run.date,ytd);
  document.getElementById('payslipPreviewArea').innerHTML=`
    <div class="panel" style="margin-top:1rem">
      <div class="panel-head"><h3>Payslip Preview</h3><div class="btn-group"><button class="btn btn-primary btn-sm" onclick="printPayslip()">üñ® Print / Save as PDF</button></div></div>
      <div class="panel-body">${psHtml}</div>
    </div>`;
  document.getElementById('payslipPrintArea').innerHTML=psHtml.replace('payslip-preview','payslip-print');
}

function buildPayslipHTML(emp,result,date,ytd){
  return `<div class="payslip-preview">
    <div class="ps-header">
      <p style="font-size:.85rem;font-weight:700;color:#1a2540;margin-bottom:.25rem">Community Educational and Skills Training Institute and Services Limited</p>
      <p style="font-size:1rem;font-weight:400;color:#666;letter-spacing:2px;margin-top:.15rem">C.E.S.T.I.S</p>
      <p style="font-weight:600;margin-top:.5rem">EMPLOYEE PAY ADVICE SLIP</p>
    </div>
    <div class="ps-info">
      <div class="row"><span class="lbl">Employee Name:</span><span class="val">${result.empName}</span></div>
      <div class="row"><span class="lbl">Pay Cycle:</span><span class="val">${fmtDate(date)}</span></div>
      <div class="row"><span class="lbl">TRN:</span><span class="val">${result.trn||'‚Äî'}</span></div>
      <div class="row"><span class="lbl">NIS #:</span><span class="val">${result.nis||'‚Äî'}</span></div>
      <div class="row"><span class="lbl">Position:</span><span class="val">${result.designation||'‚Äî'}</span></div>
      <div class="row"><span class="lbl">Type:</span><span class="val">${result.empType==='FT'?'Full-Time':'Part-Time'}</span></div>
    </div>
    <table class="ps-table">
      <thead><tr><th>Description</th><th style="text-align:right">Employee</th><th style="text-align:right">Employer</th><th style="text-align:right">Year-to-Date</th></tr></thead>
      <tbody>
        <tr><td>NIS</td><td class="amt">${fmt(result.nisEmp)}</td><td class="amt">${fmt(result.nisEr)}</td><td class="amt">${fmt(ytd.nis)}</td></tr>
        <tr><td>Income Tax</td><td class="amt">${fmt(result.incomeTax)}</td><td class="amt">‚Äî</td><td class="amt">${fmt(ytd.incomeTax)}</td></tr>
        <tr><td>Education Tax</td><td class="amt">${fmt(result.edTaxEmp)}</td><td class="amt">${fmt(result.edTaxEr)}</td><td class="amt">${fmt(ytd.edTax)}</td></tr>
        <tr><td>NHT</td><td class="amt">${fmt(result.nhtEmp)}</td><td class="amt">${fmt(result.nhtEr)}</td><td class="amt">${fmt(ytd.nht)}</td></tr>
        <tr><td>HEART/NSTA</td><td class="amt">‚Äî</td><td class="amt">${fmt(result.heartEr||0)}</td><td class="amt">${fmt(ytd.heartEr)}</td></tr>
        <tr style="font-weight:700;border-top:2px solid #1a2540"><td>Month-to-Date</td><td class="amt">${fmt(result.totalEmpDeductions)}</td><td class="amt">${fmt(result.totalErContributions)}</td><td class="amt"></td></tr>
      </tbody>
    </table>
    <div class="ps-totals">
      <div class="box"><div class="lbl">Gross Earnings</div><div class="val">${fmt(result.gross)}</div></div>
      <div class="box"><div class="lbl">Total Deductions</div><div class="val" style="color:#ef4444">${fmt(result.totalEmpDeductions)}</div></div>
      <div class="box" style="border-color:#10b981"><div class="lbl">Net Pay</div><div class="val" style="color:#10b981">${fmt(result.netPay)}</div></div>
    </div>
    <div class="ps-footer">This is a computer-generated payslip. For queries, contact the Project Coordinator.</div>
  </div>`;
}

function printPayslip(){
  const area=document.getElementById('payslipPrintArea');
  area.style.display='block';
  window.print();
  setTimeout(()=>{area.style.display='none';},500);
}

// ==================== SALARY RECORDS ====================
const MONTH_NAMES=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

function getSalaryRecordYears(){
  const years=new Set();
  DATA.payrollRuns.forEach(r=>{
    if(r.date){const y=new Date(r.date).getFullYear();years.add(y);}
  });
  if(years.size===0)years.add(new Date().getFullYear());
  return Array.from(years).sort((a,b)=>b-a);
}

function getMonthlyData(year){
  // Build month-by-month data for each employee from payroll runs
  const monthly={}; // empName -> [12 months of data]
  DATA.employees.forEach(e=>{
    monthly[e.name]=Array.from({length:12},()=>null);
  });
  DATA.payrollRuns.forEach(run=>{
    const d=new Date(run.date);
    if(d.getFullYear()!==year)return;
    const m=d.getMonth();
    run.results.forEach(r=>{
      if(monthly[r.empName]){
        monthly[r.empName][m]={
          gross:r.gross,netPay:r.netPay,
          nisEmp:r.nisEmp,nisEr:r.nisEr,
          edTaxEmp:r.edTaxEmp,edTaxEr:r.edTaxEr,
          nhtEmp:r.nhtEmp,nhtEr:r.nhtEr,
          heartEr:r.heartEr||0,
          incomeTax:r.incomeTax,
          totalEmpDeductions:r.totalEmpDeductions,
          totalErContributions:r.totalErContributions
        };
      }
    });
  });
  return monthly;
}

function renderSalaryRecords(){
  const yearSel=document.getElementById('salaryRecordYear');
  const years=getSalaryRecordYears();
  const prevVal=yearSel.value;
  yearSel.innerHTML=years.map(y=>`<option value="${y}">${y}</option>`).join('');
  if(prevVal&&years.includes(parseInt(prevVal)))yearSel.value=prevVal;

  const year=parseInt(yearSel.value);
  const monthly=getMonthlyData(year);
  const empNames=DATA.employees.map(e=>e.name);

  // Main monthly gross table
  let html='<table><thead><tr><th>Employee</th>';
  MONTH_NAMES.forEach(m=>{html+=`<th class="text-right">${m}</th>`;});
  html+='<th class="text-right" style="background:rgba(59,130,246,.15);color:#60a5fa">Annual Total</th></tr></thead><tbody>';

  let grandMonthly=Array.from({length:12},()=>0);
  let grandAnnual=0;

  empNames.forEach(name=>{
    const emp=DATA.employees.find(e=>e.name===name);
    const data=monthly[name];
    let annualTotal=0;
    html+=`<tr><td>${name} <span class="tag ${emp.type==='FT'?'tag-ft':'tag-pt'}" style="margin-left:.3rem">${emp.type}</span></td>`;
    for(let m=0;m<12;m++){
      const val=data[m]?data[m].gross:0;
      annualTotal+=val;
      grandMonthly[m]+=val;
      html+=`<td class="mono text-right">${val?fmt(val):'<span style="color:var(--text-muted)">‚Äî</span>'}</td>`;
    }
    grandAnnual+=annualTotal;
    html+=`<td class="mono text-right" style="font-weight:600;background:rgba(59,130,246,.05)">${fmt(annualTotal)}</td></tr>`;
  });

  // Monthly totals row
  html+=`<tr style="font-weight:700;border-top:2px solid var(--border)"><td>MONTHLY TOTAL</td>`;
  for(let m=0;m<12;m++){
    html+=`<td class="mono text-right">${grandMonthly[m]?fmt(grandMonthly[m]):'‚Äî'}</td>`;
  }
  html+=`<td class="mono text-right" style="color:var(--primary);background:rgba(59,130,246,.1)">${fmt(grandAnnual)}</td></tr>`;

  // Net pay row
  let netMonthly=Array.from({length:12},()=>0);
  let netAnnual=0;
  empNames.forEach(name=>{
    const data=monthly[name];
    for(let m=0;m<12;m++){
      if(data[m]){netMonthly[m]+=data[m].netPay;netAnnual+=data[m].netPay;}
    }
  });
  html+=`<tr style="font-weight:700;color:var(--green)"><td>NET PAY TOTAL</td>`;
  for(let m=0;m<12;m++){
    html+=`<td class="mono text-right">${netMonthly[m]?fmt(netMonthly[m]):'‚Äî'}</td>`;
  }
  html+=`<td class="mono text-right" style="background:rgba(16,185,129,.1)">${fmt(netAnnual)}</td></tr>`;

  if(empNames.length===0)html+=`<tr><td colspan="14" style="text-align:center;color:var(--text-muted);padding:2rem">No employees or payroll data</td></tr>`;
  html+='</tbody></table>';
  document.getElementById('salaryRecordsTable').innerHTML=html;

  // Stats cards
  const totalDeductions=grandAnnual-netAnnual;
  let erTotal=0;
  empNames.forEach(name=>{
    const data=monthly[name];
    for(let m=0;m<12;m++){if(data[m])erTotal+=data[m].totalErContributions;}
  });
  const monthsWithData=grandMonthly.filter(v=>v>0).length;
  document.getElementById('salaryRecordStats').innerHTML=`
    <div class="stat-card blue"><div class="label">Annual Gross</div><div class="value mono">${fmt(grandAnnual)}</div><div class="sub">${year} ‚Äî ${monthsWithData} month(s) recorded</div></div>
    <div class="stat-card green"><div class="label">Annual Net Pay</div><div class="value mono">${fmt(netAnnual)}</div><div class="sub">After all employee deductions</div></div>
    <div class="stat-card red"><div class="label">Employee Deductions</div><div class="value mono">${fmt(totalDeductions)}</div><div class="sub">NIS + Ed Tax + NHT + Income Tax</div></div>
    <div class="stat-card gold"><div class="label">Employer Contributions</div><div class="value mono">${fmt(erTotal)}</div><div class="sub">NIS + Ed Tax + NHT + HEART</div></div>
  `;

  renderQuarterlyTables(year,monthly,empNames);
}

function renderQuarterlyTables(year,monthly,empNames){
  const quarters=[
    {label:'Q1 (Jan\u2013Mar)',months:[0,1,2]},
    {label:'Q2 (Apr\u2013Jun)',months:[3,4,5]},
    {label:'Q3 (Jul\u2013Sep)',months:[6,7,8]},
    {label:'Q4 (Oct\u2013Dec)',months:[9,10,11]}
  ];

  // Aggregated quarterly summary
  let qhtml='<table><thead><tr><th>Quarter</th><th class="text-right">Gross Pay</th><th class="text-right">NIS (Emp)</th><th class="text-right">Ed. Tax (Emp)</th><th class="text-right">NHT (Emp)</th><th class="text-right">Income Tax</th><th class="text-right">Total Emp Ded.</th><th class="text-right">Net Pay</th><th class="text-right">NIS (Er)</th><th class="text-right">Ed. Tax (Er)</th><th class="text-right">NHT (Er)</th><th class="text-right">HEART (Er)</th><th class="text-right">Total Er Contr.</th></tr></thead><tbody>';

  let annTotals={gross:0,nisE:0,edE:0,nhtE:0,it:0,empDed:0,net:0,nisR:0,edR:0,nhtR:0,heartR:0,erC:0};

  quarters.forEach(q=>{
    let t={gross:0,nisE:0,edE:0,nhtE:0,it:0,empDed:0,net:0,nisR:0,edR:0,nhtR:0,heartR:0,erC:0};
    empNames.forEach(name=>{
      const data=monthly[name];
      q.months.forEach(m=>{
        if(data[m]){
          t.gross+=data[m].gross;t.nisE+=data[m].nisEmp;t.edE+=data[m].edTaxEmp;t.nhtE+=data[m].nhtEmp;
          t.it+=data[m].incomeTax;t.empDed+=data[m].totalEmpDeductions;t.net+=data[m].netPay;
          t.nisR+=data[m].nisEr;t.edR+=data[m].edTaxEr;t.nhtR+=data[m].nhtEr;t.heartR+=data[m].heartEr;
          t.erC+=data[m].totalErContributions;
        }
      });
    });
    Object.keys(annTotals).forEach(k=>{annTotals[k]+=t[k];});
    const hasData=t.gross>0;
    qhtml+=`<tr><td style="font-weight:600">${q.label}</td>
      <td class="mono text-right">${hasData?fmt(t.gross):'‚Äî'}</td>
      <td class="mono text-right">${hasData?fmt(t.nisE):'‚Äî'}</td>
      <td class="mono text-right">${hasData?fmt(t.edE):'‚Äî'}</td>
      <td class="mono text-right">${hasData?fmt(t.nhtE):'‚Äî'}</td>
      <td class="mono text-right">${hasData?fmt(t.it):'‚Äî'}</td>
      <td class="mono text-right">${hasData?fmt(t.empDed):'‚Äî'}</td>
      <td class="mono text-right" style="color:var(--green)">${hasData?fmt(t.net):'‚Äî'}</td>
      <td class="mono text-right">${hasData?fmt(t.nisR):'‚Äî'}</td>
      <td class="mono text-right">${hasData?fmt(t.edR):'‚Äî'}</td>
      <td class="mono text-right">${hasData?fmt(t.nhtR):'‚Äî'}</td>
      <td class="mono text-right">${hasData?fmt(t.heartR):'‚Äî'}</td>
      <td class="mono text-right">${hasData?fmt(t.erC):'‚Äî'}</td></tr>`;
  });

  qhtml+=`<tr style="font-weight:700;border-top:2px solid var(--border)"><td>ANNUAL TOTAL</td>
    <td class="mono text-right">${fmt(annTotals.gross)}</td><td class="mono text-right">${fmt(annTotals.nisE)}</td>
    <td class="mono text-right">${fmt(annTotals.edE)}</td><td class="mono text-right">${fmt(annTotals.nhtE)}</td>
    <td class="mono text-right">${fmt(annTotals.it)}</td><td class="mono text-right">${fmt(annTotals.empDed)}</td>
    <td class="mono text-right" style="color:var(--green)">${fmt(annTotals.net)}</td>
    <td class="mono text-right">${fmt(annTotals.nisR)}</td><td class="mono text-right">${fmt(annTotals.edR)}</td>
    <td class="mono text-right">${fmt(annTotals.nhtR)}</td><td class="mono text-right">${fmt(annTotals.heartR)}</td>
    <td class="mono text-right">${fmt(annTotals.erC)}</td></tr>`;
  qhtml+='</tbody></table>';
  document.getElementById('quarterlyTable').innerHTML=qhtml;

  // Per-employee quarterly breakdown
  let eqhtml='<table><thead><tr><th>Employee</th><th class="text-right">Q1 Gross</th><th class="text-right">Q1 Net</th><th class="text-right">Q2 Gross</th><th class="text-right">Q2 Net</th><th class="text-right">Q3 Gross</th><th class="text-right">Q3 Net</th><th class="text-right">Q4 Gross</th><th class="text-right">Q4 Net</th><th class="text-right">Annual Gross</th><th class="text-right">Annual Net</th></tr></thead><tbody>';

  let qTotals=Array.from({length:4},()=>({gross:0,net:0}));
  let aTotals={gross:0,net:0};

  empNames.forEach(name=>{
    const emp=DATA.employees.find(e=>e.name===name);
    const data=monthly[name];
    let empAnnGross=0,empAnnNet=0;
    eqhtml+=`<tr><td>${name} <span class="tag ${emp.type==='FT'?'tag-ft':'tag-pt'}" style="margin-left:.3rem">${emp.type}</span></td>`;
    quarters.forEach((q,qi)=>{
      let qg=0,qn=0;
      q.months.forEach(m=>{
        if(data[m]){qg+=data[m].gross;qn+=data[m].netPay;}
      });
      empAnnGross+=qg;empAnnNet+=qn;
      qTotals[qi].gross+=qg;qTotals[qi].net+=qn;
      eqhtml+=`<td class="mono text-right">${qg?fmt(qg):'‚Äî'}</td><td class="mono text-right" style="color:var(--green)">${qn?fmt(qn):'‚Äî'}</td>`;
    });
    aTotals.gross+=empAnnGross;aTotals.net+=empAnnNet;
    eqhtml+=`<td class="mono text-right" style="font-weight:600">${fmt(empAnnGross)}</td><td class="mono text-right" style="font-weight:600;color:var(--green)">${fmt(empAnnNet)}</td></tr>`;
  });

  eqhtml+=`<tr style="font-weight:700;border-top:2px solid var(--border)"><td>TOTAL</td>`;
  quarters.forEach((q,qi)=>{
    eqhtml+=`<td class="mono text-right">${fmt(qTotals[qi].gross)}</td><td class="mono text-right" style="color:var(--green)">${fmt(qTotals[qi].net)}</td>`;
  });
  eqhtml+=`<td class="mono text-right">${fmt(aTotals.gross)}</td><td class="mono text-right" style="color:var(--green)">${fmt(aTotals.net)}</td></tr>`;

  if(empNames.length===0)eqhtml+=`<tr><td colspan="11" style="text-align:center;color:var(--text-muted);padding:2rem">No data</td></tr>`;
  eqhtml+='</tbody></table>';
  document.getElementById('empQuarterlyTable').innerHTML=eqhtml;
}

function exportSalaryRecordsCSV(){
  const year=parseInt(document.getElementById('salaryRecordYear').value)||new Date().getFullYear();
  const monthly=getMonthlyData(year);
  let csv='Employee,Type,'+MONTH_NAMES.join(',')+',Annual Total\n';
  DATA.employees.forEach(e=>{
    const data=monthly[e.name];
    let annTotal=0;
    csv+=`"${e.name}",${e.type}`;
    for(let m=0;m<12;m++){
      const val=data[m]?data[m].gross:0;
      annTotal+=val;csv+=`,${val.toFixed(2)}`;
    }
    csv+=`,${annTotal.toFixed(2)}\n`;
  });
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`CESTIS_SalaryRecords_${year}.csv`;
  a.click();URL.revokeObjectURL(a.href);
}

// ==================== TAX SUMMARY ====================
function renderTaxSummary(){
  const runs=DATA.payrollRuns;
  let html='<table><thead><tr><th>Pay Date</th><th class="text-right">NIS (Emp+Er)</th><th class="text-right">Income Tax</th><th class="text-right">Ed. Tax (Emp+Er)</th><th class="text-right">NHT (Emp+Er)</th><th class="text-right">HEART (Er)</th><th class="text-right">Total Emp Ded.</th><th class="text-right">Total Er Contr.</th><th class="text-right">Grand Total</th></tr></thead><tbody>';
  if(runs.length===0)html+='<tr><td colspan="9" style="text-align:center;color:var(--text-muted);padding:2rem">No payroll data</td></tr>';
  runs.forEach(r=>{
    let nis=0,it=0,ed=0,nht=0,heart=0,empD=0,erC=0;
    r.results.forEach(x=>{nis+=x.nisEmp+x.nisEr;it+=x.incomeTax;ed+=x.edTaxEmp+x.edTaxEr;nht+=x.nhtEmp+x.nhtEr;heart+=(x.heartEr||0);empD+=x.totalEmpDeductions;erC+=x.totalErContributions;});
    html+=`<tr><td>${fmtDate(r.date)}</td><td class="mono text-right">${fmt(nis)}</td><td class="mono text-right">${fmt(it)}</td><td class="mono text-right">${fmt(ed)}</td><td class="mono text-right">${fmt(nht)}</td><td class="mono text-right">${fmt(heart)}</td><td class="mono text-right">${fmt(empD)}</td><td class="mono text-right">${fmt(erC)}</td><td class="mono text-right" style="font-weight:700">${fmt(empD+erC)}</td></tr>`;
  });
  html+='</tbody></table>';
  document.getElementById('taxSummaryTable').innerHTML=html;

  const sel=document.getElementById('taxCycleSelect');
  sel.innerHTML='<option value="">‚Äî Select ‚Äî</option>';
  runs.forEach((r,i)=>{sel.innerHTML+=`<option value="${i}">${fmtDate(r.date)}</option>`;});
}

function renderTaxBreakdown(){
  const idx=parseInt(document.getElementById('taxCycleSelect').value);
  if(isNaN(idx))return;
  const run=DATA.payrollRuns[idx];
  let html='<table><thead><tr><th>Employee</th><th class="text-right">NIS (Emp)</th><th class="text-right">NIS (Er)</th><th class="text-right">Income Tax</th><th class="text-right">Ed.Tax (Emp)</th><th class="text-right">Ed.Tax (Er)</th><th class="text-right">NHT (Emp)</th><th class="text-right">NHT (Er)</th><th class="text-right">HEART (Er)</th></tr></thead><tbody>';
  run.results.forEach(r=>{
    html+=`<tr><td>${r.empName}</td><td class="mono text-right">${fmt(r.nisEmp)}</td><td class="mono text-right">${fmt(r.nisEr)}</td><td class="mono text-right">${fmt(r.incomeTax)}</td><td class="mono text-right">${fmt(r.edTaxEmp)}</td><td class="mono text-right">${fmt(r.edTaxEr)}</td><td class="mono text-right">${fmt(r.nhtEmp)}</td><td class="mono text-right">${fmt(r.nhtEr)}</td><td class="mono text-right">${fmt(r.heartEr||0)}</td></tr>`;
  });
  html+='</tbody></table>';
  document.getElementById('taxBreakdownTable').innerHTML=html;
}

// ==================== SETTINGS ====================
function loadSettings(){
  const s=DATA.settings;
  document.getElementById('rateNISEmp').value=s.nisEmp;
  document.getElementById('rateNISEr').value=s.nisEr;
  document.getElementById('nisCeilingMonthly').value=s.nisCeilingMonthly||416667;
  document.getElementById('rateEdTaxEmp').value=s.edTaxEmp;
  document.getElementById('rateEdTaxEr').value=s.edTaxEr;
  document.getElementById('rateNHTEmp').value=s.nhtEmp;
  document.getElementById('rateNHTEr').value=s.nhtEr;
  document.getElementById('rateHeartEr').value=s.heartEr||3;
  document.getElementById('rateIncomeTax').value=s.incomeTax;
  document.getElementById('rateIncomeTaxHigher').value=s.incomeTaxHigher||30;
  document.getElementById('higherBracketAnnual').value=s.higherBracketAnnual||6000000;
  document.getElementById('annualThreshold').value=s.annualThreshold;
}

function saveSettings(){
  DATA.settings={
    nisEmp:parseFloat(document.getElementById('rateNISEmp').value)||3,
    nisEr:parseFloat(document.getElementById('rateNISEr').value)||3,
    nisCeilingMonthly:parseFloat(document.getElementById('nisCeilingMonthly').value)||416667,
    edTaxEmp:parseFloat(document.getElementById('rateEdTaxEmp').value)||2.25,
    edTaxEr:parseFloat(document.getElementById('rateEdTaxEr').value)||3.5,
    nhtEmp:parseFloat(document.getElementById('rateNHTEmp').value)||2,
    nhtEr:parseFloat(document.getElementById('rateNHTEr').value)||3,
    heartEr:parseFloat(document.getElementById('rateHeartEr').value)||3,
    incomeTax:parseFloat(document.getElementById('rateIncomeTax').value)||25,
    incomeTaxHigher:parseFloat(document.getElementById('rateIncomeTaxHigher').value)||30,
    higherBracketAnnual:parseFloat(document.getElementById('higherBracketAnnual').value)||6000000,
    annualThreshold:parseFloat(document.getElementById('annualThreshold').value)||1799376
  };
  saveStore();
  alert('Settings saved!');
}

// ==================== FETCH CURRENT RATES ====================
// Google Drive folder: https://drive.google.com/drive/folders/1JY8N-AXxxM_eQJ3Gfr0OKBoK4rKchdeV
// To set up: upload rates.json to the folder above, right-click ‚Üí Share ‚Üí "Anyone with the link",
// then paste the file's ID below (the long string from the share link between /d/ and /view).
const GDRIVE_RATES_FILE_ID = '1F_GCD8rM4SltmcyGMlUG-EXBsvTQLWWR';
const GITHUB_RATES_URL = 'https://raw.githubusercontent.com/stevebarrettsrha-ops/Staff-Payslip---Dashboard/main/rates.json';

function applyRatesData(data, sourceName, statusDiv){
  if (!data.rates) throw new Error('Invalid rates data format ‚Äî missing "rates" object');

  const r = data.rates;
  const fieldMap = {
    rateNISEmp: r.nisEmp,
    rateNISEr: r.nisEr,
    nisCeilingMonthly: r.nisCeilingMonthly,
    rateEdTaxEmp: r.edTaxEmp,
    rateEdTaxEr: r.edTaxEr,
    rateNHTEmp: r.nhtEmp,
    rateNHTEr: r.nhtEr,
    rateHeartEr: r.heartEr,
    rateIncomeTax: r.incomeTax,
    rateIncomeTaxHigher: r.incomeTaxHigher,
    higherBracketAnnual: r.higherBracketAnnual,
    annualThreshold: r.annualThreshold
  };

  let changedCount = 0;
  for (const [id, val] of Object.entries(fieldMap)) {
    if (val !== undefined && val !== null) {
      const el = document.getElementById(id);
      if (el && parseFloat(el.value) !== val) {
        el.value = val;
        el.style.outline = '2px solid var(--accent2)';
        setTimeout(() => { el.style.outline = ''; }, 3000);
        changedCount++;
      } else if (el) {
        el.value = val;
      }
    }
  }

  const fy = data.fiscalYear || 'N/A';
  const effective = data.effectiveDate || 'N/A';
  const updated = data.lastUpdated || 'N/A';
  statusDiv.style.background = 'rgba(16,185,129,0.1)';
  statusDiv.style.color = 'var(--accent2)';
  statusDiv.innerHTML = '‚úÖ Rates loaded from <strong>' + sourceName + '</strong> ‚Äî <strong>Fiscal Year ' + fy + '</strong> (effective ' + effective + ', last updated ' + updated + '). ' +
    (changedCount > 0 ? changedCount + ' field(s) updated.' : 'All fields already current.') +
    ' <em>Click "Save Settings" to apply.</em>';
}

async function tryFetchJSON(url){
  const response = await fetch(url, { cache: 'no-store' });
  if (!response.ok) throw new Error('HTTP ' + response.status);
  const text = await response.text();
  if (text.trimStart().startsWith('<')) throw new Error('Received HTML instead of JSON');
  return JSON.parse(text);
}

async function fetchCurrentRates(){
  const btn = document.getElementById('fetchRatesBtn');
  const statusDiv = document.getElementById('ratesFetchStatus');

  btn.disabled = true;
  btn.textContent = '‚è≥ Fetching...';
  statusDiv.style.display = 'block';
  statusDiv.style.background = 'var(--primary-glow)';
  statusDiv.style.color = 'var(--text)';

  // Build ordered list of sources to try
  const sources = [];
  if (GDRIVE_RATES_FILE_ID) {
    sources.push({
      name: 'Google Drive',
      url: 'https://drive.google.com/uc?export=download&id=' + GDRIVE_RATES_FILE_ID
    });
  }
  sources.push({ name: 'GitHub', url: GITHUB_RATES_URL });

  for (let i = 0; i < sources.length; i++) {
    const src = sources[i];
    statusDiv.textContent = 'Fetching latest rates from ' + src.name + '...';
    try {
      const data = await tryFetchJSON(src.url);
      applyRatesData(data, src.name, statusDiv);
      btn.disabled = false;
      btn.textContent = 'üåê Fetch Current Rates';
      return;
    } catch (err) {
      // If more sources remain, silently try the next one
      if (i < sources.length - 1) {
        statusDiv.textContent = src.name + ' unavailable, trying ' + sources[i+1].name + '...';
        continue;
      }
      // All sources exhausted
      statusDiv.style.background = 'rgba(239,68,68,0.1)';
      statusDiv.style.color = 'var(--danger)';
      statusDiv.textContent = '‚ùå Failed to fetch rates: ' + err.message + '. Please check your internet connection or update rates manually.';
    }
  }

  btn.disabled = false;
  btn.textContent = 'üåê Fetch Current Rates';
}

// ==================== PRESET DATA ====================
function loadPresetData(){
  if(DATA.employees.length>0&&!confirm('This will replace existing employees. Continue?'))return;
  DATA.employees=[
    {name:'Steve Barrett',designation:'Co-ordinator',type:'FT',mobile:'876-365-2325',dob:'1996-11-03',trn:'127-009-850',nis:'C-96-05-01',startDate:'2021-03-01',salary:37145},
    {name:'Rashaun Barrett',designation:'Administrative Assistant/ Assistant Coordinator',type:'FT',mobile:'876-530-9149',dob:'1998-10-05',trn:'127-009-817',nis:'C-98-03-73',startDate:'2022-10-01',salary:78000},
    {name:'Rohan Hamilton',designation:'Welding Instructor',type:'FT',mobile:'876-783-8616',dob:'1974-07-26',trn:'105-249-262',nis:'C-74-05-80',startDate:'2018-08-05',salary:95943.09},
    {name:'Richard Smith',designation:'Electrical Installation Instructor (BNV)',type:'FT',mobile:'876-986-3698',dob:'1971-03-07',trn:'102-183-511',nis:'C-71-08-24',startDate:'2020-04-01',salary:91374.37},
    {name:'Tracy-Ann Johnson',designation:'Cosmetology/Beauty Therapy Instructor',type:'FT',mobile:'876-879-6059',dob:'1986-01-16',trn:'115-862-331',nis:'C-86-39-20',startDate:'2019-04-01',salary:86190.64},
    {name:'Kevin Allen',designation:'Welding Instructor (BNV)',type:'FT',mobile:'876-536-5733',dob:'1964-04-08',trn:'100-861-229',nis:'M-64-10-13',startDate:'2020-04-01',salary:91374.37},
    {name:'Seyoum Blackwood',designation:'Electrical Installation Instructor',type:'FT',mobile:'876-853-7632',dob:'1998-06-01',trn:'127-288-945',nis:'C-98-07-79',startDate:'2022-03-01',salary:91374.37},
    {name:'Pamella Archer',designation:'Entrepreneurship Instructor (PT)',type:'PT',mobile:'876-454-8458',dob:'1971-09-07',trn:'102-062-072',nis:'C-71-80-34',startDate:'2021-08-05',salary:0},
    {name:'Fontanette Whittingham',designation:'Information Technology Instructor (PT)',type:'PT',mobile:'876-869-5329',dob:'1986-04-16',trn:'116-017-996',nis:'C-86-32-25',startDate:'2020-08-01',salary:0},
    {name:'Yves Bergeron',designation:'Personal Development Instructor (PT)',type:'PT',mobile:'876-319-8904',dob:'1963-11-17',trn:'112-579-477',nis:'N-63-15-58',startDate:'2020-08-01',salary:0},
    {name:'Glowmayne Rowe',designation:'Mathematics Instructor (PT)',type:'PT',mobile:'',dob:'',trn:'126-305-307',nis:'M-96-08-58',startDate:'',salary:0}
  ];
  saveStore();
  alert('Preset employee data loaded!');
  showPage('employees');
}

// ==================== IMPORT/EXPORT ====================
function exportAllData(){
  const blob=new Blob([JSON.stringify(DATA,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`CESTIS_Payroll_${new Date().toISOString().split('T')[0]}.json`;
  a.click();URL.revokeObjectURL(a.href);
}

function importData(evt){
  const file=evt.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{DATA=JSON.parse(e.target.result);saveStore();alert('Data imported!');location.reload();}
    catch(err){alert('Invalid file format');}
  };
  reader.readAsText(file);
  evt.target.value='';
}

// ============================================
// Google Drive Cloud Sync Integration
// ============================================

// Google Drive Configuration
const GOOGLE_DRIVE_CONFIG = {
    CLIENT_ID: '302497466088-0b619cqa9qno2c606k4rqp742lebc5o8.apps.googleusercontent.com',
    FOLDER_ID: '1JY8N-AXxxM_eQJ3Gfr0OKBoK4rKchdeV',
    BACKUP_FILE_NAME: 'employee_payroll_Backup.json',
    SCOPES: 'https://www.googleapis.com/auth/drive'
};

// Cloud sync state
let googleAccessToken = null;
let isCloudConnected = false;
let lastSyncTime = null;
let cloudFileId = null;
let lastSavedBy = null;
let cloudFileTimestamp = null;
let googleTokenClient = null;

// Initialize cloud sync from localStorage
function initializeCloudSync() {
    const savedToken = localStorage.getItem('schoolDashboardGoogleAccessToken');
    const savedExpiry = localStorage.getItem('schoolDashboardGoogleTokenExpiry');
    const savedLastSync = localStorage.getItem('schoolDashboardLastSyncTime');
    const savedFileId = localStorage.getItem('schoolDashboardCloudFileId');

    if (savedLastSync) {
        lastSyncTime = new Date(savedLastSync);
        updateLastSyncDisplay();
    }

    if (savedFileId) {
        cloudFileId = savedFileId;
    }

    if (savedToken && savedExpiry) {
        const expiry = new Date(savedExpiry);
        if (expiry > new Date()) {
            googleAccessToken = savedToken;
            isCloudConnected = true;
            updateCloudUI(true);
            return;
        }
    }

    updateCloudUI(false);
}

// Update cloud UI based on connection status
function updateCloudUI(connected) {
    const notConnectedDiv = document.getElementById('cloudNotConnected');
    const connectedDiv = document.getElementById('cloudConnected');
    const statusDot = document.getElementById('cloudStatusDot');
    const statusText = document.getElementById('cloudStatusText');

    if (connected) {
        notConnectedDiv.style.display = 'none';
        connectedDiv.style.display = 'block';
        if (statusDot) statusDot.className = 'cloud-status-dot connected';
        if (statusText) statusText.textContent = 'Connected';
    } else {
        notConnectedDiv.style.display = 'block';
        connectedDiv.style.display = 'none';
        if (statusDot) statusDot.className = 'cloud-status-dot';
        if (statusText) statusText.textContent = 'Not connected';
    }
}

// Update syncing status
function setCloudSyncing(syncing) {
    const menuIcon = document.getElementById('cloudMenuIcon');
    const connectedDot = document.getElementById('cloudConnectedDot');
    const connectedText = document.getElementById('cloudConnectedText');
    const sidebarSync = document.getElementById('sidebarSyncInfo');

    if (syncing) {
        if (menuIcon) menuIcon.innerHTML = '<span class="spinning">üîÑ</span>';
        if (connectedDot) connectedDot.className = 'cloud-status-dot syncing';
        if (connectedText) { connectedText.textContent = 'Syncing...'; connectedText.className = 'cloud-status-label syncing nav-text'; }
        if (sidebarSync) sidebarSync.textContent = 'Syncing...';
    } else {
        if (menuIcon) menuIcon.textContent = '‚òÅÔ∏è';
        if (connectedDot) connectedDot.className = 'cloud-status-dot connected';
        if (connectedText) { connectedText.textContent = 'Connected'; connectedText.className = 'cloud-status-label connected nav-text'; }
        updateLastSyncDisplay();
    }
}

// Toggle cloud dropdown menu
function toggleCloudMenu() {
    const menu = document.getElementById('cloudDropdownMenu');
    menu.classList.toggle('show');
    setTimeout(() => {
        document.addEventListener('click', closeCloudMenuOnClickOutside);
    }, 0);
}

function closeCloudMenuOnClickOutside(e) {
    const menu = document.getElementById('cloudDropdownMenu');
    const dropdown = document.querySelector('.cloud-dropdown');
    if (!dropdown.contains(e.target)) {
        menu.classList.remove('show');
        document.removeEventListener('click', closeCloudMenuOnClickOutside);
    }
}

// Initialize Google Identity Services
function initGoogleAuth() {
    if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
        googleTokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_DRIVE_CONFIG.CLIENT_ID,
            scope: GOOGLE_DRIVE_CONFIG.SCOPES,
            callback: handleGoogleAuthCallback,
            error_callback: handleGoogleAuthError
        });
    }
}

// Connect to Google Drive
async function connectToGoogleDrive() {
    showGoogleAuthModal();
}

// Show authentication modal
function showGoogleAuthModal() {
    const modalHTML = `
        <div id="googleAuthModal" class="google-auth-modal" style="display:flex;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚òÅÔ∏è Connect to Google Drive</h2>
                    <button class="close-btn" onclick="closeGoogleAuthModal()">√ó</button>
                </div>
                <div style="padding:1.5rem;">
                    <p style="margin-bottom:1.25rem;color:var(--text-dim);">
                        Connect to Google Drive to save and sync your payroll data across devices. Choose your preferred connection method:
                    </p>

                    <!-- Option 1: Direct Google Sign-In -->
                    <div style="background:rgba(16,185,129,0.1);border:2px solid var(--green);border-radius:8px;padding:1.25rem;margin-bottom:1rem;">
                        <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem;">
                            <span style="font-size:1.5rem;">üîê</span>
                            <div>
                                <strong style="color:var(--green);font-size:1.1rem;">Direct Google Sign-In</strong>
                                <span style="background:var(--green);color:white;padding:2px 8px;border-radius:4px;font-size:0.7rem;margin-left:0.5rem;font-weight:600;">RECOMMENDED</span>
                            </div>
                        </div>
                        <p style="color:var(--text-dim);font-size:0.9rem;margin-bottom:1rem;">
                            A Google popup will appear for you to sign in with your Google account directly.
                        </p>
                        <button class="btn btn-success" onclick="triggerDirectGoogleSignIn()" style="width:100%;padding:0.75rem;">
                            Sign in with Google
                        </button>
                    </div>

                    <!-- Option 2: Manual Token Method -->
                    <div id="manualTokenSection" style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:1.25rem;">
                        <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem;">
                            <span style="font-size:1.5rem;">üîß</span>
                            <strong style="color:var(--text);font-size:1.1rem;">Manual Token Method</strong>
                        </div>
                        <p style="color:var(--text-dim);font-size:0.9rem;margin-bottom:1rem;">
                            If the popup doesn't work, you can use the OAuth Playground to get a token manually.
                        </p>
                        <button class="btn btn-ghost" onclick="showManualTokenForm()" id="showManualTokenBtn" style="width:100%;">
                            Use Manual Method
                        </button>

                        <div id="manualTokenForm" style="display:none;margin-top:1rem;">
                            <div style="background:rgba(59,130,246,0.1);border:1px solid var(--primary);border-radius:6px;padding:1rem;margin-bottom:1rem;">
                                <strong style="color:var(--primary);">How to get your access token:</strong>
                                <ol style="margin-top:0.5rem;margin-left:1rem;color:var(--text-dim);font-size:0.85rem;line-height:1.6;">
                                    <li>Click the link below to open Google OAuth Playground</li>
                                    <li>In Step 1, find and select <strong>"Drive API v3"</strong> ‚Üí check <strong>"../auth/drive"</strong></li>
                                    <li>Click <strong>"Authorize APIs"</strong></li>
                                    <li>Sign in with your Google account</li>
                                    <li>In Step 2, click <strong>"Exchange authorization code for tokens"</strong></li>
                                    <li>Copy the <strong>"Access token"</strong> value and paste below</li>
                                </ol>
                                <a href="https://developers.google.com/oauthplayground" target="_blank"
                                   style="display:inline-block;margin-top:0.75rem;padding:0.5rem 1rem;background:var(--primary);color:white;border-radius:6px;text-decoration:none;font-weight:600;font-size:0.875rem;">
                                    üîó Open OAuth Playground
                                </a>
                            </div>

                            <div class="form-group" style="margin-bottom:1rem;">
                                <label>Access Token</label>
                                <textarea id="googleAccessTokenInput" rows="4" style="width:100%;padding:0.75rem;resize:vertical;margin-top:0.5rem;" placeholder="Paste your access token here..."></textarea>
                            </div>

                            <button class="btn btn-success" onclick="submitGoogleToken()" style="width:100%;">
                                ‚òÅÔ∏è Connect with Token
                            </button>
                        </div>
                    </div>

                    <div style="margin-top:1rem;text-align:center;">
                        <button class="btn btn-ghost" onclick="closeGoogleAuthModal()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Trigger the direct Google Sign-In popup
function triggerDirectGoogleSignIn() {
    closeGoogleAuthModal();
    if (googleTokenClient) {
        googleTokenClient.requestAccessToken();
    } else {
        initGoogleAuth();
        setTimeout(() => {
            if (googleTokenClient) {
                googleTokenClient.requestAccessToken();
            } else {
                alert('Google Sign-In popup is not available. Please use the manual token method.');
                showGoogleAuthModal();
                setTimeout(() => showManualTokenForm(), 100);
            }
        }, 500);
    }
}

// Show the manual token form
function showManualTokenForm() {
    const form = document.getElementById('manualTokenForm');
    const btn = document.getElementById('showManualTokenBtn');
    if (form && btn) {
        form.style.display = 'block';
        btn.style.display = 'none';
    }
}

function closeGoogleAuthModal() {
    const modal = document.getElementById('googleAuthModal');
    if (modal) modal.remove();
}

async function submitGoogleToken() {
    const tokenInput = document.getElementById('googleAccessTokenInput');
    const token = tokenInput.value.trim();

    if (!token) {
        alert('Please enter an access token');
        return;
    }

    try {
        const response = await fetch('https://www.googleapis.com/drive/v3/about?fields=user', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Invalid token');

        const data = await response.json();

        googleAccessToken = token;
        isCloudConnected = true;

        const expiry = new Date();
        expiry.setHours(expiry.getHours() + 1);
        localStorage.setItem('schoolDashboardGoogleAccessToken', token);
        localStorage.setItem('schoolDashboardGoogleTokenExpiry', expiry.toISOString());

        closeGoogleAuthModal();
        updateCloudUI(true);

        alert('Connected to Google Drive as ' + (data.user.displayName || data.user.emailAddress));

        await findExistingBackupFile();

    } catch (error) {
        console.error('Token verification failed:', error);
        alert('Invalid access token. Please make sure you copied the correct token.');
    }
}

async function handleGoogleAuthCallback(tokenResponse) {
    googleAccessToken = tokenResponse.access_token;
    isCloudConnected = true;

    const expiry = new Date();
    expiry.setSeconds(expiry.getSeconds() + (tokenResponse.expires_in || 3600));
    localStorage.setItem('schoolDashboardGoogleAccessToken', googleAccessToken);
    localStorage.setItem('schoolDashboardGoogleTokenExpiry', expiry.toISOString());

    updateCloudUI(true);

    await findExistingBackupFile();

    alert('Connected to Google Drive successfully! You can now Save, Sync, or Merge your data.');
}

function handleGoogleAuthError(error) {
    console.error('Google auth error:', error);
    if (error.type === 'popup_closed') return;
    alert('Failed to authenticate with Google. Please try the manual token method.');
    showGoogleAuthModal();
}

// Disconnect from Google Drive
function disconnectFromGoogleDrive() {
    if (confirm('Are you sure you want to disconnect from Google Drive? Your local data will remain intact.')) {
        googleAccessToken = null;
        isCloudConnected = false;
        cloudFileId = null;

        localStorage.removeItem('schoolDashboardGoogleAccessToken');
        localStorage.removeItem('schoolDashboardGoogleTokenExpiry');
        localStorage.removeItem('schoolDashboardCloudFileId');

        updateCloudUI(false);
        const menu = document.getElementById('cloudDropdownMenu');
        if (menu) menu.classList.remove('show');

        alert('Disconnected from Google Drive');
    }
}

// Find existing backup file in the folder
async function findExistingBackupFile() {
    try {
        const query = `name='${GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME}' and '${GOOGLE_DRIVE_CONFIG.FOLDER_ID}' in parents and trashed=false`;
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,modifiedTime)`,
            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );

        if (response.ok) {
            const data = await response.json();
            if (data.files && data.files.length > 0) {
                cloudFileId = data.files[0].id;
                localStorage.setItem('schoolDashboardCloudFileId', cloudFileId);
                console.log('Found existing backup file:', cloudFileId);
            } else {
                // No file found in the target folder ‚Äî clear any stale reference
                cloudFileId = null;
                localStorage.removeItem('schoolDashboardCloudFileId');
            }
        }
    } catch (error) {
        console.error('Error finding backup file:', error);
    }
}

// Check cloud file for changes before saving (conflict detection)
async function checkCloudForChanges() {
    if (!cloudFileId || !googleAccessToken) return null;

    try {
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );

        if (response.ok) {
            const backupData = await response.json();
            return {
                savedBy: backupData.savedBy || 'Unknown',
                timestamp: backupData.timestamp
            };
        }
    } catch (error) {
        console.error('Error checking cloud for changes:', error);
    }
    return null;
}

// ============ SAVE TO CLOUD ============
async function saveToCloud() {
    if (!isCloudConnected || !googleAccessToken) {
        alert('Please connect to Google Drive first');
        return;
    }

    const menu = document.getElementById('cloudDropdownMenu');
    menu.classList.remove('show');

    const cloudInfo = await checkCloudForChanges();

    let confirmMessage = 'MULTI-USER CLOUD SYNC\n\n';
    confirmMessage += 'You are about to save to a shared cloud backup.\n\n';

    if (cloudInfo && cloudInfo.savedBy) {
        const cloudTime = new Date(cloudInfo.timestamp);
        const timeSinceLastSave = getTimeAgo(cloudTime);

        const hasConflict = lastSyncTime && cloudTime > lastSyncTime;

        if (hasConflict) {
            confirmMessage += 'WARNING: ' + cloudInfo.savedBy + ' saved changes ' + timeSinceLastSave + '!\n';
            confirmMessage += 'Your local data may not include their changes.\n\n';
            confirmMessage += 'Recommendation: Click Cancel, then "Sync from Cloud" first.\n\n';
        } else {
            confirmMessage += 'Last saved by: ' + cloudInfo.savedBy + ' (' + timeSinceLastSave + ')\n\n';
        }
    }

    confirmMessage += 'This will overwrite the cloud backup. Continue?';

    if (!confirm(confirmMessage)) return;

    setCloudSyncing(true);

    try {
        // Always search the correct folder so a stale cloudFileId from an
        // old/different folder is replaced with the right one.
        await findExistingBackupFile();

        const backupData = {
            version: '1.0',
            timestamp: new Date().toISOString(),
            savedBy: 'Dashboard User',
            data: DATA
        };

        const jsonContent = JSON.stringify(backupData, null, 2);

        let response;

        if (cloudFileId) {
            // Update existing file ‚Äî use multipart/related to update both metadata and content
            const boundary = 'boundary_' + Date.now();
            const updateMetadata = {
                name: GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME
            };

            const multipartBody =
                '--' + boundary + '\r\n' +
                'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                JSON.stringify(updateMetadata) + '\r\n' +
                '--' + boundary + '\r\n' +
                'Content-Type: application/json\r\n\r\n' +
                jsonContent + '\r\n' +
                '--' + boundary + '--';

            response = await fetch(
                `https://www.googleapis.com/upload/drive/v3/files/${cloudFileId}?uploadType=multipart&fields=id,name,parents`,
                {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`,
                        'Content-Type': 'multipart/related; boundary=' + boundary
                    },
                    body: multipartBody
                }
            );

            if (response.ok) {
                // Verify the file is actually in the correct folder
                const result = await response.json();
                const parents = result.parents || [];
                if (!parents.includes(GOOGLE_DRIVE_CONFIG.FOLDER_ID)) {
                    console.warn('File saved to wrong folder. Creating new file in correct folder.');
                    cloudFileId = null;
                    localStorage.removeItem('schoolDashboardCloudFileId');
                }
            }

            // If the file no longer exists, clear the stale reference and create a new one
            if (response.status === 404) {
                console.warn('Stored cloud file not found (deleted?). Creating a new backup file.');
                cloudFileId = null;
                localStorage.removeItem('schoolDashboardCloudFileId');
            }
        }

        if (!cloudFileId) {
            // Create new file in the target folder
            const boundary = 'boundary_' + Date.now();
            const metadata = {
                name: GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME,
                parents: [GOOGLE_DRIVE_CONFIG.FOLDER_ID],
                mimeType: 'application/json'
            };

            const multipartBody =
                '--' + boundary + '\r\n' +
                'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                JSON.stringify(metadata) + '\r\n' +
                '--' + boundary + '\r\n' +
                'Content-Type: application/json\r\n\r\n' +
                jsonContent + '\r\n' +
                '--' + boundary + '--';

            response = await fetch(
                'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,parents',
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`,
                        'Content-Type': 'multipart/related; boundary=' + boundary
                    },
                    body: multipartBody
                }
            );

            if (response.ok) {
                const result = await response.json();
                cloudFileId = result.id;
                localStorage.setItem('schoolDashboardCloudFileId', cloudFileId);
            }
        }

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'Upload failed');
        }

        lastSyncTime = new Date();
        localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
        updateLastSyncDisplay();

        lastSavedBy = 'Dashboard User';
        cloudFileTimestamp = new Date().toISOString();
        updateLastSavedByDisplay();

        setCloudSyncing(false);
        alert('Data saved to Google Drive successfully!\n\nTip: Let other users know to sync from cloud to get your changes.');

    } catch (error) {
        console.error('Error saving to cloud:', error);
        setCloudSyncing(false);

        if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
            alert('Your session has expired. Please reconnect to Google Drive.');
            disconnectFromGoogleDrive();
        } else {
            alert('Failed to save to cloud: ' + error.message);
        }
    }
}

// ============ SYNC FROM CLOUD ============
async function syncFromCloud() {
    if (!isCloudConnected || !googleAccessToken) {
        alert('Please connect to Google Drive first');
        return;
    }

    const menu = document.getElementById('cloudDropdownMenu');
    menu.classList.remove('show');

    if (!cloudFileId) {
        await findExistingBackupFile();
    }

    if (!cloudFileId) {
        alert('No backup file found in Google Drive. Save your data first to create a backup.');
        return;
    }

    if (!confirm('This will replace your local data with the cloud backup. Are you sure you want to continue?')) {
        return;
    }

    setCloudSyncing(true);

    try {
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );

        if (!response.ok) throw new Error('Failed to download backup');

        const backupData = await response.json();

        if (!backupData.data || !backupData.version) {
            throw new Error('Invalid backup file format');
        }

        // Restore data
        DATA = backupData.data;
        saveStore();

        // Update last sync time
        lastSyncTime = new Date();
        localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
        updateLastSyncDisplay();

        // Refresh UI
        renderDashboard();

        setCloudSyncing(false);

        lastSavedBy = backupData.savedBy || 'Unknown';
        cloudFileTimestamp = backupData.timestamp;
        updateLastSavedByDisplay();

        const backupTime = new Date(backupData.timestamp).toLocaleString();
        const savedByInfo = backupData.savedBy ? '\nLast saved by: ' + backupData.savedBy : '';
        alert('Data synced from cloud successfully!\n\nBackup was created: ' + backupTime + savedByInfo);

    } catch (error) {
        console.error('Error syncing from cloud:', error);
        setCloudSyncing(false);

        if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
            alert('Your session has expired. Please reconnect to Google Drive.');
            disconnectFromGoogleDrive();
        } else {
            alert('Failed to sync from cloud: ' + error.message);
        }
    }
}

// ============ MERGE FROM CLOUD ============
async function mergeFromCloud() {
    if (!isCloudConnected || !googleAccessToken) {
        alert('Please connect to Google Drive first');
        return;
    }

    const menu = document.getElementById('cloudDropdownMenu');
    menu.classList.remove('show');

    if (!cloudFileId) {
        await findExistingBackupFile();
    }

    if (!cloudFileId) {
        alert('No backup file found in Google Drive. Save your data first to create a backup.');
        return;
    }

    if (!confirm('MERGE FROM CLOUD\n\nThis will merge cloud data with your local data:\n\n' +
        '- New employees from cloud will be ADDED to your local data\n' +
        '- New payroll runs from cloud will be ADDED\n' +
        '- Existing items will be kept as-is (local version preserved)\n' +
        '- No local data will be removed\n\nContinue?')) {
        return;
    }

    setCloudSyncing(true);

    try {
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );

        if (!response.ok) throw new Error('Failed to download backup');

        const backupData = await response.json();

        if (!backupData.data || !backupData.version) {
            throw new Error('Invalid backup file format');
        }

        let mergeStats = { employeesAdded: 0, payrollRunsAdded: 0, settingsMerged: false };

        // Merge employees - add cloud employees that don't exist locally (match by name, case-insensitive)
        if (backupData.data.employees) {
            const localNames = DATA.employees.map(e => e.name.toLowerCase());
            backupData.data.employees.forEach(cloudEmp => {
                if (!localNames.includes(cloudEmp.name.toLowerCase())) {
                    DATA.employees.push(cloudEmp);
                    mergeStats.employeesAdded++;
                }
            });
        }

        // Merge payroll runs - add cloud runs that don't exist locally (match by date)
        if (backupData.data.payrollRuns) {
            const localDates = DATA.payrollRuns.map(r => r.date);
            backupData.data.payrollRuns.forEach(cloudRun => {
                if (!localDates.includes(cloudRun.date)) {
                    DATA.payrollRuns.push(cloudRun);
                    mergeStats.payrollRunsAdded++;
                }
            });
        }

        // Merge settings - only update if local settings match defaults
        if (backupData.data.settings) {
            const defaults = defaultData().settings;
            const isDefault = DATA.settings.nisEmp === defaults.nisEmp &&
                              DATA.settings.annualThreshold === defaults.annualThreshold &&
                              DATA.employees.length === 0;
            if (isDefault) {
                DATA.settings = backupData.data.settings;
                mergeStats.settingsMerged = true;
            }
        }

        saveStore();

        // Update last sync time
        lastSyncTime = new Date();
        localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
        updateLastSyncDisplay();

        lastSavedBy = backupData.savedBy || 'Unknown';
        cloudFileTimestamp = backupData.timestamp;
        updateLastSavedByDisplay();

        // Refresh UI
        renderDashboard();

        setCloudSyncing(false);

        // Build summary message
        let summary = 'Merge from cloud completed!\n\n';
        summary += 'Merge Summary:\n';
        summary += '- Employees added: ' + mergeStats.employeesAdded + '\n';
        summary += '- Payroll runs added: ' + mergeStats.payrollRunsAdded + '\n';
        summary += '- Settings updated: ' + (mergeStats.settingsMerged ? 'Yes' : 'No (local settings preserved)') + '\n';

        const totalAdded = mergeStats.employeesAdded + mergeStats.payrollRunsAdded;
        if (totalAdded === 0 && !mergeStats.settingsMerged) {
            summary += '\nNo new data found ‚Äî your local data already contains everything from the cloud.';
        } else {
            summary += '\nTip: Save to Cloud to push the merged data back for other users.';
        }

        const savedByInfo = backupData.savedBy ? '\nCloud backup was saved by: ' + backupData.savedBy : '';
        summary += savedByInfo;

        alert(summary);

    } catch (error) {
        console.error('Error merging from cloud:', error);
        setCloudSyncing(false);

        if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
            alert('Your session has expired. Please reconnect to Google Drive.');
            disconnectFromGoogleDrive();
        } else {
            alert('Failed to merge from cloud: ' + error.message);
        }
    }
}

// ============ BROWSE CLOUD FOLDER ============
async function browseCloudFolder() {
    if (!isCloudConnected || !googleAccessToken) {
        alert('Please connect to Google Drive first');
        return;
    }

    const menu = document.getElementById('cloudDropdownMenu');
    menu.classList.remove('show');

    // Show modal with loading state
    const modalHTML = `
        <div id="browseCloudModal" class="browse-cloud-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìÇ Cloud Folder ‚Äî All Backups</h2>
                    <button class="close-btn" onclick="closeBrowseCloudModal()">&times;</button>
                </div>
                <div class="browse-body" id="browseCloudBody">
                    <div class="browse-loading">
                        <span style="font-size:1.5rem;display:block;margin-bottom:0.5rem;">‚òÅÔ∏è</span>
                        Loading files from Google Drive...
                    </div>
                </div>
            </div>
        </div>`;

    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Fetch files from the folder
    try {
        const query = `'${GOOGLE_DRIVE_CONFIG.FOLDER_ID}' in parents and trashed=false`;
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,size,modifiedTime,mimeType,createdTime)&orderBy=modifiedTime desc&pageSize=50`,
            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );

        if (!response.ok) {
            if (response.status === 401) {
                throw new Error('Session expired. Please reconnect to Google Drive.');
            }
            throw new Error('Failed to list files (HTTP ' + response.status + ')');
        }

        const data = await response.json();
        const body = document.getElementById('browseCloudBody');

        if (!data.files || data.files.length === 0) {
            body.innerHTML = `
                <div class="browse-empty">
                    <span style="font-size:2rem;display:block;margin-bottom:0.5rem;">üì≠</span>
                    No files found in the cloud folder.<br>
                    <span style="font-size:0.8rem;color:var(--text-muted);">Use "Save to Cloud" to create your first backup.</span>
                </div>`;
            return;
        }

        let listHTML = '<ul class="browse-file-list">';
        data.files.forEach(file => {
            const modified = new Date(file.modifiedTime);
            const timeAgo = getTimeAgo(modified);
            const dateStr = modified.toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' });
            const timeStr = modified.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit' });
            const sizeStr = file.size ? formatFileSize(parseInt(file.size)) : '--';
            const isBackup = file.name === GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME;
            const icon = isBackup ? '‚≠ê' : (file.mimeType === 'application/json' ? 'üìÑ' : 'üìé');

            listHTML += `
                <li class="browse-file-item" ${isBackup ? 'style="border-color:var(--accent);background:rgba(245,158,11,0.05);"' : ''}>
                    <div class="browse-file-info">
                        <span class="browse-file-icon">${icon}</span>
                        <div class="browse-file-details">
                            <div class="browse-file-name">${file.name}${isBackup ? ' <span style="font-size:0.65rem;background:var(--accent);color:#000;padding:1px 6px;border-radius:3px;font-weight:700;margin-left:4px;">ACTIVE</span>' : ''}</div>
                            <div class="browse-file-meta">${dateStr} at ${timeStr} ¬∑ ${timeAgo} ¬∑ ${sizeStr}</div>
                        </div>
                    </div>
                    <div class="browse-file-actions">
                        <button class="btn-browse-download" onclick="downloadCloudFile('${file.id}', '${file.name.replace(/'/g, "\\'")}')">‚¨á Download</button>
                        ${!isBackup ? '<button class="btn-browse-delete" onclick="deleteCloudFile(\'' + file.id + '\', \'' + file.name.replace(/'/g, "\\'") + '\')">üóë</button>' : ''}
                    </div>
                </li>`;
        });
        listHTML += '</ul>';

        listHTML += `<a class="browse-folder-link" href="https://drive.google.com/drive/folders/${GOOGLE_DRIVE_CONFIG.FOLDER_ID}" target="_blank" rel="noopener">
            üîó Open folder in Google Drive
        </a>`;

        body.innerHTML = listHTML;

    } catch (error) {
        console.error('Error browsing cloud folder:', error);
        const body = document.getElementById('browseCloudBody');
        if (body) {
            body.innerHTML = `
                <div class="browse-empty" style="color:var(--danger);">
                    <span style="font-size:2rem;display:block;margin-bottom:0.5rem;">‚ö†Ô∏è</span>
                    ${error.message}
                </div>`;
        }

        if (error.message.includes('Session expired') || error.message.includes('invalid_token')) {
            disconnectFromGoogleDrive();
        }
    }
}

function closeBrowseCloudModal() {
    const modal = document.getElementById('browseCloudModal');
    if (modal) modal.remove();
}

async function downloadCloudFile(fileId, fileName) {
    try {
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );

        if (!response.ok) throw new Error('Download failed');

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error('Error downloading file:', error);
        alert('Failed to download file: ' + error.message);
    }
}

async function deleteCloudFile(fileId, fileName) {
    if (!confirm('Delete "' + fileName + '" from cloud?\n\nThis cannot be undone.')) return;

    try {
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileId}`,
            {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${googleAccessToken}` }
            }
        );

        if (!response.ok) throw new Error('Delete failed');

        alert('"' + fileName + '" has been deleted.');
        closeBrowseCloudModal();
        browseCloudFolder();
    } catch (error) {
        console.error('Error deleting file:', error);
        alert('Failed to delete file: ' + error.message);
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const units = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return (bytes / Math.pow(1024, i)).toFixed(i > 0 ? 1 : 0) + ' ' + units[i];
}

// ============ HELPER FUNCTIONS ============
function updateLastSyncDisplay() {
    const lastSyncInfo = document.getElementById('lastSyncInfo');
    const sidebarSync = document.getElementById('sidebarSyncInfo');
    const syncText = lastSyncTime ? 'Last sync: ' + getTimeAgo(lastSyncTime) : 'Last sync: Never';
    if (lastSyncInfo) lastSyncInfo.textContent = syncText;
    if (sidebarSync) sidebarSync.textContent = syncText;
}

function updateLastSavedByDisplay() {
    const lastSavedByInfo = document.getElementById('lastSavedByInfo');
    if (lastSavedByInfo) {
        if (lastSavedBy && cloudFileTimestamp) {
            lastSavedByInfo.textContent = 'Last saved by: ' + lastSavedBy + ' (' + getTimeAgo(new Date(cloudFileTimestamp)) + ')';
        } else if (lastSavedBy) {
            lastSavedByInfo.textContent = 'Last saved by: ' + lastSavedBy;
        } else {
            lastSavedByInfo.textContent = 'Last saved by: --';
        }
    }
}

function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return diffMins + ' min' + (diffMins > 1 ? 's' : '') + ' ago';
    if (diffHours < 24) return diffHours + ' hour' + (diffHours > 1 ? 's' : '') + ' ago';
    return diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ago';
}

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded',function(){
    renderDashboard();
    initializeCloudSync();
    setTimeout(function(){ initGoogleAuth(); }, 500);
});
</script>
</body>
</html>
