<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>C.E.S.T.I.S - Payroll Management System</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<!-- OTPAuth library for TOTP (2FA) -->
<script src="https://cdn.jsdelivr.net/npm/otpauth@9.2.1/dist/otpauth.umd.min.js"></script>
<!-- QRCode library for generating QR codes -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<!-- Google Identity Services for OAuth -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<!-- EmailJS SDK for sending OTP emails -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
    // Initialize EmailJS with public key
    (function() {
        if (typeof emailjs !== 'undefined') {
            emailjs.init('z_6Ya8J_WGJjRIGuX');
        }
    })();
</script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#0c1220;--surface:#141c2e;--card:#1a2540;--border:#253354;
--primary:#3b82f6;--primary-glow:rgba(59,130,246,.15);
--accent:#f59e0b;--accent2:#10b981;--danger:#ef4444;
--text:#e2e8f0;--text-dim:#94a3b8;--text-muted:#64748b;
--gold:#f59e0b;--green:#10b981;--red:#ef4444;
}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.app{display:flex;min-height:100vh}

/* Sidebar */
.sidebar{width:240px;background:var(--surface);border-right:1px solid var(--border);padding:1rem 0;display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100}
.sidebar-brand{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);margin-bottom:.5rem}
.sidebar-brand h1{font-size:.85rem;font-weight:700;color:var(--accent);letter-spacing:2px;text-transform:uppercase}
.sidebar-brand p{font-size:.7rem;color:var(--text-dim);margin-top:.25rem;letter-spacing:.5px}
.sidebar-nav{flex:1;padding:.5rem}
.nav-item{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;border-radius:8px;cursor:pointer;color:var(--text-dim);font-size:.85rem;font-weight:500;transition:all .2s;margin-bottom:2px}
.nav-item:hover{background:var(--primary-glow);color:var(--text)}
.nav-item.active{background:var(--primary);color:#fff;box-shadow:0 4px 12px rgba(59,130,246,.3)}
.nav-item .icon{font-size:1.1rem;width:20px;text-align:center}
.sidebar-footer{padding:1rem 1.5rem;border-top:1px solid var(--border);font-size:.7rem;color:var(--text-muted)}

/* Main Content */
.main{margin-left:240px;flex:1;padding:1.5rem 2rem}
.page{display:none}
.page.active{display:block}

/* Header Bar */
.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
.page-header h2{font-size:1.35rem;font-weight:700;color:var(--text)}
.page-header .subtitle{font-size:.8rem;color:var(--text-dim);margin-top:.15rem}

/* Cards */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.25rem;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.stat-card.blue::before{background:var(--primary)}
.stat-card.gold::before{background:var(--gold)}
.stat-card.green::before{background:var(--green)}
.stat-card.red::before{background:var(--red)}
.stat-card .label{font-size:.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;font-weight:600}
.stat-card .value{font-size:1.5rem;font-weight:700;margin-top:.35rem;font-family:'JetBrains Mono',monospace}
.stat-card .sub{font-size:.7rem;color:var(--text-dim);margin-top:.25rem}

/* Panels */
.panel{background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:1.5rem;overflow:hidden}
.panel-head{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;border-bottom:1px solid var(--border)}
.panel-head h3{font-size:.95rem;font-weight:600}
.panel-body{padding:1.25rem}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:.4rem;padding:.5rem 1rem;border:none;border-radius:6px;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .15s}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:hover{background:#2563eb;box-shadow:0 4px 12px rgba(59,130,246,.3)}
.btn-success{background:var(--green);color:#fff}
.btn-success:hover{background:#059669}
.btn-warning{background:var(--gold);color:#000}
.btn-danger{background:var(--red);color:#fff}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text-dim)}
.btn-ghost:hover{border-color:var(--primary);color:var(--primary)}
.btn-sm{padding:.35rem .75rem;font-size:.75rem}
.btn-group{display:flex;gap:.5rem;flex-wrap:wrap}

/* Tables */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:.65rem .75rem;font-size:.7rem;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);background:rgba(0,0,0,.2);white-space:nowrap}
td{padding:.6rem .75rem;font-size:.82rem;border-bottom:1px solid rgba(37,51,84,.5);white-space:nowrap}
tr:hover td{background:rgba(59,130,246,.04)}
.mono{font-family:'JetBrains Mono',monospace;font-size:.78rem}
.text-right{text-align:right}
.text-center{text-align:center}
.tag{display:inline-block;padding:.15rem .5rem;border-radius:4px;font-size:.7rem;font-weight:600}
.tag-ft{background:rgba(59,130,246,.15);color:#60a5fa}
.tag-pt{background:rgba(245,158,11,.15);color:#fbbf24}

/* Forms */
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem}
.form-group{display:flex;flex-direction:column;gap:.3rem}
.form-group label{font-size:.75rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.3px}
.form-group input,.form-group select,.form-group textarea{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:.55rem .75rem;color:var(--text);font-family:inherit;font-size:.85rem}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}
.form-group input[type="number"]{font-family:'JetBrains Mono',monospace}

/* Modal */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:500;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-radius:14px;width:90%;max-width:600px;max-height:85vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:1.25rem 1.5rem;border-bottom:1px solid var(--border)}
.modal-header h3{font-size:1rem;font-weight:600}
.modal-close{background:none;border:none;color:var(--text-dim);font-size:1.3rem;cursor:pointer}
.modal-body{padding:1.5rem}
.modal-footer{padding:1rem 1.5rem;border-top:1px solid var(--border);display:flex;gap:.5rem;justify-content:flex-end}

/* Payslip Print */
.payslip-container{display:none}
@media print{
  @page{size:A4 portrait;margin:8mm 10mm}
  html,body{margin:0!important;padding:0!important;height:auto!important;overflow:visible!important}
  body *{visibility:hidden;margin:0;padding:0}
  .payslip-container,.payslip-container *{visibility:visible!important}
  .payslip-container{display:block!important;position:absolute;top:0;left:0;width:100%;background:#fff;z-index:9999;margin:0;padding:0;overflow:hidden}
  .payslip-print{padding:0!important;margin:0!important;max-width:100%!important;page-break-inside:avoid;break-inside:avoid}
  .payslip-print .ps-header{padding-bottom:.4rem;margin-bottom:.5rem}
  .payslip-print .ps-header p{margin-top:.1rem!important;margin-bottom:.1rem!important;font-size:.75rem!important}
  .payslip-print .ps-info{gap:.15rem;margin-bottom:.5rem;font-size:.72rem}
  .payslip-print .ps-info .lbl{min-width:90px}
  .payslip-print .ps-table{margin-bottom:.4rem}
  .payslip-print .ps-table th{padding:.25rem .4rem;font-size:.65rem}
  .payslip-print .ps-table td{padding:.2rem .4rem;font-size:.72rem}
  .payslip-print .ps-table .amt{font-size:.7rem}
  .payslip-print .ps-totals{gap:.5rem;margin-top:.5rem;padding-top:.4rem}
  .payslip-print .ps-totals .box{padding:.35rem}
  .payslip-print .ps-totals .box .lbl{font-size:.6rem}
  .payslip-print .ps-totals .box .val{font-size:.85rem;margin-top:.1rem}
  .payslip-print .ps-footer{margin-top:.5rem;padding-top:.3rem;font-size:.6rem}
}
.payslip-print{background:#fff;color:#000;padding:2rem;max-width:700px;margin:0 auto;font-family:'DM Sans',sans-serif}
.payslip-print .ps-header{text-align:center;border-bottom:3px solid #1a2540;padding-bottom:1rem;margin-bottom:1.5rem}
.payslip-print .ps-header h2{font-size:1.1rem;color:#1a2540;letter-spacing:2px}
.payslip-print .ps-header p{font-size:.8rem;color:#666;margin-top:.25rem}
.payslip-print .ps-info{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:1.5rem;font-size:.82rem}
.payslip-print .ps-info .row{display:flex;gap:.5rem}
.payslip-print .ps-info .lbl{font-weight:700;color:#333;min-width:110px}
.payslip-print .ps-info .val{color:#555}
.payslip-print .ps-table{width:100%;border-collapse:collapse;margin-bottom:1.5rem}
.payslip-print .ps-table th{background:#1a2540;color:#fff;padding:.5rem .75rem;font-size:.75rem;text-transform:uppercase;letter-spacing:.5px;text-align:left}
.payslip-print .ps-table td{padding:.45rem .75rem;border-bottom:1px solid #e5e7eb;font-size:.82rem}
.payslip-print .ps-table .amt{font-family:'JetBrains Mono',monospace;text-align:right;font-size:.8rem}
.payslip-print .ps-totals{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;margin-top:1.5rem;padding-top:1rem;border-top:2px solid #1a2540}
.payslip-print .ps-totals .box{text-align:center;padding:.75rem;border:1px solid #e5e7eb;border-radius:6px}
.payslip-print .ps-totals .box .lbl{font-size:.7rem;color:#666;text-transform:uppercase;font-weight:600}
.payslip-print .ps-totals .box .val{font-size:1.1rem;font-weight:700;color:#1a2540;font-family:'JetBrains Mono',monospace;margin-top:.25rem}
.payslip-print .ps-footer{margin-top:2rem;padding-top:1rem;border-top:1px solid #e5e7eb;font-size:.7rem;color:#999;text-align:center}

/* Payslip Preview (on screen) */
.payslip-preview{background:#fff;color:#000;padding:2rem;border-radius:10px;max-width:700px;margin:1rem auto}
.payslip-preview .ps-header{text-align:center;border-bottom:3px solid #1a2540;padding-bottom:1rem;margin-bottom:1.5rem}
.payslip-preview .ps-header h2{font-size:1.1rem;color:#1a2540;letter-spacing:2px}
.payslip-preview .ps-header p{font-size:.8rem;color:#666;margin-top:.25rem}
.payslip-preview .ps-info{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:1.5rem;font-size:.82rem}
.payslip-preview .ps-info .row{display:flex;gap:.5rem}
.payslip-preview .ps-info .lbl{font-weight:700;color:#333;min-width:110px}
.payslip-preview .ps-info .val{color:#555}
.payslip-preview .ps-table{width:100%;border-collapse:collapse;margin-bottom:1.5rem}
.payslip-preview .ps-table th{background:#1a2540;color:#fff;padding:.5rem .75rem;font-size:.75rem;text-transform:uppercase;letter-spacing:.5px;text-align:left}
.payslip-preview .ps-table td{padding:.45rem .75rem;border-bottom:1px solid #e5e7eb;font-size:.82rem}
.payslip-preview .ps-table .amt{font-family:'JetBrains Mono',monospace;text-align:right;font-size:.8rem}
.payslip-preview .ps-totals{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;margin-top:1.5rem;padding-top:1rem;border-top:2px solid #1a2540}
.payslip-preview .ps-totals .box{text-align:center;padding:.75rem;border:1px solid #e5e7eb;border-radius:6px}
.payslip-preview .ps-totals .box .lbl{font-size:.7rem;color:#666;text-transform:uppercase;font-weight:600}
.payslip-preview .ps-totals .box .val{font-size:1.1rem;font-weight:700;color:#1a2540;font-family:'JetBrains Mono',monospace;margin-top:.25rem}
.payslip-preview .ps-footer{margin-top:2rem;padding-top:1rem;border-top:1px solid #e5e7eb;font-size:.7rem;color:#999;text-align:center}

/* Quarter Navigation Bar */
.quarter-nav{display:flex;align-items:center;gap:.75rem;margin-bottom:1.25rem;flex-wrap:wrap}
.fy-selector{display:flex;align-items:center;gap:0;background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden}
.fy-arrow{background:none;border:none;color:var(--text-dim);font-size:1rem;padding:.5rem .7rem;cursor:pointer;font-family:inherit;transition:all .15s;line-height:1}
.fy-arrow:hover{background:var(--primary-glow);color:var(--primary)}
.fy-label{padding:.45rem .9rem;font-size:.85rem;font-weight:700;color:var(--accent);letter-spacing:.5px;white-space:nowrap;border-left:1px solid var(--border);border-right:1px solid var(--border);user-select:none}
.quarter-tabs{display:flex;gap:0;border-radius:8px;overflow:hidden;border:1px solid var(--border)}
.quarter-tab{padding:.55rem 1.1rem;background:var(--surface);color:var(--text-dim);font-size:.8rem;font-weight:600;cursor:pointer;border:none;font-family:inherit;transition:all .2s;position:relative;white-space:nowrap}
.quarter-tab:not(:last-child){border-right:1px solid var(--border)}
.quarter-tab:hover{background:var(--primary-glow);color:var(--text)}
.quarter-tab.active{background:var(--primary);color:#fff;box-shadow:0 2px 8px rgba(59,130,246,.3)}
.quarter-tab .q-sub{font-weight:400;opacity:.7;margin-left:.3rem;font-size:.72rem}
.quarter-tab.active .q-sub{opacity:.85}
.qtr-nav-btns{display:flex;gap:.4rem;margin-left:auto}
.qtr-nav-btn{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:.45rem .85rem;color:var(--text-dim);font-size:.78rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s;white-space:nowrap}
.qtr-nav-btn:hover{background:var(--primary-glow);border-color:var(--primary);color:var(--primary)}

/* Month Cards */
.month-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin-bottom:1.25rem}
.month-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:.85rem 1rem;cursor:pointer;transition:all .2s;text-align:center;position:relative}
.month-card:hover{border-color:var(--primary);background:var(--primary-glow)}
.month-card.active{border-color:var(--primary);background:var(--primary-glow);box-shadow:0 0 0 2px rgba(59,130,246,.2)}
.month-card.completed{border-color:var(--green)}
.month-card.completed::after{content:'';position:absolute;top:6px;right:6px;width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 4px var(--green)}
.month-card .month-name{font-size:.85rem;font-weight:600;color:var(--text)}
.month-card .month-status{font-size:.7rem;color:var(--text-muted);margin-top:.2rem}
.month-card.completed .month-status{color:var(--green)}
.month-card.active .month-name{color:var(--primary)}

/* Quarter Summary Stats */
.quarter-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.75rem;margin-bottom:1.25rem}
.quarter-stat{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:.75rem 1rem;text-align:center}
.quarter-stat .qs-label{font-size:.65rem;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);font-weight:600}
.quarter-stat .qs-value{font-size:1.1rem;font-weight:700;font-family:'JetBrains Mono',monospace;margin-top:.2rem}

/* Quarter History */
.payslip-link{color:var(--primary);cursor:pointer;font-size:.78rem;font-weight:600;text-decoration:none;transition:color .15s}
.payslip-link:hover{color:#60a5fa;text-decoration:underline}

/* Salary Records */
#salaryRecordsTable table{min-width:1100px}
#salaryRecordsTable th,#salaryRecordsTable td{padding:.45rem .5rem;font-size:.75rem}
#quarterlyTable table{min-width:1000px}
#empQuarterlyTable table{min-width:900px}

/* Scrollbar */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--surface)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--text-muted)}

/* ===== LOGIN SCREEN ===== */
.login-screen{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center;font-family:'DM Sans',sans-serif;overflow-y:auto;padding:2rem 1rem}
.login-screen.hidden{display:none}
.hidden{display:none!important}
#dashboardContainer.visible{display:flex!important}
.settings-btn.hidden{display:none!important}
.login-wrapper{width:100%;max-width:420px;display:flex;flex-direction:column;gap:1.25rem}
.login-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:2.5rem;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.4);position:relative}
.login-brand{text-align:center;margin-bottom:2rem}
.login-brand h1{font-size:1.6rem;font-weight:700;color:var(--accent);letter-spacing:3px;margin-bottom:.25rem}
.login-brand p{font-size:.8rem;color:var(--text-dim)}
.login-card .form-group{margin-bottom:1rem}
.login-card .form-group label{font-size:.75rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.3px;margin-bottom:.3rem;display:block}
.login-card .form-group input{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:.7rem .9rem;color:var(--text);font-family:inherit;font-size:.9rem}
.login-card .form-group input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}
.login-btn{width:100%;padding:.75rem;background:var(--primary);color:#fff;border:none;border-radius:8px;font-size:.9rem;font-weight:600;cursor:pointer;transition:all .15s;margin-top:.5rem}
.login-btn:hover{filter:brightness(1.15);transform:translateY(-1px)}
.login-btn:active{transform:translateY(0)}
.login-error{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3);color:#f87171;padding:.6rem .8rem;border-radius:8px;font-size:.8rem;margin-bottom:1rem;display:none}
.login-error.show{display:block}
.login-syncing-overlay{position:absolute;inset:0;background:rgba(17,17,21,.85);border-radius:16px;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;gap:.75rem;display:none}
.login-syncing-overlay.show{display:flex}
.login-syncing-spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.login-syncing-text{color:var(--text-dim);font-size:.82rem;font-weight:600;text-align:center}
.login-syncing-sub{color:var(--text-muted);font-size:.72rem;text-align:center;max-width:260px}
.login-cloud-banner{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:.5rem .75rem;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem;font-size:.75rem;transition:all .3s}
.login-cloud-banner.synced{border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.06)}
.login-cloud-banner.syncing{border-color:rgba(99,102,241,.3);background:rgba(99,102,241,.06)}
.login-cloud-banner.error{border-color:rgba(239,68,68,.2);background:rgba(239,68,68,.06)}
.login-cloud-banner .banner-icon{font-size:.9rem;flex-shrink:0}
.login-cloud-banner .banner-text{color:var(--text-dim);flex:1;line-height:1.3}
.login-cloud-banner .banner-text strong{color:var(--text);font-weight:600}
.login-user-info{text-align:center;margin-top:1.25rem;padding-top:1rem;border-top:1px solid var(--border)}
.login-user-info span{font-size:.75rem;color:var(--text-muted)}

/* First Time Here? Section */
.first-time-section{width:100%}
.first-time-heading{text-align:center;font-size:.8rem;color:var(--text-muted);margin-bottom:.75rem;font-weight:600;letter-spacing:.5px;text-transform:uppercase;display:flex;align-items:center;gap:.75rem}
.first-time-heading::before,.first-time-heading::after{content:'';flex:1;height:1px;background:var(--border)}
.first-time-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1.5rem;width:100%;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,.25);transition:all .3s}
.first-time-card.connecting{border-color:rgba(59,130,246,.4)}
.first-time-card.syncing{border-color:rgba(99,102,241,.4)}
.first-time-card.synced{border-color:rgba(34,197,94,.4);background:rgba(34,197,94,.03)}
.first-time-card.error{border-color:rgba(239,68,68,.3)}
.ft-cloud-icon{font-size:2.2rem;margin-bottom:.75rem;display:block}
.ft-title{font-size:1rem;font-weight:700;color:var(--text);margin-bottom:.35rem}
.ft-desc{font-size:.78rem;color:var(--text-dim);line-height:1.4;margin-bottom:1rem;max-width:320px;margin-left:auto;margin-right:auto}
.ft-sync-btn{display:inline-flex;align-items:center;gap:.5rem;padding:.7rem 1.5rem;background:var(--primary);color:#fff;border:none;border-radius:10px;font-family:inherit;font-size:.88rem;font-weight:600;cursor:pointer;transition:all .2s;box-shadow:0 4px 15px rgba(59,130,246,.3)}
.ft-sync-btn:hover{filter:brightness(1.15);transform:translateY(-1px);box-shadow:0 6px 20px rgba(59,130,246,.4)}
.ft-sync-btn:active{transform:translateY(0)}
.ft-sync-btn:disabled{opacity:.6;cursor:not-allowed;transform:none;filter:none}
.ft-sync-btn .ft-btn-spinner{display:none;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite}
.ft-sync-btn.loading .ft-btn-spinner{display:inline-block}
.ft-sync-btn.loading .ft-btn-icon{display:none}
.ft-status{margin-top:.75rem;font-size:.78rem;color:var(--text-dim);min-height:1.2em;transition:all .3s}
.ft-status.success{color:var(--green)}
.ft-status.error{color:var(--danger)}
.ft-status.info{color:var(--primary)}
.ft-skip{display:block;text-align:center;margin-top:.75rem;font-size:.75rem;color:var(--text-muted);cursor:pointer;background:none;border:none;font-family:inherit;transition:color .15s;text-decoration:none}
.ft-skip:hover{color:var(--text-dim);text-decoration:underline}
.ft-google-account{display:flex;align-items:center;gap:.6rem;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:.5rem .75rem;margin-top:.75rem;font-size:.78rem;text-align:left}
.ft-google-account .ft-avatar{width:28px;height:28px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.75rem;flex-shrink:0}
.ft-google-account .ft-account-info{flex:1;min-width:0}
.ft-google-account .ft-account-name{font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ft-google-account .ft-account-email{color:var(--text-muted);font-size:.72rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* User badge in sidebar */
.sidebar-user{padding:.6rem 1rem;margin:.25rem .5rem;background:var(--surface);border-radius:8px;display:flex;align-items:center;gap:.6rem;cursor:default}
.sidebar-user .user-avatar{width:28px;height:28px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;color:#fff;flex-shrink:0}
.sidebar-user .user-details{flex:1;min-width:0}
.sidebar-user .user-name{font-size:.78rem;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sidebar-user .user-role{font-size:.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px}
.sidebar-user .logout-btn{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:.9rem;padding:.15rem;transition:color .15s}
.sidebar-user .logout-btn:hover{color:var(--danger)}

/* Permission banner */
.perm-banner{background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.25);border-radius:10px;padding:.7rem 1rem;margin-bottom:1rem;display:flex;align-items:center;justify-content:space-between;font-size:.82rem}
.perm-banner.granted{background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.3)}
.perm-banner.expired{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.3)}
.perm-banner .perm-timer{font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--primary);font-size:.85rem}
.perm-banner.granted .perm-timer{color:var(--green)}
.perm-banner.expired .perm-timer{color:var(--danger)}

/* Permission request cards */
.perm-request-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem 1.25rem;margin-bottom:.75rem;transition:border-color .2s}
.perm-request-card:hover{border-color:var(--primary)}
.perm-request-card .req-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
.perm-request-card .req-user{font-weight:600;color:var(--text);font-size:.9rem}
.perm-request-card .req-time{font-size:.72rem;color:var(--text-muted)}
.perm-request-card .req-reason{font-size:.82rem;color:var(--text-dim);margin-bottom:.75rem;line-height:1.4}
.perm-request-card .req-status{display:inline-block;padding:.2rem .6rem;border-radius:4px;font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.3px}
.perm-request-card .req-status.pending{background:rgba(245,158,11,.15);color:#fbbf24}
.perm-request-card .req-status.approved{background:rgba(16,185,129,.15);color:#34d399}
.perm-request-card .req-status.denied{background:rgba(239,68,68,.15);color:#f87171}
.perm-request-card .req-status.expired{background:rgba(100,116,139,.15);color:#94a3b8}
.perm-request-card .req-actions{display:flex;gap:.5rem;margin-top:.75rem}

/* Role tags */
.role-tag{display:inline-block;padding:.15rem .5rem;border-radius:4px;font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.3px}
.role-tag.admin{background:rgba(239,68,68,.15);color:#f87171}
.role-tag.user{background:rgba(59,130,246,.15);color:#60a5fa}
.role-tag.viewer{background:rgba(100,116,139,.15);color:#94a3b8}

/* Notification badge */
.notif-badge{position:absolute;top:-4px;right:-4px;background:var(--danger);color:#fff;font-size:.6rem;font-weight:700;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;line-height:1}
.nav-item{position:relative}

/* Responsive */
@media(max-width:768px){
  .sidebar{width:60px}
  .sidebar .nav-text,.sidebar-brand p,.sidebar-footer{display:none}
  .sidebar-brand h1{font-size:.6rem;text-align:center}
  .main{margin-left:60px;padding:1rem}
  .nav-item{justify-content:center;padding:.75rem}
  .stats-row{grid-template-columns:1fr 1fr}
}

/* Cloud Sync Section */
.cloud-section-label{font-size:.65rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:.5rem}
.cloud-status-row{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem;padding:.35rem .5rem;background:var(--surface);border-radius:6px}
.cloud-status-dot{width:10px;height:10px;border-radius:50%;background:var(--text-muted);display:inline-block;flex-shrink:0}
.cloud-status-dot.disconnected{background:var(--red)}
.cloud-status-dot.connected{background:var(--green);box-shadow:0 0 6px var(--green)}
.cloud-status-dot.syncing{background:var(--gold);animation:pulse 1s infinite;box-shadow:0 0 6px var(--gold)}
.cloud-status-label{font-size:.75rem;font-weight:600}
.cloud-status-label.connected{color:var(--green)}
.cloud-status-label.disconnected{color:var(--red)}
.cloud-status-label.syncing{color:var(--gold)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.spinning{display:inline-block;animation:spin 1s linear infinite}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

/* Cloud Sync Button */
.cloud-sync-btn{display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;font-family:inherit;font-size:0.75rem;font-weight:500;transition:all 0.2s;width:100%}
.cloud-sync-btn:hover{background:var(--primary-glow);border-color:var(--primary)}
.cloud-sync-btn .btn-arrow{margin-left:auto;font-size:0.6rem;color:var(--text-muted)}

/* Cloud Sync Info below button */
.cloud-sync-meta{font-size:.65rem;color:var(--text-muted);margin-top:.4rem;padding:0 .25rem;line-height:1.4}

/* Cloud Dropdown */
.cloud-dropdown{position:relative;display:block;width:100%}
.cloud-dropdown-content{display:none;position:absolute;left:0;bottom:100%;background:var(--card);min-width:220px;box-shadow:0 -8px 30px rgba(0,0,0,0.4);border-radius:10px;z-index:1000;overflow:hidden;margin-bottom:6px;border:1px solid var(--border)}
.cloud-dropdown-content.show{display:block}
.cloud-dropdown-item{padding:10px 14px;display:flex;align-items:center;gap:10px;cursor:pointer;font-size:0.8rem;font-weight:600;color:#fff;transition:all 0.2s;border-radius:0}
.cloud-dropdown-item:hover{filter:brightness(1.15)}
.cloud-dropdown-item.save-cloud{background:linear-gradient(135deg,#ec4899,#f43f5e)}
.cloud-dropdown-item.sync-cloud{background:linear-gradient(135deg,#10b981,#14b8a6)}
.cloud-dropdown-item.merge-cloud{background:linear-gradient(135deg,#3b82f6,#8b5cf6)}
.cloud-dropdown-item.browse-cloud{background:var(--surface);color:var(--text);font-weight:500}
.cloud-dropdown-item.browse-cloud:hover{background:var(--primary-glow)}
.cloud-dropdown-item.danger{background:none;color:var(--danger);font-weight:500}
.cloud-dropdown-item.danger:hover{background:rgba(239,68,68,0.1)}
.cloud-dropdown-divider{height:1px;background:var(--border);margin:2px 0}
.last-sync-info{padding:6px 14px;font-size:0.7rem;color:var(--text-muted)}

/* Google Auth Modal */
.google-auth-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;backdrop-filter:blur(4px)}
.google-auth-modal .modal-content{background:var(--card);border:1px solid var(--border);border-radius:14px;width:90%;max-width:560px;max-height:85vh;overflow-y:auto}
.google-auth-modal .modal-header{display:flex;justify-content:space-between;align-items:center;padding:1.25rem 1.5rem;border-bottom:1px solid var(--border)}
.google-auth-modal .modal-header h2{font-size:1rem;font-weight:600;color:var(--text)}
.google-auth-modal .close-btn{background:none;border:none;color:var(--text-dim);font-size:1.3rem;cursor:pointer}
.google-auth-modal .form-group label{font-weight:600;color:var(--text-dim);font-size:0.8rem}
.google-auth-modal .form-group textarea{background:var(--surface);border:2px solid var(--border);border-radius:6px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.75rem}
.google-auth-modal .form-group textarea:focus{outline:none;border-color:var(--primary)}
.google-auth-modal .btn-secondary{background:var(--surface);border:1px solid var(--border);color:var(--text-dim);display:inline-flex;align-items:center;gap:.4rem;padding:.5rem 1rem;border-radius:6px;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .15s}
.google-auth-modal .btn-secondary:hover{border-color:var(--primary);color:var(--primary)}

/* Browse Cloud Folder Modal */
.browse-cloud-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;backdrop-filter:blur(4px)}
.browse-cloud-modal .modal-content{background:var(--card);border:1px solid var(--border);border-radius:14px;width:90%;max-width:640px;max-height:85vh;overflow-y:auto}
.browse-cloud-modal .modal-header{display:flex;justify-content:space-between;align-items:center;padding:1.25rem 1.5rem;border-bottom:1px solid var(--border)}
.browse-cloud-modal .modal-header h2{font-size:1rem;font-weight:600;color:var(--text)}
.browse-cloud-modal .close-btn{background:none;border:none;color:var(--text-dim);font-size:1.3rem;cursor:pointer}
.browse-cloud-modal .browse-body{padding:1.25rem 1.5rem}
.browse-cloud-modal .browse-loading{text-align:center;padding:2rem;color:var(--text-dim);font-size:0.9rem}
.browse-cloud-modal .browse-empty{text-align:center;padding:2rem;color:var(--text-muted);font-size:0.85rem}
.browse-file-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px}
.browse-file-item{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;transition:all 0.2s}
.browse-file-item:hover{border-color:var(--primary);background:rgba(59,130,246,0.05)}
.browse-file-info{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
.browse-file-icon{font-size:1.3rem;flex-shrink:0}
.browse-file-details{min-width:0}
.browse-file-name{font-size:0.85rem;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.browse-file-meta{font-size:0.7rem;color:var(--text-muted);margin-top:2px}
.browse-file-actions{display:flex;gap:6px;flex-shrink:0}
.browse-file-actions button{padding:5px 10px;font-size:0.7rem;font-weight:600;border-radius:6px;border:none;cursor:pointer;font-family:inherit;transition:all 0.15s}
.btn-browse-open{background:var(--primary);color:#fff}
.btn-browse-open:hover{filter:brightness(1.15)}
.btn-browse-download{background:var(--surface);color:var(--text-dim);border:1px solid var(--border) !important}
.btn-browse-download:hover{border-color:var(--primary) !important;color:var(--primary)}
.btn-browse-delete{background:rgba(239,68,68,0.1);color:var(--danger)}
.btn-browse-delete:hover{background:rgba(239,68,68,0.2)}
.browse-folder-link{display:inline-flex;align-items:center;gap:6px;margin-top:1rem;padding:8px 14px;font-size:0.8rem;font-weight:600;color:var(--primary);background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:8px;text-decoration:none;transition:all 0.15s}
.browse-folder-link:hover{background:rgba(59,130,246,0.15);border-color:var(--primary)}

/* Cloud Sync Notification Popup */
.cloud-notify{position:fixed;top:1.25rem;right:1.25rem;z-index:9999;width:370px;max-width:calc(100vw - 2rem);background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,.45);transform:translateX(120%);transition:transform .4s cubic-bezier(.22,1,.36,1);overflow:hidden}
.cloud-notify.show{transform:translateX(0)}
.cloud-notify.warn{border-color:var(--gold)}
.cloud-notify.error{border-color:var(--danger)}
.cloud-notify-bar{height:4px;width:100%}
.cloud-notify.warn .cloud-notify-bar{background:var(--gold)}
.cloud-notify.error .cloud-notify-bar{background:var(--danger)}
.cloud-notify-body{padding:1rem 1.25rem;display:flex;gap:.75rem;align-items:flex-start}
.cloud-notify-icon{font-size:1.6rem;flex-shrink:0;line-height:1}
.cloud-notify-content{flex:1;min-width:0}
.cloud-notify-title{font-size:.9rem;font-weight:700;margin-bottom:.3rem}
.cloud-notify.warn .cloud-notify-title{color:var(--gold)}
.cloud-notify.error .cloud-notify-title{color:var(--danger)}
.cloud-notify-msg{font-size:.8rem;color:var(--text-dim);line-height:1.45}
.cloud-notify-close{background:none;border:none;color:var(--text-muted);font-size:1.2rem;cursor:pointer;padding:0;line-height:1;flex-shrink:0}
.cloud-notify-close:hover{color:var(--text)}
.cloud-notify-actions{padding:0 1.25rem 1rem;display:flex;gap:.5rem}
.cloud-notify-actions .btn{font-size:.8rem;padding:.45rem .9rem}
@keyframes notifyCountdown{from{width:100%}to{width:0%}}
.cloud-notify-timer{height:3px;background:var(--text-muted);opacity:.3;border-radius:0 0 14px 14px}

/* ===== TWO-FACTOR AUTHENTICATION (2FA) STYLES ===== */
.twofa-modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:10000;backdrop-filter:blur(4px)}
.twofa-modal{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:2rem;max-width:450px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,.5);animation:twofaSlideIn .3s ease}
@keyframes twofaSlideIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
.twofa-modal-header{text-align:center;margin-bottom:1.5rem}
.twofa-modal-header h2{color:var(--text);margin-bottom:.5rem;font-size:1.1rem}
.twofa-modal-header p{color:var(--text-dim);font-size:.85rem}
.twofa-qr-container{display:flex;flex-direction:column;align-items:center;margin:1.5rem 0;padding:1.5rem;background:var(--surface);border-radius:12px;border:1px solid var(--border)}
.twofa-qr-container canvas,.twofa-qr-container img{border-radius:8px;margin-bottom:1rem}
.twofa-secret-key{font-family:'JetBrains Mono',monospace;background:var(--bg);padding:.6rem .8rem;border-radius:6px;font-size:.82rem;letter-spacing:2px;color:var(--text);border:1px dashed var(--border);word-break:break-all;text-align:center}
.twofa-secret-label{font-size:.72rem;color:var(--text-muted);margin-bottom:.5rem}
.twofa-single-input{width:100%;padding:.85rem;text-align:center;font-size:1.75rem;font-weight:600;letter-spacing:8px;border:2px solid var(--border);border-radius:8px;background:var(--surface);color:var(--text);font-family:'JetBrains Mono',monospace;transition:all .2s}
.twofa-single-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}
.twofa-actions{display:flex;gap:.75rem;justify-content:center;margin-top:1.5rem}
.twofa-actions button{padding:.6rem 1.25rem;border-radius:6px;font-weight:600;cursor:pointer;transition:all .15s;font-family:inherit;font-size:.85rem}
.twofa-btn-primary{background:var(--green);color:#fff;border:none}
.twofa-btn-primary:hover{background:#059669}
.twofa-btn-secondary{background:transparent;color:var(--text-dim);border:1px solid var(--border)}
.twofa-btn-secondary:hover{background:var(--surface)}
.twofa-btn-danger{background:var(--danger);color:#fff;border:none}
.twofa-btn-danger:hover{filter:brightness(1.15)}
.twofa-backup-codes{display:grid;grid-template-columns:repeat(2,1fr);gap:.5rem;margin:1rem 0;padding:1rem;background:var(--surface);border-radius:8px;border:1px solid var(--border)}
.twofa-backup-code{font-family:'JetBrains Mono',monospace;padding:.5rem;background:var(--bg);border-radius:4px;text-align:center;font-size:.82rem;color:var(--text)}
.twofa-backup-code.used{text-decoration:line-through;opacity:.5}
.twofa-warning{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:8px;padding:1rem;margin:1rem 0;font-size:.82rem;color:var(--gold)}
.twofa-success{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);border-radius:8px;padding:1rem;margin:1rem 0;font-size:.82rem;color:var(--green)}
.twofa-login-step{text-align:center}
.twofa-login-step .login-subtitle{margin-bottom:1rem;color:var(--text-dim);font-size:.85rem}
.twofa-use-backup{margin-top:1rem;font-size:.82rem;color:var(--text-muted)}
.twofa-use-backup a{color:var(--primary);cursor:pointer;text-decoration:underline}
.twofa-use-backup a:hover{color:#60a5fa}
.twofa-status-badge{display:inline-flex;align-items:center;gap:.35rem;padding:.15rem .5rem;border-radius:9999px;font-size:.7rem;font-weight:600}
.twofa-status-badge.enabled{background:rgba(16,185,129,.15);color:var(--green)}
.twofa-status-badge.disabled{background:rgba(100,116,139,.15);color:var(--text-muted)}

/* ===== FORGOT PASSWORD / OTP STYLES ===== */
.forgot-password-link{text-align:center;margin-top:.75rem}
.forgot-password-link a{color:var(--primary);cursor:pointer;font-size:.82rem;text-decoration:none;transition:color .2s}
.forgot-password-link a:hover{color:#60a5fa;text-decoration:underline}
.forgot-password-header{text-align:center;margin-bottom:1.25rem}
.forgot-password-header h3{font-size:1.1rem;font-weight:600;color:var(--text);margin-bottom:.35rem}
.forgot-password-header p{font-size:.82rem;color:var(--text-dim);line-height:1.5}
.forgot-password-error,.otp-error,.new-password-error{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3);color:#f87171;padding:.6rem .8rem;border-radius:8px;font-size:.8rem;display:flex;align-items:center;gap:.5rem;margin-bottom:1rem}
.login-btn-secondary{width:100%;padding:.65rem;background:transparent!important;color:var(--text-dim)!important;border:1px solid var(--border)!important;border-radius:8px;font-size:.85rem;font-weight:600;cursor:pointer;margin-top:.5rem;font-family:inherit;transition:all .15s}
.login-btn-secondary:hover{background:var(--surface)!important;border-color:var(--primary)!important;color:var(--primary)!important}
.otp-resend{text-align:center;margin-top:.75rem;font-size:.82rem;color:var(--text-muted)}
.otp-resend a{color:var(--primary);cursor:pointer;text-decoration:none}
.otp-resend a:hover{color:#60a5fa;text-decoration:underline}
</style>
</head>
<body>

<!-- ===== LOGIN PAGE ===== -->
<div class="login-screen" id="loginPage">
  <div class="login-wrapper">
    <div class="login-card" style="position:relative">
      <div class="login-syncing-overlay" id="loginSyncOverlay">
        <div class="login-syncing-spinner"></div>
        <div class="login-syncing-text" id="loginSyncOverlayText">Syncing from cloud...</div>
        <div class="login-syncing-sub" id="loginSyncOverlaySub">Checking for your account credentials</div>
      </div>
      <div class="login-brand">
        <h1>C.E.S.T.I.S</h1>
        <p>Payroll Management System</p>
      </div>
      <div id="loginCloudBanner" class="login-cloud-banner" style="display:none">
        <span class="banner-icon" id="loginBannerIcon"></span>
        <span class="banner-text" id="loginBannerText"></span>
      </div>
      <div class="login-error" id="loginError"><span id="loginErrorText">Invalid username or password</span></div>

      <!-- Step 1: Username/Password -->
      <form id="loginStep1" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="username" placeholder="Enter username" autocomplete="username">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="password" placeholder="Enter password" autocomplete="current-password">
        </div>
        <button type="submit" class="login-btn" id="loginBtn">Sign In</button>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.75rem">
          <a onclick="showForgotPassword()" style="color:var(--primary);cursor:pointer;font-size:.82rem;text-decoration:none">Forgot Password?</a>
          <a onclick="showFirstTimeSection();sessionStorage.removeItem('firstTimeSyncDismissed')" style="color:var(--primary);cursor:pointer;font-size:.78rem;text-decoration:none">Sync from Cloud</a>
        </div>
        <div class="login-user-info">
          <span id="loggedInUserName" style="display:none"></span>
          <span id="loggedInUserRole" style="display:none"></span>
          <span>Contact your administrator for access</span>
        </div>
        <!-- Debug: Verify Stored Accounts -->
        <div style="text-align:center;margin-top:.5rem">
          <button type="button" onclick="toggleLoginDebug()" style="background:none;border:none;color:var(--text-muted);font-size:.65rem;cursor:pointer;opacity:.5;font-family:inherit" id="loginDebugToggle">Verify stored accounts</button>
          <div id="loginDebugPanel" style="display:none;margin-top:.5rem;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:.75rem;text-align:left;font-size:.72rem;color:var(--text-dim);max-height:200px;overflow-y:auto">
          </div>
        </div>
      </form>

      <!-- Forgot Password Step: Enter Email -->
      <div id="loginStepForgotPassword" style="display:none">
        <div class="forgot-password-header">
          <h3>Reset Your Password</h3>
          <p>Enter your email address and we'll send you a one-time password (OTP) to reset your password.</p>
        </div>
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" id="forgotPasswordEmail" placeholder="Enter your email address" autocomplete="email">
        </div>
        <div class="forgot-password-error" id="forgotPasswordError" style="display:none">
          <span>‚ö†Ô∏è</span>
          <span id="forgotPasswordErrorText">Error message</span>
        </div>
        <button class="login-btn" onclick="sendOTPEmail()">Send OTP</button>
        <button class="login-btn-secondary" onclick="cancelForgotPassword()">Back to Login</button>
      </div>

      <!-- OTP Verification Step -->
      <div id="loginStepOTP" style="display:none">
        <div class="forgot-password-header">
          <h3>Enter Verification Code</h3>
          <p>We've sent a 6-digit code to your email. Enter it below to verify your identity.</p>
        </div>
        <div class="form-group" style="margin-bottom:1rem">
          <input type="text" id="otpCode" class="twofa-single-input" maxlength="6" pattern="[0-9]*" inputmode="numeric" placeholder="000000" autocomplete="one-time-code">
        </div>
        <div class="otp-error" id="otpError" style="display:none">
          <span>‚ö†Ô∏è</span>
          <span id="otpErrorText">Error message</span>
        </div>
        <button class="login-btn" onclick="verifyOTP()">Verify Code</button>
        <div class="otp-resend">
          <span>Didn't receive the code? </span>
          <a onclick="resendOTP()">Resend OTP</a>
        </div>
        <button class="login-btn-secondary" onclick="cancelForgotPassword()">Cancel</button>
      </div>

      <!-- New Password Step -->
      <div id="loginStepNewPassword" style="display:none">
        <div class="forgot-password-header">
          <h3>Create New Password</h3>
          <p>Enter your new password below.</p>
        </div>
        <div class="form-group">
          <label>New Password</label>
          <input type="password" id="newPassword" placeholder="Enter new password">
        </div>
        <div class="form-group">
          <label>Confirm Password</label>
          <input type="password" id="confirmNewPassword" placeholder="Confirm new password">
        </div>
        <div class="new-password-error" id="newPasswordError" style="display:none">
          <span>‚ö†Ô∏è</span>
          <span id="newPasswordErrorText">Error message</span>
        </div>
        <button class="login-btn" onclick="resetPassword()">Reset Password</button>
        <button class="login-btn-secondary" onclick="cancelForgotPassword()">Cancel</button>
      </div>

      <!-- Step 2: 2FA Verification -->
      <div id="loginStep2FA" style="display:none" class="twofa-login-step">
        <p class="login-subtitle">Enter the 6-digit code from your authenticator app</p>
        <div class="form-group" style="margin-bottom:1rem">
          <input type="text" id="login2FACode" class="twofa-single-input" maxlength="6" pattern="[0-9]*" inputmode="numeric" placeholder="000000" autocomplete="one-time-code">
        </div>
        <button class="login-btn" onclick="verify2FALogin()">Verify Code</button>
        <div class="twofa-use-backup">
          <a onclick="showBackupCodeInput()">Use a backup code instead</a>
        </div>
        <div id="backupCodeSection" style="display:none;margin-top:1rem">
          <div class="form-group">
            <label>Backup Code</label>
            <input type="text" id="loginBackupCode" placeholder="Enter backup code" style="text-transform:uppercase;letter-spacing:2px;font-family:'JetBrains Mono',monospace">
          </div>
          <button class="login-btn" onclick="verifyBackupCodeLogin()" style="background:var(--gold);color:#000">Use Backup Code</button>
        </div>
        <button class="login-btn-secondary" onclick="cancelTwoFALogin()">Cancel</button>
      </div>
    </div>

    <!-- First Time Here? Section -->
    <div class="first-time-section" id="firstTimeSection">
      <div class="first-time-heading">First Time Here?</div>
      <div class="first-time-card" id="firstTimeCard">
        <span class="ft-cloud-icon" id="ftCloudIcon">&#9729;</span>
        <div class="ft-title" id="ftTitle">Sync with Google Cloud</div>
        <div class="ft-desc" id="ftDesc">Sign in with Google to load your credentials and data directly from the school's Google Drive folder.</div>
        <button class="ft-sync-btn" id="ftSyncBtn" onclick="firstTimeGoogleSync()">
          <span class="ft-btn-icon">&#9729;</span>
          <span class="ft-btn-spinner"></span>
          <span class="ft-btn-label" id="ftBtnLabel">Sync with Google Cloud</span>
        </button>
        <div class="ft-status" id="ftStatus"></div>
        <div id="ftGoogleAccount" class="ft-google-account" style="display:none">
          <div class="ft-avatar" id="ftAvatar">?</div>
          <div class="ft-account-info">
            <div class="ft-account-name" id="ftAccountName"></div>
            <div class="ft-account-email" id="ftAccountEmail"></div>
          </div>
        </div>
        <button class="ft-skip" onclick="dismissFirstTime()">I already have local data &mdash; skip this</button>
      </div>
    </div>
    <div id="loginCloudStatus" style="font-size:.72rem;color:var(--text-muted);margin-top:.5rem;display:none"></div>
  </div>
</div>

<div class="app" id="dashboardContainer" style="display:none">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-brand">
      <h1>C.E.S.T.I.S</h1>
      <p>Payroll System</p>
    </div>
    <!-- Logged-in user badge -->
    <div class="sidebar-user" id="sidebarUser" style="display:none">
      <div class="user-avatar" id="sidebarAvatar">A</div>
      <div class="user-details nav-text">
        <div class="user-name" id="sidebarUserName">Admin</div>
        <div class="user-role" id="sidebarUserRole">admin</div>
      </div>
      <button class="logout-btn" onclick="handleLogout()" title="Sign Out">üö™</button>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item active" onclick="showPage('dashboard')"><span class="icon">üìä</span><span class="nav-text">Dashboard</span></div>
      <div class="nav-item" onclick="showPage('employees')"><span class="icon">üë•</span><span class="nav-text">Employees</span></div>
      <div class="nav-item" onclick="showPage('payroll')"><span class="icon">üí∞</span><span class="nav-text">Run Payroll</span></div>
      <div class="nav-item" onclick="showPage('payslips')"><span class="icon">üßæ</span><span class="nav-text">Payslips</span></div>
      <div class="nav-item" onclick="showPage('salaryrecords')"><span class="icon">üìÜ</span><span class="nav-text">Salary Records</span></div>
      <div class="nav-item" onclick="showPage('deductions')"><span class="icon">üìã</span><span class="nav-text">Tax Summary</span></div>
      <div class="nav-item" onclick="showPage('permissions')"><span class="icon">üîë</span><span class="nav-text">Permissions</span><span class="notif-badge" id="permNotifBadge" style="display:none">0</span></div>
      <div class="nav-item settings-btn" onclick="showPage('settings')"><span class="icon">‚öôÔ∏è</span><span class="nav-text">Settings</span></div>
      <div class="nav-item" id="navUserMgmt" onclick="showPage('usermanagement')" style="display:none"><span class="icon">üõ°Ô∏è</span><span class="nav-text">User Management</span></div>
      <div style="border-top:1px solid var(--border);margin:0.5rem 0"></div>
      <a href="https://stevebarrettsrha-ops.github.io/CESTIS---Cashbook-Dashboard/" target="_blank" rel="noopener noreferrer" class="nav-item" style="text-decoration:none;color:inherit"><span class="icon">üìí</span><span class="nav-text">Cashbook Dashboard</span></a>
    </nav>
    <div class="sidebar-footer" style="padding:0.75rem 1rem">
      <div class="cloud-section-label nav-text">CLOUD SYNC</div>

      <!-- Cloud Sync: Not Connected -->
      <div id="cloudNotConnected">
        <div class="cloud-status-row">
          <span id="cloudStatusDot" class="cloud-status-dot disconnected"></span>
          <span class="cloud-status-label disconnected nav-text" id="cloudStatusText">Not connected</span>
        </div>
        <button class="cloud-sync-btn" onclick="connectToGoogleDrive()">
          <span>‚òÅÔ∏è</span>
          <span class="nav-text">Connect to Cloud</span>
        </button>
      </div>

      <!-- Cloud Sync: Connected -->
      <div id="cloudConnected" style="display:none;">
        <div class="cloud-status-row">
          <span id="cloudConnectedDot" class="cloud-status-dot connected"></span>
          <span class="cloud-status-label connected nav-text" id="cloudConnectedText">Connected</span>
        </div>
        <div class="cloud-dropdown">
          <button class="cloud-sync-btn" onclick="toggleCloudMenu()">
            <span id="cloudMenuIcon">‚òÅÔ∏è</span>
            <span class="nav-text">Cloud</span>
            <span class="btn-arrow nav-text">‚ñº</span>
          </button>
          <div class="cloud-dropdown-content" id="cloudDropdownMenu">
            <div class="cloud-dropdown-item save-cloud" onclick="saveToCloud()">
              <span>üíæ</span>
              <span>Save to Cloud</span>
            </div>
            <div class="cloud-dropdown-item sync-cloud" onclick="syncFromCloud()">
              <span>üîÑ</span>
              <span>Sync from Cloud</span>
            </div>
            <div class="cloud-dropdown-item merge-cloud" onclick="mergeFromCloud()">
              <span>üîÄ</span>
              <span>Merge from Cloud</span>
            </div>
            <div class="cloud-dropdown-divider"></div>
            <div class="cloud-dropdown-item browse-cloud" onclick="browseCloudFolder()">
              <span>üìÇ</span>
              <span>Browse All Backups</span>
            </div>
            <div class="cloud-dropdown-divider"></div>
            <div class="last-sync-info" id="lastSyncInfo">
              Last sync: Never
            </div>
            <div class="last-sync-info" id="lastSavedByInfo">
              Last saved by: --
            </div>
            <div class="last-sync-info" id="backupFileNameInfo" style="word-break:break-all;">
              Backup file: <span id="backupFileNameText">--</span>
            </div>
            <div class="cloud-dropdown-divider"></div>
            <div class="cloud-dropdown-item danger" onclick="disconnectFromGoogleDrive()">
              <span>üîå</span>
              <span>Disconnect</span>
            </div>
          </div>
        </div>
        <div class="cloud-sync-meta nav-text" id="sidebarSyncInfo">Last sync: Never</div>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">

    <!-- ===== DASHBOARD ===== -->
    <div id="page-dashboard" class="page active">
      <div class="page-header">
        <div><h2>Payroll Dashboard</h2><div class="subtitle">C.E.S.T.I.S ‚Äî Overview</div></div>
        <div class="btn-group">
          <button class="btn btn-ghost" id="globalRefreshBtn" onclick="refreshAllData()" title="Refresh &amp; sync all data">üîÑ Refresh</button>
          <button class="btn btn-ghost" onclick="exportAllData()">üì• Export Data</button>
          <button class="btn btn-primary" onclick="showPage('payroll')">‚ñ∂ Run Payroll</button>
        </div>
      </div>
      <div class="stats-row" id="dashStats"></div>
      <div class="panel">
        <div class="panel-head"><h3>Recent Payroll History</h3></div>
        <div class="panel-body"><div class="table-wrap" id="dashHistory"></div></div>
      </div>
      <div class="panel">
        <div class="panel-head"><h3>Employee Summary</h3></div>
        <div class="panel-body"><div class="table-wrap" id="dashEmployees"></div></div>
      </div>
    </div>

    <!-- ===== EMPLOYEES ===== -->
    <div id="page-employees" class="page">
      <div class="page-header">
        <div><h2>Employee Management</h2><div class="subtitle">Full-Time & Part-Time Staff Records</div></div>
        <div class="btn-group">
          <button class="btn btn-ghost" onclick="refreshAllData()" title="Refresh &amp; sync all data">üîÑ Refresh</button>
          <button class="btn btn-primary" onclick="openEmployeeModal()">+ Add Employee</button>
        </div>
      </div>
      <div class="panel">
        <div class="panel-head"><h3>All Employees</h3></div>
        <div class="panel-body"><div class="table-wrap" id="employeeTable"></div></div>
      </div>
    </div>

    <!-- ===== PAYROLL ===== -->
    <div id="page-payroll" class="page">
      <div class="page-header">
        <div><h2>Process Payroll</h2><div class="subtitle">Calculate deductions and generate payslips</div></div>
        <button class="btn btn-ghost" onclick="refreshAllData()" title="Refresh &amp; sync all data">üîÑ Refresh</button>
      </div>

      <!-- Quarter Navigation -->
      <div class="quarter-nav" id="quarterNav"></div>

      <!-- Month Cards -->
      <div class="month-cards" id="monthCards"></div>

      <!-- Quarter Summary Stats -->
      <div class="quarter-stats" id="quarterStats"></div>

      <!-- Payroll Input Form -->
      <div class="panel">
        <div class="panel-head"><h3 id="payrollFormTitle">Payroll Configuration</h3></div>
        <div class="panel-body">
          <div class="form-grid">
            <div class="form-group">
              <label>Pay Cycle Date</label>
              <input type="date" id="payCycleDate">
            </div>
            <div class="form-group">
              <label>Income Tax Threshold (Annual)</label>
              <input type="number" id="taxThreshold" value="1799376" step="1">
            </div>
          </div>
          <div style="margin-top:1.25rem">
            <h4 style="font-size:.85rem;margin-bottom:.75rem;color:var(--text-dim)">Employee Gross Earnings for this Cycle</h4>
            <div class="table-wrap" id="payrollInput"></div>
          </div>
          <div style="margin-top:1.25rem;display:flex;gap:.75rem">
            <button class="btn btn-success" onclick="calculatePayroll()">üßÆ Calculate Payroll</button>
            <button class="btn btn-ghost" onclick="fillDefaultSalaries()">üìã Fill Default Salaries</button>
          </div>
        </div>
      </div>
      <div class="panel" id="payrollResultsPanel" style="display:none">
        <div class="panel-head"><h3>Payroll Results</h3><button class="btn btn-primary btn-sm" onclick="savePayrollRun()">üíæ Save & Lock Payroll</button></div>
        <div class="panel-body"><div class="table-wrap" id="payrollResults"></div></div>
      </div>

      <!-- Quarter Payroll History -->
      <div class="panel" id="quarterHistoryPanel">
        <div class="panel-head"><h3 id="quarterHistoryTitle">Quarter Payroll History</h3></div>
        <div class="panel-body"><div class="table-wrap" id="quarterHistory"></div></div>
      </div>
    </div>

    <!-- ===== PAYSLIPS ===== -->
    <div id="page-payslips" class="page">
      <div class="page-header">
        <div><h2>Payslip Generator</h2><div class="subtitle">View, preview and print individual payslips</div></div>
        <button class="btn btn-ghost" onclick="refreshAllData()" title="Refresh &amp; sync all data">üîÑ Refresh</button>
      </div>
      <div class="panel">
        <div class="panel-head"><h3>Select Employee & Pay Cycle</h3></div>
        <div class="panel-body">
          <div class="form-grid">
            <div class="form-group">
              <label>Employee</label>
              <select id="payslipEmployee"></select>
            </div>
            <div class="form-group">
              <label>Pay Cycle</label>
              <select id="payslipCycle"></select>
            </div>
            <div class="form-group" style="justify-content:flex-end">
              <button class="btn btn-primary" onclick="generatePayslipPreview()">üëÅ Preview Payslip</button>
            </div>
          </div>
        </div>
      </div>
      <div id="payslipPreviewArea"></div>
      <div class="payslip-container" id="payslipPrintArea"></div>
    </div>

    <!-- ===== TAX SUMMARY ===== -->
    <div id="page-deductions" class="page">
      <div class="page-header">
        <div><h2>Tax Deductions Summary</h2><div class="subtitle">Statutory contributions by pay cycle</div></div>
        <button class="btn btn-ghost" onclick="refreshAllData()" title="Refresh &amp; sync all data">üîÑ Refresh</button>
      </div>
      <div class="panel">
        <div class="panel-head"><h3>Monthly Contribution Totals</h3></div>
        <div class="panel-body"><div class="table-wrap" id="taxSummaryTable"></div></div>
      </div>
      <div class="panel">
        <div class="panel-head"><h3>Per-Employee Breakdown</h3></div>
        <div class="panel-body">
          <div class="form-group" style="max-width:300px;margin-bottom:1rem">
            <label>Select Pay Cycle</label>
            <select id="taxCycleSelect" onchange="renderTaxBreakdown()"></select>
          </div>
          <div class="table-wrap" id="taxBreakdownTable"></div>
        </div>
      </div>
    </div>

    <!-- ===== SALARY RECORDS ===== -->
    <div id="page-salaryrecords" class="page">
      <div class="page-header">
        <div><h2>Salary Records</h2><div class="subtitle">Monthly &amp; Quarterly Salary Records for All Employees</div></div>
        <div class="btn-group">
          <button class="btn btn-ghost" onclick="refreshAllData()" title="Refresh &amp; sync all data">üîÑ Refresh</button>
          <button class="btn btn-ghost" onclick="exportSalaryRecordsCSV()">üì• Export CSV</button>
        </div>
      </div>

      <!-- Quarter Navigation -->
      <div class="quarter-nav" id="srQuarterNav"></div>

      <div class="panel">
        <div class="panel-head"><h3 id="srTableTitle">Monthly Salary Records</h3></div>
        <div class="panel-body">
          <div class="table-wrap" id="salaryRecordsTable" style="font-size:.8rem"></div>
        </div>
      </div>
      <div class="stats-row" id="salaryRecordStats"></div>
      <div class="panel" id="quarterlySummaryPanel">
        <div class="panel-head"><h3 id="quarterlySummaryTitle">Quarterly Summary</h3></div>
        <div class="panel-body"><div class="table-wrap" id="quarterlyTable"></div></div>
      </div>
      <div class="panel" id="empQuarterlyPanel">
        <div class="panel-head"><h3 id="empQuarterlyTitle">Per-Employee Quarterly Breakdown</h3></div>
        <div class="panel-body"><div class="table-wrap" id="empQuarterlyTable"></div></div>
      </div>
    </div>

    <!-- ===== SETTINGS ===== -->
    <div id="page-settings" class="page">
      <div class="page-header">
        <div><h2>Settings</h2><div class="subtitle">Tax rates and system configuration</div></div>
      </div>
      <div class="panel">
        <div class="panel-head">
          <h3>Jamaican Statutory Deduction Rates</h3>
          <button class="btn btn-primary" onclick="fetchCurrentRates()" id="fetchRatesBtn">üåê Fetch Current Rates</button>
        </div>
        <div id="ratesFetchStatus" style="display:none;padding:.75rem 1.25rem;font-size:.85rem;border-bottom:1px solid var(--border);"></div>
        <div class="panel-body">
          <div class="form-grid">
            <div class="form-group"><label>NIS Employee Rate (%)</label><input type="number" id="rateNISEmp" value="3" step="0.1"></div>
            <div class="form-group"><label>NIS Employer Rate (%)</label><input type="number" id="rateNISEr" value="3" step="0.1"></div>
            <div class="form-group"><label>NIS Monthly Wage Ceiling ($)</label><input type="number" id="nisCeilingMonthly" value="416667" step="1"></div>
            <div class="form-group"><label>Education Tax Employee (%)</label><input type="number" id="rateEdTaxEmp" value="2.25" step="0.01"></div>
            <div class="form-group"><label>Education Tax Employer (%)</label><input type="number" id="rateEdTaxEr" value="3.5" step="0.01"></div>
            <div class="form-group"><label>NHT Employee (%)</label><input type="number" id="rateNHTEmp" value="2" step="0.1"></div>
            <div class="form-group"><label>NHT Employer (%)</label><input type="number" id="rateNHTEr" value="3" step="0.1"></div>
            <div class="form-group"><label>HEART/NSTA Employer (%)</label><input type="number" id="rateHeartEr" value="3" step="0.1"></div>
            <div class="form-group"><label>Income Tax Standard Rate (%)</label><input type="number" id="rateIncomeTax" value="25" step="0.1"></div>
            <div class="form-group"><label>Income Tax Higher Rate (%)</label><input type="number" id="rateIncomeTaxHigher" value="30" step="0.1"></div>
            <div class="form-group"><label>Higher Rate Annual Threshold ($)</label><input type="number" id="higherBracketAnnual" value="6000000" step="1"></div>
            <div class="form-group"><label>Annual Income Tax Threshold ($)</label><input type="number" id="annualThreshold" value="1799376" step="1"></div>
          </div>
          <div style="margin-top:1.25rem;display:flex;gap:.75rem">
            <button class="btn btn-success" onclick="saveSettings()">üíæ Save Settings</button>
            <button class="btn btn-danger" onclick="if(confirm('Reset ALL data?')){localStorage.clear();location.reload()}">üóë Reset All Data</button>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-head"><h3>Data Management</h3></div>
        <div class="panel-body">
          <div class="btn-group">
            <button class="btn btn-primary" onclick="loadPresetData()">üì¶ Load Preset Employee Data</button>
            <button class="btn btn-ghost" onclick="exportAllData()">üì• Export JSON Backup</button>
            <button class="btn btn-ghost" onclick="document.getElementById('importFile').click()">üì§ Import JSON Backup</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PERMISSION REQUESTS ===== -->
    <div id="page-permissions" class="page">
      <div class="page-header">
        <div><h2>Permission Requests</h2><div class="subtitle">Request and manage payroll editing permissions</div></div>
        <button class="btn btn-ghost" onclick="refreshAllData()" title="Refresh &amp; sync all data">üîÑ Refresh</button>
      </div>
      <!-- Permission status banner (for non-admin users) -->
      <div id="permStatusBanner" style="display:none"></div>
      <!-- Request form (for non-admin users) -->
      <div class="panel" id="permRequestPanel">
        <div class="panel-head"><h3>Request Payroll Editing Permission</h3></div>
        <div class="panel-body">
          <p style="font-size:.85rem;color:var(--text-dim);margin-bottom:1rem;line-height:1.5">Submit a request to the administrator for temporary permission to edit, add, or delete payroll runs. Once approved, permission lasts for <strong style="color:var(--accent)">20 minutes</strong>.</p>
          <div class="form-group" style="max-width:500px;margin-bottom:1rem">
            <label>Reason for Request</label>
            <textarea id="permRequestReason" rows="3" style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:.6rem .8rem;color:var(--text);font-family:inherit;font-size:.85rem;width:100%;resize:vertical" placeholder="e.g. Need to correct January payroll figures..."></textarea>
          </div>
          <button class="btn btn-primary" onclick="submitPermissionRequest()">üîë Submit Request</button>
        </div>
      </div>
      <!-- Admin: incoming requests -->
      <div class="panel" id="adminRequestsPanel" style="display:none">
        <div class="panel-head"><h3>Incoming Permission Requests</h3><span class="tag" id="pendingRequestCount" style="background:rgba(245,158,11,.15);color:#fbbf24">0 pending</span></div>
        <div class="panel-body" id="adminRequestsList"></div>
      </div>
      <!-- All requests history -->
      <div class="panel">
        <div class="panel-head"><h3>Request History</h3></div>
        <div class="panel-body"><div class="table-wrap" id="permHistoryTable"></div></div>
      </div>
    </div>

    <!-- ===== USER MANAGEMENT (Admin Only) ===== -->
    <div id="page-usermanagement" class="page">
      <div class="page-header">
        <div><h2>User Management</h2><div class="subtitle">Manage system users and access roles</div></div>
        <button class="btn btn-primary" onclick="openAddUserModal()">+ Add User</button>
      </div>
      <div class="stats-row" id="userStats"></div>
      <div class="panel">
        <div class="panel-head"><h3>System Users</h3></div>
        <div class="panel-body"><div class="table-wrap" id="usersTable"></div></div>
      </div>
    </div>

  </main>
</div>

<!-- Add User Modal -->
<div class="modal-overlay" id="addUserModal">
  <div class="modal">
    <div class="modal-header">
      <h3 id="userModalTitle">Add User</h3>
      <button class="modal-close" onclick="closeAddUserModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Display Name</label>
          <input type="text" id="newUserDisplayName" placeholder="e.g. John Smith">
        </div>
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="newUserUsername" placeholder="e.g. jsmith">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="newUserEmail" placeholder="e.g. jsmith@example.com">
          <small style="color:var(--text-muted);margin-top:.25rem;display:block">Required for password reset via OTP</small>
        </div>
        <div class="form-group">
          <label>Password</label>
          <div style="position:relative">
            <input type="text" id="newUserPassword" placeholder="Enter password" autocomplete="new-password">
            <small style="color:var(--text-muted);margin-top:.25rem;display:block">Password is case-sensitive</small>
          </div>
        </div>
        <div class="form-group">
          <label>Role</label>
          <select id="newUserRole">
            <option value="admin">Admin ‚Äî Full Access</option>
            <option value="user" selected>User ‚Äî Limited Access</option>
            <option value="viewer">Viewer ‚Äî View Only</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeAddUserModal()">Cancel</button>
      <button class="btn btn-success" onclick="saveUser()">Save User</button>
    </div>
  </div>
</div>

<!-- Permission Expired Modal -->
<div class="modal-overlay" id="permExpiredModal">
  <div class="modal" style="max-width:440px">
    <div class="modal-header" style="background:rgba(239,68,68,.1);border-bottom-color:rgba(239,68,68,.2)">
      <h3 style="color:var(--danger)">Permission Expired</h3>
      <button class="modal-close" onclick="closePermExpiredModal()">&times;</button>
    </div>
    <div class="modal-body" style="text-align:center;padding:2rem">
      <div style="font-size:2.5rem;margin-bottom:.75rem">üîí</div>
      <p style="font-size:.95rem;color:var(--text);margin-bottom:.5rem;font-weight:600">Your payroll editing permission has expired</p>
      <p style="font-size:.82rem;color:var(--text-dim);line-height:1.5">The 20-minute editing window has ended. Please submit a new permission request to continue editing payroll data.</p>
    </div>
    <div class="modal-footer" style="justify-content:center">
      <button class="btn btn-ghost" onclick="closePermExpiredModal()">Close</button>
      <button class="btn btn-primary" onclick="closePermExpiredModal();showPage('permissions')">üîë Request Permission</button>
    </div>
  </div>
</div>

<!-- 2FA Setup Modal -->
<div id="twofaSetupModal" class="twofa-modal-overlay" style="display:none">
  <div class="twofa-modal">
    <div class="twofa-modal-header">
      <h2>Set Up Two-Factor Authentication</h2>
      <p>Scan the QR code with Google Authenticator or any TOTP app</p>
    </div>
    <div class="twofa-qr-container">
      <div id="twofaQRCode"></div>
      <div class="twofa-secret-label">Or enter this code manually:</div>
      <div class="twofa-secret-key" id="twofaSecretKey"></div>
    </div>
    <div class="twofa-warning">
      <strong>Important:</strong> Save the secret key in a safe place. You'll need it if you lose access to your authenticator app.
    </div>
    <div class="form-group" style="margin-top:1rem">
      <label>Enter the 6-digit code to verify setup:</label>
      <input type="text" id="twofaSetupCode" class="twofa-single-input" maxlength="6" pattern="[0-9]*" inputmode="numeric" placeholder="000000">
    </div>
    <div class="twofa-actions">
      <button type="button" class="twofa-btn-secondary" onclick="closeTwoFASetup()">Cancel</button>
      <button type="button" class="twofa-btn-primary" onclick="confirmTwoFASetup()">Enable 2FA</button>
    </div>
  </div>
</div>

<!-- 2FA Backup Codes Modal -->
<div id="twofaBackupModal" class="twofa-modal-overlay" style="display:none">
  <div class="twofa-modal">
    <div class="twofa-modal-header">
      <h2>Backup Codes</h2>
      <p>Save these codes in a secure location. Each code can only be used once.</p>
    </div>
    <div class="twofa-warning">
      <strong>Warning:</strong> These codes will only be shown once. Make sure to save them now!
    </div>
    <div class="twofa-backup-codes" id="twofaBackupCodes"></div>
    <div class="twofa-actions">
      <button type="button" class="twofa-btn-secondary" onclick="copyBackupCodes()">Copy Codes</button>
      <button type="button" class="twofa-btn-primary" onclick="closeBackupCodesModal()">I've Saved These Codes</button>
    </div>
  </div>
</div>

<!-- 2FA Disable Confirmation Modal -->
<div id="twofaDisableModal" class="twofa-modal-overlay" style="display:none">
  <div class="twofa-modal">
    <div class="twofa-modal-header">
      <h2>Disable Two-Factor Authentication</h2>
      <p>Enter your current 2FA code to confirm</p>
    </div>
    <div class="twofa-warning">
      <strong>Warning:</strong> Disabling 2FA will make your account less secure.
    </div>
    <div class="form-group" style="margin-top:1rem">
      <label>Enter 6-digit code from your authenticator:</label>
      <input type="text" id="twofaDisableCode" class="twofa-single-input" maxlength="6" pattern="[0-9]*" inputmode="numeric" placeholder="000000">
    </div>
    <div class="twofa-actions">
      <button type="button" class="twofa-btn-secondary" onclick="closeTwoFADisable()">Cancel</button>
      <button type="button" class="twofa-btn-danger" onclick="confirmTwoFADisable()">Disable 2FA</button>
    </div>
  </div>
</div>

<!-- Employee Modal -->
<div class="modal-overlay" id="employeeModal">
  <div class="modal">
    <div class="modal-header"><h3 id="empModalTitle">Add Employee</h3><button class="modal-close" onclick="closeEmployeeModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label>Employee Name</label><input type="text" id="empName"></div>
        <div class="form-group"><label>Designation</label><input type="text" id="empDesignation"></div>
        <div class="form-group"><label>Type</label><select id="empType"><option value="FT">Full-Time</option><option value="PT">Part-Time</option></select></div>
        <div class="form-group"><label>Mobile No.</label><input type="text" id="empMobile"></div>
        <div class="form-group"><label>Date of Birth</label><input type="date" id="empDOB"></div>
        <div class="form-group"><label>TRN</label><input type="text" id="empTRN"></div>
        <div class="form-group"><label>NIS Number</label><input type="text" id="empNIS"></div>
        <div class="form-group"><label>Start Date</label><input type="date" id="empStart"></div>
        <div class="form-group"><label>Monthly Gross Salary ($)</label><input type="number" id="empSalary" step="0.01"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeEmployeeModal()">Cancel</button>
      <button class="btn btn-success" onclick="saveEmployee()">Save Employee</button>
    </div>
  </div>
</div>

<script>
// ==================== DATA STORE ====================
const STORAGE_KEY = 'cestisPayroll';
let DATA = loadStore();

function defaultData(){
  return {
    settings:{
      nisEmp:3,nisEr:3,edTaxEmp:2.25,edTaxEr:3.5,nhtEmp:2,nhtEr:3,
      incomeTax:25,incomeTaxHigher:30,higherBracketAnnual:6000000,
      annualThreshold:1799376,
      nisCeilingMonthly:416667,
      heartEr:3
    },
    employees:[],
    payrollRuns:[]
  };
}

function loadStore(){
  try{const d=localStorage.getItem(STORAGE_KEY);return d?JSON.parse(d):defaultData();}catch(e){return defaultData();}
}
function saveStore(){localStorage.setItem(STORAGE_KEY,JSON.stringify(DATA));}

// ==================== FORMATTING ====================
function fmt(n){return '$'+parseFloat(n||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmtDate(d){if(!d)return'‚Äî';const dt=new Date(d);return dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});}

// ==================== NAVIGATION ====================
let currentPageName='dashboard';
function showPage(name){
  // Access control: restrict pages by role
  if(currentUser){
    if(name==='usermanagement'&&!isAdminRole(currentUser.role)){name='dashboard';}
  }
  currentPageName=name;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  const navItems=document.querySelectorAll('.nav-item');
  const pages=['dashboard','employees','payroll','payslips','salaryrecords','deductions','permissions','settings','usermanagement'];
  const idx=pages.indexOf(name);
  if(idx>=0)navItems[idx].classList.add('active');
  if(name==='dashboard')renderDashboard();
  if(name==='employees')renderEmployees();
  if(name==='payroll')renderPayrollInput();
  if(name==='payslips')populatePayslipSelects();
  if(name==='salaryrecords')renderSalaryRecords();
  if(name==='deductions')renderTaxSummary();
  if(name==='permissions')renderPermissions();
  if(name==='settings')loadSettings();
  if(name==='usermanagement')renderUserManagement();
}

// Refresh data-dependent sections after employee/payroll changes
function refreshActiveSections(){
  // Always refresh dashboard stats since they summarize all data
  renderDashboard();
  // Refresh the currently visible section if it depends on employee/payroll data
  if(currentPageName==='payroll')renderPayrollInput();
  if(currentPageName==='payslips')populatePayslipSelects();
  if(currentPageName==='salaryrecords')renderSalaryRecords();
  if(currentPageName==='deductions')renderTaxSummary();
  if(currentPageName==='permissions')renderPermissions();
  if(currentPageName==='usermanagement')renderUserManagement();
  updatePermBadge();
}

// Full data refresh: clean orphaned payroll records, re-render current page
function refreshAllData(){
  // Build lookup of current employee names
  const empNames=new Set(DATA.employees.map(e=>e.name));
  const empNameLower={};
  DATA.employees.forEach(e=>{empNameLower[e.name.trim().toLowerCase()]=e;});
  let cleaned=0;
  // Remove payroll results for employees that no longer exist
  DATA.payrollRuns.forEach(run=>{
    const before=run.results.length;
    run.results=run.results.filter(r=>{
      if(!r.empName)return false;
      if(empNames.has(r.empName))return true;
      // Try case-insensitive match and fix the name
      const match=empNameLower[r.empName.trim().toLowerCase()];
      if(match){r.empName=match.name;r.empType=match.type;r.designation=match.designation;r.trn=match.trn;r.nis=match.nis;return true;}
      return false;
    });
    cleaned+=before-run.results.length;
  });
  // Remove empty payroll runs
  const runsBefore=DATA.payrollRuns.length;
  DATA.payrollRuns=DATA.payrollRuns.filter(run=>run.results.length>0);
  const runsRemoved=runsBefore-DATA.payrollRuns.length;
  // Sync employee fields in remaining payroll results
  DATA.payrollRuns.forEach(run=>{
    run.results.forEach(r=>{
      const emp=DATA.employees.find(e=>e.name===r.empName);
      if(emp){r.empType=emp.type;r.designation=emp.designation;r.trn=emp.trn;r.nis=emp.nis;}
    });
  });
  if(cleaned>0||runsRemoved>0)saveStore();
  // Re-render the current page
  showPage(currentPageName);
  // Flash the refresh button briefly
  const btn=document.getElementById('globalRefreshBtn');
  if(btn){btn.style.color='var(--green)';setTimeout(()=>{btn.style.color='';},600);}
}

// ==================== DASHBOARD ====================
function renderDashboard(){
  const emps=DATA.employees;
  const runs=DATA.payrollRuns;
  const ftCount=emps.filter(e=>e.type==='FT').length;
  const ptCount=emps.filter(e=>e.type==='PT').length;
  const lastRun=runs.length>0?runs[runs.length-1]:null;
  const totalGross=lastRun?lastRun.results.reduce((s,r)=>s+r.gross,0):0;
  const totalNet=lastRun?lastRun.results.reduce((s,r)=>s+r.netPay,0):0;

  document.getElementById('dashStats').innerHTML=`
    <div class="stat-card blue"><div class="label">Total Employees</div><div class="value">${emps.length}</div><div class="sub">${ftCount} Full-Time ¬∑ ${ptCount} Part-Time</div></div>
    <div class="stat-card gold"><div class="label">Last Gross Payroll</div><div class="value mono">${fmt(totalGross)}</div><div class="sub">${lastRun?fmtDate(lastRun.date):'No runs yet'}</div></div>
    <div class="stat-card green"><div class="label">Last Net Payroll</div><div class="value mono">${fmt(totalNet)}</div><div class="sub">After all deductions</div></div>
    <div class="stat-card red"><div class="label">Payroll Runs</div><div class="value">${runs.length}</div><div class="sub">Total processed cycles</div></div>
  `;

  let histHtml='<table><thead><tr><th>Pay Date</th><th class="text-right">Gross</th><th class="text-right">Net</th><th class="text-right">Emp Deductions</th><th class="text-right">Er Contributions</th><th>Employees</th></tr></thead><tbody>';
  if(runs.length===0)histHtml+='<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:2rem">No payroll runs yet</td></tr>';
  else runs.slice().reverse().forEach(r=>{
    const g=r.results.reduce((s,x)=>s+x.gross,0);
    const n=r.results.reduce((s,x)=>s+x.netPay,0);
    const ed=r.results.reduce((s,x)=>s+x.totalEmpDeductions,0);
    const er=r.results.reduce((s,x)=>s+x.totalErContributions,0);
    histHtml+=`<tr><td>${fmtDate(r.date)}</td><td class="mono text-right">${fmt(g)}</td><td class="mono text-right">${fmt(n)}</td><td class="mono text-right">${fmt(ed)}</td><td class="mono text-right">${fmt(er)}</td><td>${r.results.length}</td></tr>`;
  });
  histHtml+='</tbody></table>';
  document.getElementById('dashHistory').innerHTML=histHtml;

  let empHtml='<table><thead><tr><th>#</th><th>Name</th><th>Designation</th><th>Type</th><th>TRN</th><th>NIS</th></tr></thead><tbody>';
  emps.forEach((e,i)=>{
    empHtml+=`<tr><td>${i+1}</td><td>${e.name}</td><td>${e.designation}</td><td><span class="tag ${e.type==='FT'?'tag-ft':'tag-pt'}">${e.type}</span></td><td class="mono">${e.trn||'‚Äî'}</td><td class="mono">${e.nis||'‚Äî'}</td></tr>`;
  });
  if(emps.length===0)empHtml+='<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:2rem">No employees. Add some from Settings ‚Üí Load Preset Data</td></tr>';
  empHtml+='</tbody></table>';
  document.getElementById('dashEmployees').innerHTML=empHtml;
}

// ==================== EMPLOYEES ====================
let editingEmpIdx=-1;

function renderEmployees(){
  let html='<table><thead><tr><th>#</th><th>Name</th><th>Designation</th><th>Type</th><th>Mobile</th><th>DOB</th><th>TRN</th><th>NIS</th><th>Salary</th><th>Start</th><th>Actions</th></tr></thead><tbody>';
  DATA.employees.forEach((e,i)=>{
    html+=`<tr>
      <td>${i+1}</td><td>${e.name}</td><td>${e.designation||'‚Äî'}</td>
      <td><span class="tag ${e.type==='FT'?'tag-ft':'tag-pt'}">${e.type}</span></td>
      <td class="mono">${e.mobile||'‚Äî'}</td><td>${fmtDate(e.dob)}</td>
      <td class="mono">${e.trn||'‚Äî'}</td><td class="mono">${e.nis||'‚Äî'}</td>
      <td class="mono text-right">${fmt(e.salary)}</td><td>${fmtDate(e.startDate)}</td>
      <td><div class="btn-group"><button class="btn btn-ghost btn-sm" onclick="editEmployee(${i})">‚úèÔ∏è</button><button class="btn btn-danger btn-sm" onclick="deleteEmployee(${i})">üóë</button></div></td>
    </tr>`;
  });
  if(DATA.employees.length===0)html+='<tr><td colspan="11" style="text-align:center;color:var(--text-muted);padding:2rem">No employees added yet</td></tr>';
  html+='</tbody></table>';
  document.getElementById('employeeTable').innerHTML=html;
}

function openEmployeeModal(){
  if(currentUser&&currentUser.role==='viewer'){alert('View-only access: You cannot add or edit employees.');return;}
  editingEmpIdx=-1;
  document.getElementById('empModalTitle').textContent='Add Employee';
  ['empName','empDesignation','empMobile','empDOB','empTRN','empNIS','empStart','empSalary'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('empType').value='FT';
  document.getElementById('employeeModal').classList.add('show');
}

function closeEmployeeModal(){document.getElementById('employeeModal').classList.remove('show');}

function editEmployee(i){
  editingEmpIdx=i;const e=DATA.employees[i];
  document.getElementById('empModalTitle').textContent='Edit Employee';
  document.getElementById('empName').value=e.name;
  document.getElementById('empDesignation').value=e.designation||'';
  document.getElementById('empType').value=e.type;
  document.getElementById('empMobile').value=e.mobile||'';
  document.getElementById('empDOB').value=e.dob||'';
  document.getElementById('empTRN').value=e.trn||'';
  document.getElementById('empNIS').value=e.nis||'';
  document.getElementById('empStart').value=e.startDate||'';
  document.getElementById('empSalary').value=e.salary||'';
  document.getElementById('employeeModal').classList.add('show');
}

function saveEmployee(){
  const emp={
    name:document.getElementById('empName').value.trim(),
    designation:document.getElementById('empDesignation').value.trim(),
    type:document.getElementById('empType').value,
    mobile:document.getElementById('empMobile').value.trim(),
    dob:document.getElementById('empDOB').value,
    trn:document.getElementById('empTRN').value.trim(),
    nis:document.getElementById('empNIS').value.trim(),
    startDate:document.getElementById('empStart').value,
    salary:parseFloat(document.getElementById('empSalary').value)||0
  };
  if(!emp.name){alert('Employee name is required');return;}
  if(editingEmpIdx>=0){
    const oldName=DATA.employees[editingEmpIdx].name;
    DATA.employees[editingEmpIdx]=emp;
    // Propagate changes to all payroll runs so all sections stay in sync
    DATA.payrollRuns.forEach(run=>{
      run.results.forEach(r=>{
        if(r.empName===oldName){
          r.empName=emp.name;
          r.empType=emp.type;
          r.designation=emp.designation;
          r.trn=emp.trn;
          r.nis=emp.nis;
        }
      });
    });
  }
  else DATA.employees.push(emp);
  saveStore();closeEmployeeModal();renderEmployees();refreshActiveSections();
}

function deleteEmployee(i){
  if(currentUser&&currentUser.role==='viewer'){alert('View-only access: You cannot delete employees.');return;}
  if(!confirm('Delete '+DATA.employees[i].name+'?\n\nThis will also remove all their payroll records.'))return;
  const deletedName=DATA.employees[i].name;
  DATA.employees.splice(i,1);
  // Remove deleted employee from all payroll runs
  DATA.payrollRuns.forEach(run=>{
    run.results=run.results.filter(r=>r.empName!==deletedName);
  });
  // Remove empty payroll runs (no results left)
  DATA.payrollRuns=DATA.payrollRuns.filter(run=>run.results.length>0);
  saveStore();renderEmployees();refreshActiveSections();
}

// ==================== PAYROLL PROCESSING ====================
// Jamaican Fiscal Year: April ‚Äì March
// Q1=Apr-Jun, Q2=Jul-Sep, Q3=Oct-Dec, Q4=Jan-Mar
const QUARTER_MONTHS=[
  {q:1,label:'Q1',sub:'Apr\u2013Jun',months:[3,4,5],names:['April','May','June']},
  {q:2,label:'Q2',sub:'Jul\u2013Sep',months:[6,7,8],names:['July','August','September']},
  {q:3,label:'Q3',sub:'Oct\u2013Dec',months:[9,10,11],names:['October','November','December']},
  {q:4,label:'Q4',sub:'Jan\u2013Mar',months:[0,1,2],names:['January','February','March']}
];

// Fiscal year is identified by its start year (e.g. FY 2025/2026 ‚Üí fyStartYear=2025)
// Determine current FY: if current month >= April (3), FY starts this year; else last year
let fyStartYear=(function(){const now=new Date();return now.getMonth()>=3?now.getFullYear():now.getFullYear()-1;})();
let payrollQuarter=(function(){
  const m=new Date().getMonth();
  if(m>=3&&m<=5)return 0; // Q1
  if(m>=6&&m<=8)return 1; // Q2
  if(m>=9&&m<=11)return 2; // Q3
  return 3; // Q4 (Jan-Mar)
})();

function getFYLabel(startYear){return 'FY '+startYear+'/'+(startYear+1);}

// Get the calendar year for a given quarter within a fiscal year
function getCalendarYear(fyStart,qi){
  // Q1(Apr-Jun),Q2(Jul-Sep),Q3(Oct-Dec) are in fyStart year
  // Q4(Jan-Mar) is in fyStart+1 year
  return qi<=2?fyStart:fyStart+1;
}

function getQuarterRunsByMonth(fyStart,qDef,qi){
  const calYear=getCalendarYear(fyStart,qi);
  const result=[null,null,null];
  DATA.payrollRuns.forEach(run=>{
    const d=parseLocalDate(run.date);
    if(d.getFullYear()!==calYear)return;
    const m=d.getMonth();
    const idx=qDef.months.indexOf(m);
    if(idx>=0)result[idx]=run;
  });
  return result;
}

function changeFY(delta){
  fyStartYear+=delta;
  renderPayrollInput();
}

function changeQuarter(delta){
  payrollQuarter+=delta;
  if(payrollQuarter>3){payrollQuarter=0;fyStartYear++;}
  if(payrollQuarter<0){payrollQuarter=3;fyStartYear--;}
  renderPayrollInput();
}

function renderPayrollInput(){
  const qDef=QUARTER_MONTHS[payrollQuarter];
  const calYear=getCalendarYear(fyStartYear,payrollQuarter);
  const monthRuns=getQuarterRunsByMonth(fyStartYear,qDef,payrollQuarter);

  // Build quarter navigation ‚Äî matches screenshot exactly:
  // ‚óÑ  FY 2025/2026  ‚ñ∫   [Q1 ¬∑ Apr-Jun] [Q2 ¬∑ Jul-Sep] [Q3 ¬∑ Oct-Dec] [Q4 ¬∑ Jan-Mar]   ‚óÑ Prev Qtr | Next Qtr ‚ñ∫
  let navHtml='';

  // FY selector with arrows
  navHtml+=`<div class="fy-selector">`;
  navHtml+=`<button class="fy-arrow" onclick="changeFY(-1)" title="Previous Fiscal Year">\u25C4</button>`;
  navHtml+=`<span class="fy-label">${getFYLabel(fyStartYear)}</span>`;
  navHtml+=`<button class="fy-arrow" onclick="changeFY(1)" title="Next Fiscal Year">\u25BA</button>`;
  navHtml+=`</div>`;

  // Quarter tabs
  navHtml+=`<div class="quarter-tabs">`;
  QUARTER_MONTHS.forEach((q,qi)=>{
    navHtml+=`<button class="quarter-tab${qi===payrollQuarter?' active':''}" onclick="payrollQuarter=${qi};renderPayrollInput()">${q.label}<span class="q-sub">\u00B7 ${q.sub}</span></button>`;
  });
  navHtml+=`</div>`;

  // Prev/Next quarter buttons
  navHtml+=`<div class="qtr-nav-btns">`;
  navHtml+=`<button class="qtr-nav-btn" onclick="changeQuarter(-1)">\u25C4 Prev Qtr</button>`;
  navHtml+=`<button class="qtr-nav-btn" onclick="changeQuarter(1)">Next Qtr \u25BA</button>`;
  navHtml+=`</div>`;

  document.getElementById('quarterNav').innerHTML=navHtml;

  // Build month cards
  let monthHtml='';
  qDef.months.forEach((m,mi)=>{
    const run=monthRuns[mi];
    const isCompleted=run!==null;
    let statusText=isCompleted?'Payroll recorded':'Not yet recorded';
    if(isCompleted){
      const gross=run.results.reduce((s,r)=>s+r.gross,0);
      statusText='Recorded \u2014 '+fmt(gross);
    }
    monthHtml+=`<div class="month-card${isCompleted?' completed':''}" onclick="selectPayrollMonth(${calYear},${m})" title="${isCompleted?'View recorded payroll':'Run payroll for '+qDef.names[mi]}">
      <div class="month-name">${qDef.names[mi]}</div>
      <div class="month-status">${statusText}</div>
    </div>`;
  });
  document.getElementById('monthCards').innerHTML=monthHtml;

  // Build quarter summary stats
  let qGross=0,qNet=0,qDeductions=0,qErContr=0;
  monthRuns.forEach(run=>{
    if(!run)return;
    run.results.forEach(r=>{
      qGross+=r.gross;qNet+=r.netPay;qDeductions+=r.totalEmpDeductions;qErContr+=r.totalErContributions;
    });
  });
  const filledCount=monthRuns.filter(r=>r!==null).length;
  document.getElementById('quarterStats').innerHTML=`
    <div class="quarter-stat"><div class="qs-label">${qDef.label} Gross</div><div class="qs-value" style="color:var(--primary)">${fmt(qGross)}</div></div>
    <div class="quarter-stat"><div class="qs-label">${qDef.label} Net Pay</div><div class="qs-value" style="color:var(--green)">${fmt(qNet)}</div></div>
    <div class="quarter-stat"><div class="qs-label">${qDef.label} Deductions</div><div class="qs-value" style="color:var(--red)">${fmt(qDeductions)}</div></div>
    <div class="quarter-stat"><div class="qs-label">Months Recorded</div><div class="qs-value">${filledCount} / 3</div></div>
  `;

  // Update form title ‚Äî find the first unrecorded month in the quarter
  let defaultMonth=qDef.months[0];
  for(let mi=0;mi<3;mi++){
    if(!monthRuns[mi]){defaultMonth=qDef.months[mi];break;}
  }
  const defaultMonthName=MONTH_NAMES[defaultMonth];
  document.getElementById('payrollFormTitle').textContent='Run Payroll \u2014 '+defaultMonthName+' '+calYear;

  // Set date to end of the selected month
  const lastDay=new Date(calYear,defaultMonth+1,0);
  document.getElementById('payCycleDate').value=lastDay.toISOString().split('T')[0];
  document.getElementById('taxThreshold').value=DATA.settings.annualThreshold;

  // Sync the form title when pay cycle date changes
  document.getElementById('payCycleDate').onchange=function(){
    const d=new Date(this.value);
    if(!isNaN(d)){
      document.getElementById('payrollFormTitle').textContent='Run Payroll \u2014 '+MONTH_NAMES[d.getMonth()]+' '+d.getFullYear();
    }
  };

  // Employee gross input table
  let html='<table><thead><tr><th>#</th><th>Employee</th><th>Type</th><th>Default Salary</th><th>Gross Earnings This Cycle ($)</th></tr></thead><tbody>';
  DATA.employees.forEach((e,i)=>{
    html+=`<tr><td>${i+1}</td><td>${e.name}</td><td><span class="tag ${e.type==='FT'?'tag-ft':'tag-pt'}">${e.type}</span></td><td class="mono text-right">${fmt(e.salary)}</td><td><input type="number" step="0.01" id="grossInput_${i}" value="0" style="width:160px;background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:.4rem .6rem;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.82rem"></td></tr>`;
  });
  if(DATA.employees.length===0)html+='<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:2rem">Add employees first</td></tr>';
  html+='</tbody></table>';
  document.getElementById('payrollInput').innerHTML=html;
  document.getElementById('payrollResultsPanel').style.display='none';

  // Render quarter history
  renderQuarterHistory();
}

function selectPayrollMonth(year,month){
  const lastDay=new Date(year,month+1,0);
  document.getElementById('payCycleDate').value=lastDay.toISOString().split('T')[0];
  document.getElementById('payrollFormTitle').textContent='Run Payroll \u2014 '+MONTH_NAMES[month]+' '+year;

  // Check if this month already has payroll
  const existingRun=DATA.payrollRuns.find(r=>{
    const d=parseLocalDate(r.date);
    return d.getFullYear()===year&&d.getMonth()===month;
  });
  if(existingRun){
    const isAdmin=currentUser&&isAdminRole(currentUser.role);
    const hasEditPerm=hasPayrollEditPermission();
    let html='<table><thead><tr><th>Employee</th><th class="text-right">Gross</th><th class="text-right">NIS</th><th class="text-right">Ed. Tax</th><th class="text-right">Income Tax</th><th class="text-right">NHT</th><th class="text-right">HEART</th><th class="text-right">Total Ded.</th><th class="text-right">Net Pay</th><th>Payslip</th>'+(hasEditPerm?'<th>Actions</th>':'')+'</tr></thead><tbody>';
    let totals={gross:0,nis:0,ed:0,it:0,nht:0,heart:0,ded:0,net:0};
    const runIdx=DATA.payrollRuns.indexOf(existingRun);
    existingRun.results.forEach((r,ri)=>{
      const empIdx=DATA.employees.findIndex(e=>e.name===r.empName);
      html+=`<tr><td>${r.empName}</td><td class="mono text-right">${fmt(r.gross)}</td><td class="mono text-right">${fmt(r.nisEmp)}</td><td class="mono text-right">${fmt(r.edTaxEmp)}</td><td class="mono text-right">${fmt(r.incomeTax)}</td><td class="mono text-right">${fmt(r.nhtEmp)}</td><td class="mono text-right">${fmt(r.heartEr)}</td><td class="mono text-right">${fmt(r.totalEmpDeductions)}</td><td class="mono text-right" style="color:var(--green);font-weight:600">${fmt(r.netPay)}</td><td>${empIdx>=0?'<span class="payslip-link" onclick="viewPayslipFromPayroll('+empIdx+','+runIdx+')">View Payslip</span>':''}</td>`;
      if(hasEditPerm){
        html+=`<td><div class="btn-group"><button class="btn btn-ghost btn-sm" onclick="editPayrollEntry(${runIdx},${ri})">Edit</button><button class="btn btn-danger btn-sm" onclick="deletePayrollEntry(${runIdx},${ri})">Del</button></div></td>`;
      }
      html+=`</tr>`;
      totals.gross+=r.gross;totals.nis+=r.nisEmp;totals.ed+=r.edTaxEmp;totals.it+=r.incomeTax;totals.nht+=r.nhtEmp;totals.heart+=r.heartEr;totals.ded+=r.totalEmpDeductions;totals.net+=r.netPay;
    });
    html+=`<tr style="font-weight:700;border-top:2px solid var(--border)"><td>TOTAL</td><td class="mono text-right">${fmt(totals.gross)}</td><td class="mono text-right">${fmt(totals.nis)}</td><td class="mono text-right">${fmt(totals.ed)}</td><td class="mono text-right">${fmt(totals.it)}</td><td class="mono text-right">${fmt(totals.nht)}</td><td class="mono text-right">${fmt(totals.heart)}</td><td class="mono text-right">${fmt(totals.ded)}</td><td class="mono text-right" style="color:var(--green)">${fmt(totals.net)}</td><td></td>${hasEditPerm?'<td></td>':''}</tr>`;
    html+='</tbody></table>';
    document.getElementById('payrollResults').innerHTML=html;
    document.getElementById('payrollResultsPanel').style.display='block';
    document.getElementById('payrollResultsPanel').querySelector('.panel-head h3').textContent='Recorded Payroll \u2014 '+MONTH_NAMES[month]+' '+year;
    // Show admin action buttons for saved payroll
    const panelHead=document.getElementById('payrollResultsPanel').querySelector('.panel-head');
    const saveBtn=panelHead.querySelector('.btn-primary');
    if(saveBtn)saveBtn.style.display='none';
    // Remove old admin action buttons if they exist
    const oldBtns=panelHead.querySelector('.payroll-admin-btns');
    if(oldBtns)oldBtns.remove();
    if(hasEditPerm){
      const adminBtns=document.createElement('div');
      adminBtns.className='payroll-admin-btns';
      adminBtns.style.cssText='display:flex;gap:.5rem;align-items:center';
      adminBtns.innerHTML='<button class="btn btn-ghost btn-sm" onclick="recalculateExistingPayroll('+runIdx+')" title="Unlock payroll for editing gross values">‚úèÔ∏è Edit & Recalculate</button>'+
        '<button class="btn btn-danger btn-sm" onclick="deleteEntirePayrollRun('+runIdx+')" title="Delete entire payroll run">üóëÔ∏è Delete Run</button>';
      panelHead.appendChild(adminBtns);
    }
  }else{
    document.getElementById('payrollResultsPanel').style.display='none';
  }

  // Highlight active month card
  const cards=document.querySelectorAll('.month-card');
  const qDef=QUARTER_MONTHS[payrollQuarter];
  cards.forEach((card,i)=>{
    card.classList.remove('active');
    if(qDef.months[i]===month)card.classList.add('active');
  });
}

function renderQuarterHistory(){
  const qDef=QUARTER_MONTHS[payrollQuarter];
  const calYear=getCalendarYear(fyStartYear,payrollQuarter);
  const monthRuns=getQuarterRunsByMonth(fyStartYear,qDef,payrollQuarter);
  document.getElementById('quarterHistoryTitle').textContent=qDef.label+' Payroll History \u2014 '+getFYLabel(fyStartYear);

  let hasAny=monthRuns.some(r=>r!==null);
  if(!hasAny){
    document.getElementById('quarterHistory').innerHTML='<div style="text-align:center;color:var(--text-muted);padding:2rem">No payroll runs recorded for '+qDef.label+' '+getFYLabel(fyStartYear)+'</div>';
    return;
  }

  let html='<table><thead><tr><th>Month</th><th>Pay Date</th><th class="text-right">Gross</th><th class="text-right">Net Pay</th><th class="text-right">Emp Deductions</th><th class="text-right">Er Contributions</th><th>Employees</th><th>Actions</th></tr></thead><tbody>';
  qDef.months.forEach((m,mi)=>{
    const run=monthRuns[mi];
    if(!run){
      html+=`<tr><td>${qDef.names[mi]}</td><td colspan="6" style="color:var(--text-muted)">Not yet recorded</td><td><button class="btn btn-primary btn-sm" onclick="selectPayrollMonth(${calYear},${m})">Run Payroll</button></td></tr>`;
      return;
    }
    const g=run.results.reduce((s,x)=>s+x.gross,0);
    const n=run.results.reduce((s,x)=>s+x.netPay,0);
    const ed=run.results.reduce((s,x)=>s+x.totalEmpDeductions,0);
    const er=run.results.reduce((s,x)=>s+x.totalErContributions,0);
    html+=`<tr>
      <td style="font-weight:600">${qDef.names[mi]}</td>
      <td>${fmtDate(run.date)}</td>
      <td class="mono text-right">${fmt(g)}</td>
      <td class="mono text-right" style="color:var(--green)">${fmt(n)}</td>
      <td class="mono text-right">${fmt(ed)}</td>
      <td class="mono text-right">${fmt(er)}</td>
      <td>${run.results.length}</td>
      <td><span class="payslip-link" onclick="selectPayrollMonth(${calYear},${m})">View Details</span></td>
    </tr>`;
  });
  html+='</tbody></table>';
  document.getElementById('quarterHistory').innerHTML=html;
}

function viewPayslipFromPayroll(empIdx,runIdx){
  // Navigate to payslips page with selections pre-filled
  showPage('payslips');
  setTimeout(()=>{
    document.getElementById('payslipEmployee').value=empIdx;
    document.getElementById('payslipCycle').value=runIdx;
    generatePayslipPreview();
  },50);
}

function fillDefaultSalaries(){
  DATA.employees.forEach((e,i)=>{
    const inp=document.getElementById('grossInput_'+i);
    if(inp)inp.value=e.salary||0;
  });
}

function calculatePayroll(){
  if(!checkPayrollPermission('calculate payroll'))return;
  const s=DATA.settings;
  const monthlyThreshold=s.annualThreshold/12;
  const monthlyHigherBracket=(s.higherBracketAnnual||6000000)/12;
  const nisCeiling=s.nisCeilingMonthly||416667;
  const results=[];

  DATA.employees.forEach((e,i)=>{
    const gross=parseFloat(document.getElementById('grossInput_'+i)?.value)||0;

    // NIS ‚Äî capped at ceiling
    const nisableGross=Math.min(gross,nisCeiling);
    const nisEmp=nisableGross*(s.nisEmp/100);
    const nisEr=nisableGross*(s.nisEr/100);

    // NHT ‚Äî no cap
    const nhtEmp=gross*(s.nhtEmp/100);
    const nhtEr=gross*(s.nhtEr/100);

    // Statutory income for Education Tax = Gross - NIS employee
    const statutoryIncome=gross-nisEmp;
    const edTaxEmp=statutoryIncome*(s.edTaxEmp/100);
    const edTaxEr=statutoryIncome*(s.edTaxEr/100);

    // HEART/NSTA ‚Äî employer only
    const heartEr=gross*((s.heartEr||3)/100);

    // Income Tax ‚Äî progressive: 25% up to $6M bracket, 30% above
    // Chargeable income = Gross - NIS - NHT (approved deductions)
    const chargeableIncome=gross-nisEmp-nhtEmp;
    let incomeTax=0;
    if(chargeableIncome>monthlyThreshold){
      const taxable=chargeableIncome-monthlyThreshold;
      const standardBand=monthlyHigherBracket-monthlyThreshold;
      if(taxable<=standardBand){
        incomeTax=taxable*(s.incomeTax/100);
      }else{
        incomeTax=standardBand*(s.incomeTax/100)+(taxable-standardBand)*((s.incomeTaxHigher||30)/100);
      }
    }

    const totalEmpDeductions=nisEmp+edTaxEmp+nhtEmp+incomeTax;
    const totalErContributions=nisEr+edTaxEr+nhtEr+heartEr;
    const netPay=gross-totalEmpDeductions;

    results.push({
      empName:e.name,empType:e.type,designation:e.designation,trn:e.trn,nis:e.nis,
      gross,nisEmp,nisEr,edTaxEmp,edTaxEr,nhtEmp,nhtEr,heartEr,incomeTax,
      totalEmpDeductions,totalErContributions,netPay
    });
  });

  // Display results
  let html='<table><thead><tr><th>Employee</th><th class="text-right">Gross</th><th class="text-right">NIS</th><th class="text-right">Ed. Tax</th><th class="text-right">Income Tax</th><th class="text-right">NHT</th><th class="text-right">HEART</th><th class="text-right">Total Ded.</th><th class="text-right">Net Pay</th></tr></thead><tbody>';
  let totals={gross:0,nis:0,ed:0,it:0,nht:0,heart:0,ded:0,net:0};
  results.forEach(r=>{
    html+=`<tr><td>${r.empName}</td><td class="mono text-right">${fmt(r.gross)}</td><td class="mono text-right">${fmt(r.nisEmp)}</td><td class="mono text-right">${fmt(r.edTaxEmp)}</td><td class="mono text-right">${fmt(r.incomeTax)}</td><td class="mono text-right">${fmt(r.nhtEmp)}</td><td class="mono text-right">${fmt(r.heartEr)}</td><td class="mono text-right">${fmt(r.totalEmpDeductions)}</td><td class="mono text-right" style="color:var(--green);font-weight:600">${fmt(r.netPay)}</td></tr>`;
    totals.gross+=r.gross;totals.nis+=r.nisEmp;totals.ed+=r.edTaxEmp;totals.it+=r.incomeTax;totals.nht+=r.nhtEmp;totals.heart+=r.heartEr;totals.ded+=r.totalEmpDeductions;totals.net+=r.netPay;
  });
  html+=`<tr style="font-weight:700;border-top:2px solid var(--border)"><td>TOTAL</td><td class="mono text-right">${fmt(totals.gross)}</td><td class="mono text-right">${fmt(totals.nis)}</td><td class="mono text-right">${fmt(totals.ed)}</td><td class="mono text-right">${fmt(totals.it)}</td><td class="mono text-right">${fmt(totals.nht)}</td><td class="mono text-right">${fmt(totals.heart)}</td><td class="mono text-right">${fmt(totals.ded)}</td><td class="mono text-right" style="color:var(--green)">${fmt(totals.net)}</td></tr>`;
  html+='</tbody></table>';
  document.getElementById('payrollResults').innerHTML=html;
  document.getElementById('payrollResultsPanel').style.display='block';
  document.getElementById('payrollResultsPanel').querySelector('.panel-head h3').textContent='Payroll Results';
  // Show the save button
  const saveBtn=document.getElementById('payrollResultsPanel').querySelector('.btn-primary');
  if(saveBtn)saveBtn.style.display='';
  window._pendingPayroll={date:document.getElementById('payCycleDate').value,results};
}

function savePayrollRun(){
  if(!checkPayrollPermission('save payroll data'))return;
  if(!window._pendingPayroll){alert('Calculate payroll first');return;}

  // Check if a payroll already exists for this month
  const pendingDate=parseLocalDate(window._pendingPayroll.date);
  const pendingMonth=pendingDate.getMonth();
  const pendingYear=pendingDate.getFullYear();
  const existing=DATA.payrollRuns.find(r=>{
    const d=parseLocalDate(r.date);
    return d.getFullYear()===pendingYear&&d.getMonth()===pendingMonth;
  });
  if(existing){
    if(!confirm('A payroll run already exists for '+MONTH_NAMES[pendingMonth]+' '+pendingYear+'. Replace it?'))return;
    const idx=DATA.payrollRuns.indexOf(existing);
    DATA.payrollRuns.splice(idx,1);
  }

  DATA.payrollRuns.push(window._pendingPayroll);
  saveStore();
  window._pendingPayroll=null;
  alert('Payroll saved successfully!');
  renderPayrollInput(); // Refresh to show updated quarter status
  refreshActiveSections(); // Sync salary records, dashboard, etc.
}

// ==================== PAYROLL EDIT/DELETE (ADMIN) ====================
function editPayrollEntry(runIdx,entryIdx){
  if(!checkPayrollPermission('edit payroll entry'))return;
  const run=DATA.payrollRuns[runIdx];
  if(!run||!run.results[entryIdx])return;
  const r=run.results[entryIdx];
  const newGross=prompt('Edit gross earnings for '+r.empName+':\n\nCurrent gross: $'+fmt(r.gross)+'\n\nEnter new gross amount:',r.gross.toFixed(2));
  if(newGross===null)return;
  const gross=parseFloat(newGross);
  if(isNaN(gross)||gross<0){alert('Invalid amount');return;}
  // Recalculate this employee's deductions with new gross
  const s=DATA.settings;
  const monthlyThreshold=s.annualThreshold/12;
  const monthlyHigherBracket=(s.higherBracketAnnual||6000000)/12;
  const nisCeiling=s.nisCeilingMonthly||416667;
  const emp=DATA.employees.find(e=>e.name===r.empName);
  const empType=emp?emp.type:r.empType;
  const nisableGross=Math.min(gross,nisCeiling);
  const nisEmp=empType==='contractual'?0:Math.round(nisableGross*s.nisEmp/100*100)/100;
  const nisEr=empType==='contractual'?0:Math.round(nisableGross*s.nisEr/100*100)/100;
  const edTaxEmp=empType==='contractual'?0:Math.round(gross*s.edTaxEmp/100*100)/100;
  const edTaxEr=empType==='contractual'?0:Math.round(gross*s.edTaxEr/100*100)/100;
  const nhtEmp=empType==='contractual'?0:Math.round(gross*s.nhtEmp/100*100)/100;
  const nhtEr=empType==='contractual'?0:Math.round(gross*s.nhtEr/100*100)/100;
  const heartEr=empType==='contractual'?0:Math.round(gross*s.heartEr/100*100)/100;
  const taxableIncome=empType==='contractual'?gross:gross-nisEmp-nhtEmp;
  let incomeTax=0;
  if(taxableIncome>monthlyThreshold){
    const taxableBand=taxableIncome-monthlyThreshold;
    if(taxableIncome<=monthlyHigherBracket){
      incomeTax=Math.round(taxableBand*s.incomeTax/100*100)/100;
    }else{
      const lowerBand=monthlyHigherBracket-monthlyThreshold;
      const upperBand=taxableIncome-monthlyHigherBracket;
      incomeTax=Math.round((lowerBand*s.incomeTax/100+upperBand*(s.incomeTaxHigher||30)/100)*100)/100;
    }
  }
  const totalEmpDeductions=nisEmp+edTaxEmp+nhtEmp+incomeTax;
  const totalErContributions=nisEr+edTaxEr+nhtEr+heartEr;
  const netPay=Math.round((gross-totalEmpDeductions)*100)/100;
  // Update the entry
  Object.assign(run.results[entryIdx],{gross,nisEmp,nisEr,edTaxEmp,edTaxEr,nhtEmp,nhtEr,heartEr,incomeTax,totalEmpDeductions,totalErContributions,netPay});
  saveStore();
  // Re-render the same month
  const d=parseLocalDate(run.date);
  selectPayrollMonth(d.getFullYear(),d.getMonth());
  refreshActiveSections();
}

function deletePayrollEntry(runIdx,entryIdx){
  if(!checkPayrollPermission('delete payroll entry'))return;
  const run=DATA.payrollRuns[runIdx];
  if(!run||!run.results[entryIdx])return;
  const r=run.results[entryIdx];
  if(!confirm('Delete payroll entry for '+r.empName+'?\n\nGross: $'+fmt(r.gross)+' | Net: $'+fmt(r.netPay)+'\n\nThis action cannot be undone.'))return;
  run.results.splice(entryIdx,1);
  // If no results left, remove entire run
  if(run.results.length===0){
    DATA.payrollRuns.splice(runIdx,1);
  }
  saveStore();
  renderPayrollInput();
  refreshActiveSections();
}

function deleteEntirePayrollRun(runIdx){
  if(!checkPayrollPermission('delete payroll run'))return;
  const run=DATA.payrollRuns[runIdx];
  if(!run)return;
  const d=parseLocalDate(run.date);
  if(!confirm('DELETE ENTIRE PAYROLL RUN\n\n'+MONTH_NAMES[d.getMonth()]+' '+d.getFullYear()+'\n\n'+run.results.length+' employee records will be permanently deleted.\n\nThis action cannot be undone. Continue?'))return;
  DATA.payrollRuns.splice(runIdx,1);
  saveStore();
  renderPayrollInput();
  refreshActiveSections();
  alert('Payroll run deleted successfully.');
}

function recalculateExistingPayroll(runIdx){
  if(!checkPayrollPermission('edit payroll'))return;
  const run=DATA.payrollRuns[runIdx];
  if(!run)return;
  const d=parseLocalDate(run.date);
  // Set the payroll date
  document.getElementById('payCycleDate').value=run.date;
  document.getElementById('payrollFormTitle').textContent='Edit Payroll \u2014 '+MONTH_NAMES[d.getMonth()]+' '+d.getFullYear();
  // Populate gross inputs from existing run
  DATA.employees.forEach((e,i)=>{
    const inp=document.getElementById('grossInput_'+i);
    if(inp){
      const existing=run.results.find(r=>r.empName===e.name);
      inp.value=existing?existing.gross:0;
    }
  });
  // Scroll to input section
  document.getElementById('payrollResultsPanel').style.display='none';
  const inputSection=document.getElementById('payrollInput');
  if(inputSection)inputSection.scrollIntoView({behavior:'smooth',block:'start'});
}

// ==================== PAYSLIPS ====================
function populatePayslipSelects(){
  const empSel=document.getElementById('payslipEmployee');
  const cycSel=document.getElementById('payslipCycle');
  empSel.innerHTML='<option value="">‚Äî Select ‚Äî</option>';
  DATA.employees.forEach((e,i)=>{empSel.innerHTML+=`<option value="${i}">${e.name} (${e.type})</option>`;});
  cycSel.innerHTML='<option value="">‚Äî Select ‚Äî</option>';
  DATA.payrollRuns.forEach((r,i)=>{cycSel.innerHTML+=`<option value="${i}">${fmtDate(r.date)}</option>`;});
}

function generatePayslipPreview(){
  const empIdx=parseInt(document.getElementById('payslipEmployee').value);
  const cycIdx=parseInt(document.getElementById('payslipCycle').value);
  if(isNaN(empIdx)||isNaN(cycIdx)){alert('Select both employee and pay cycle');return;}
  const emp=DATA.employees[empIdx];
  const run=DATA.payrollRuns[cycIdx];
  const result=run.results.find(r=>r.empName===emp.name);
  if(!result){alert('No payroll data found for this employee in selected cycle');return;}

  // Calculate YTD ‚Äî only for same calendar year
  const runYear=parseLocalDate(run.date).getFullYear();
  let ytd={nis:0,edTax:0,nht:0,incomeTax:0,gross:0,heartEr:0,netPay:0};
  DATA.payrollRuns.forEach((r,ri)=>{
    if(ri>cycIdx)return;
    if(parseLocalDate(r.date).getFullYear()!==runYear)return;
    const match=r.results.find(x=>x.empName===emp.name);
    if(match){ytd.nis+=match.nisEmp;ytd.edTax+=match.edTaxEmp;ytd.nht+=match.nhtEmp;ytd.incomeTax+=match.incomeTax;ytd.gross+=match.gross;ytd.heartEr+=(match.heartEr||0);ytd.netPay+=match.netPay;}
  });

  const psHtml=buildPayslipHTML(emp,result,run.date,ytd);
  document.getElementById('payslipPreviewArea').innerHTML=`
    <div class="panel" style="margin-top:1rem">
      <div class="panel-head"><h3>Payslip Preview</h3><div class="btn-group"><button class="btn btn-primary btn-sm" onclick="printPayslip()">üñ® Print / Save as PDF</button></div></div>
      <div class="panel-body">${psHtml}</div>
    </div>`;
  document.getElementById('payslipPrintArea').innerHTML=psHtml.replace('payslip-preview','payslip-print');
}

function buildPayslipHTML(emp,result,date,ytd){
  return `<div class="payslip-preview">
    <div class="ps-header">
      <p style="font-size:.85rem;font-weight:700;color:#1a2540;margin-bottom:.25rem">Community Educational and Skills Training Institute and Services Limited</p>
      <p style="font-size:1rem;font-weight:400;color:#666;letter-spacing:2px;margin-top:.15rem">C.E.S.T.I.S</p>
      <p style="font-weight:600;margin-top:.5rem">EMPLOYEE PAY ADVICE SLIP</p>
    </div>
    <div class="ps-info">
      <div class="row"><span class="lbl">Employee Name:</span><span class="val">${result.empName}</span></div>
      <div class="row"><span class="lbl">Pay Cycle:</span><span class="val">${fmtDate(date)}</span></div>
      <div class="row"><span class="lbl">TRN:</span><span class="val">${result.trn||'‚Äî'}</span></div>
      <div class="row"><span class="lbl">NIS #:</span><span class="val">${result.nis||'‚Äî'}</span></div>
      <div class="row"><span class="lbl">Position:</span><span class="val">${result.designation||'‚Äî'}</span></div>
      <div class="row"><span class="lbl">Type:</span><span class="val">${result.empType==='FT'?'Full-Time':'Part-Time'}</span></div>
    </div>
    <table class="ps-table">
      <thead><tr><th>Description</th><th style="text-align:right">Employee</th><th style="text-align:right">Employer</th><th style="text-align:right">Year-to-Date</th></tr></thead>
      <tbody>
        <tr><td>NIS</td><td class="amt">${fmt(result.nisEmp)}</td><td class="amt">${fmt(result.nisEr)}</td><td class="amt">${fmt(ytd.nis)}</td></tr>
        <tr><td>Income Tax</td><td class="amt">${fmt(result.incomeTax)}</td><td class="amt">‚Äî</td><td class="amt">${fmt(ytd.incomeTax)}</td></tr>
        <tr><td>Education Tax</td><td class="amt">${fmt(result.edTaxEmp)}</td><td class="amt">${fmt(result.edTaxEr)}</td><td class="amt">${fmt(ytd.edTax)}</td></tr>
        <tr><td>NHT</td><td class="amt">${fmt(result.nhtEmp)}</td><td class="amt">${fmt(result.nhtEr)}</td><td class="amt">${fmt(ytd.nht)}</td></tr>
        <tr><td>HEART/NSTA</td><td class="amt">‚Äî</td><td class="amt">${fmt(result.heartEr||0)}</td><td class="amt">${fmt(ytd.heartEr)}</td></tr>
        <tr style="font-weight:700;border-top:2px solid #1a2540"><td>Month-to-Date</td><td class="amt">${fmt(result.totalEmpDeductions)}</td><td class="amt">${fmt(result.totalErContributions)}</td><td class="amt"></td></tr>
      </tbody>
    </table>
    <div class="ps-totals">
      <div class="box"><div class="lbl">Gross Earnings</div><div class="val">${fmt(result.gross)}</div></div>
      <div class="box"><div class="lbl">Total Deductions</div><div class="val" style="color:#ef4444">${fmt(result.totalEmpDeductions)}</div></div>
      <div class="box" style="border-color:#10b981"><div class="lbl">Net Pay</div><div class="val" style="color:#10b981">${fmt(result.netPay)}</div></div>
    </div>
    <div class="ps-footer">This is a computer-generated payslip. For queries, contact the Project Coordinator.</div>
  </div>`;
}

function printPayslip(){
  const area=document.getElementById('payslipPrintArea');
  area.style.display='block';
  window.print();
  setTimeout(()=>{area.style.display='none';},500);
}

// ==================== SALARY RECORDS ====================
const MONTH_NAMES=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

function parseLocalDate(dateStr){
  if(!dateStr)return new Date(NaN);
  const parts=dateStr.split('T')[0].split('-');
  return new Date(parseInt(parts[0]),parseInt(parts[1])-1,parseInt(parts[2]));
}

function getMonthlyData(year){
  const monthly={};
  const nameLookup={};
  DATA.employees.forEach(e=>{
    monthly[e.name]=Array.from({length:12},()=>null);
    nameLookup[e.name.trim().toLowerCase()]=e.name;
  });
  DATA.payrollRuns.forEach(run=>{
    const d=parseLocalDate(run.date);
    if(d.getFullYear()!==year)return;
    const m=d.getMonth();
    run.results.forEach(r=>{
      if(!r.empName)return;
      let key=r.empName;
      if(!monthly[key]){
        const normalized=r.empName.trim().toLowerCase();
        if(nameLookup[normalized]){key=nameLookup[normalized];}
        else return; // Skip employees not in current list (deleted)
      }
      monthly[key][m]={gross:r.gross,netPay:r.netPay,nisEmp:r.nisEmp,nisEr:r.nisEr,edTaxEmp:r.edTaxEmp,edTaxEr:r.edTaxEr,nhtEmp:r.nhtEmp,nhtEr:r.nhtEr,heartEr:r.heartEr||0,incomeTax:r.incomeTax,totalEmpDeductions:r.totalEmpDeductions,totalErContributions:r.totalErContributions};
    });
  });
  return monthly;
}

// Salary Records FY/Quarter state and navigation
const FY_MONTH_NAMES=['Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec','Jan','Feb','Mar'];
let srFYStartYear=fyStartYear;
let srQuarter=-1; // -1=All, 0=Q1, 1=Q2, 2=Q3, 3=Q4

function getFYMonthlyData(fyStart){
  const dataY1=getMonthlyData(fyStart);
  const dataY2=getMonthlyData(fyStart+1);
  const allNames=new Set([...Object.keys(dataY1),...Object.keys(dataY2)]);
  const fyData={};
  allNames.forEach(name=>{
    const d1=dataY1[name]||Array.from({length:12},()=>null);
    const d2=dataY2[name]||Array.from({length:12},()=>null);
    fyData[name]=[d1[3],d1[4],d1[5],d1[6],d1[7],d1[8],d1[9],d1[10],d1[11],d2[0],d2[1],d2[2]];
  });
  return fyData;
}

function changeSRFY(delta){srFYStartYear+=delta;renderSalaryRecords();}
function changeSRQuarter(delta){
  srQuarter+=delta;
  if(srQuarter>3){srQuarter=-1;srFYStartYear++;}
  if(srQuarter<-1){srQuarter=3;srFYStartYear--;}
  renderSalaryRecords();
}
function setSRQuarter(qi){srQuarter=qi;renderSalaryRecords();}

function renderSalaryRecords(){
  // Build quarter navigation (matches payroll page style)
  let navHtml='<div class="fy-selector">';
  navHtml+='<button class="fy-arrow" onclick="changeSRFY(-1)" title="Previous Fiscal Year">\u25C4</button>';
  navHtml+='<span class="fy-label">'+getFYLabel(srFYStartYear)+'</span>';
  navHtml+='<button class="fy-arrow" onclick="changeSRFY(1)" title="Next Fiscal Year">\u25BA</button>';
  navHtml+='</div><div class="quarter-tabs">';
  navHtml+='<button class="quarter-tab'+(srQuarter===-1?' active':'')+'" onclick="setSRQuarter(-1)">All<span class="q-sub">\u00B7 Full Year</span></button>';
  QUARTER_MONTHS.forEach(function(q,qi){
    navHtml+='<button class="quarter-tab'+(qi===srQuarter?' active':'')+'" onclick="setSRQuarter('+qi+')">'+q.label+'<span class="q-sub">\u00B7 '+q.sub+'</span></button>';
  });
  navHtml+='</div><div class="qtr-nav-btns">';
  navHtml+='<button class="qtr-nav-btn" onclick="changeSRQuarter(-1)">\u25C4 Prev Qtr</button>';
  navHtml+='<button class="qtr-nav-btn" onclick="changeSRQuarter(1)">Next Qtr \u25BA</button>';
  navHtml+='</div>';
  document.getElementById('srQuarterNav').innerHTML=navHtml;

  var fyMonthly=getFYMonthlyData(srFYStartYear);
  var empNames=Object.keys(fyMonthly);
  var displayIndices,displayNames,totalLabel,periodLabel;
  if(srQuarter===-1){
    displayIndices=[0,1,2,3,4,5,6,7,8,9,10,11];
    displayNames=FY_MONTH_NAMES;
    totalLabel='Annual Total';
    periodLabel=getFYLabel(srFYStartYear);
  }else{
    var si=srQuarter*3;
    displayIndices=[si,si+1,si+2];
    displayNames=[FY_MONTH_NAMES[si],FY_MONTH_NAMES[si+1],FY_MONTH_NAMES[si+2]];
    totalLabel=QUARTER_MONTHS[srQuarter].label+' Total';
    periodLabel=QUARTER_MONTHS[srQuarter].label+' \u2014 '+getFYLabel(srFYStartYear);
  }

  document.getElementById('srTableTitle').textContent=
    srQuarter===-1?'Monthly Salary Records \u2014 '+getFYLabel(srFYStartYear)
                  :QUARTER_MONTHS[srQuarter].label+' Salary Records \u2014 '+getFYLabel(srFYStartYear);

  var colCount=displayIndices.length+2;
  var html='<table><thead><tr><th>Employee</th>';
  displayNames.forEach(function(m){html+='<th class="text-right">'+m+'</th>';});
  html+='<th class="text-right" style="background:rgba(59,130,246,.15);color:#60a5fa">'+totalLabel+'</th></tr></thead><tbody>';

  var grandMonthly=displayIndices.map(function(){return 0;});
  var grandTotal=0;

  empNames.forEach(function(name){
    var emp=DATA.employees.find(function(e){return e.name===name;});
    var data=fyMonthly[name];
    var periodTotal=0;
    var typeTag=emp?'<span class="tag '+(emp.type==='FT'?'tag-ft':'tag-pt')+'" style="margin-left:.3rem">'+emp.type+'</span>':'';
    html+='<tr><td>'+name+' '+typeTag+'</td>';
    displayIndices.forEach(function(fi,di){
      var val=data[fi]?data[fi].gross:0;
      periodTotal+=val;
      grandMonthly[di]+=val;
      html+='<td class="mono text-right">'+(val?fmt(val):'<span style="color:var(--text-muted)">\u2014</span>')+'</td>';
    });
    grandTotal+=periodTotal;
    html+='<td class="mono text-right" style="font-weight:600;background:rgba(59,130,246,.05)">'+fmt(periodTotal)+'</td></tr>';
  });

  html+='<tr style="font-weight:700;border-top:2px solid var(--border)"><td>MONTHLY TOTAL</td>';
  grandMonthly.forEach(function(v){html+='<td class="mono text-right">'+(v?fmt(v):'\u2014')+'</td>';});
  html+='<td class="mono text-right" style="color:var(--primary);background:rgba(59,130,246,.1)">'+fmt(grandTotal)+'</td></tr>';

  var netMonthly=displayIndices.map(function(){return 0;});
  var netTotal=0;
  empNames.forEach(function(name){
    var data=fyMonthly[name];
    displayIndices.forEach(function(fi,di){
      if(data[fi]){netMonthly[di]+=data[fi].netPay;netTotal+=data[fi].netPay;}
    });
  });
  html+='<tr style="font-weight:700;color:var(--green)"><td>NET PAY TOTAL</td>';
  netMonthly.forEach(function(v){html+='<td class="mono text-right">'+(v?fmt(v):'\u2014')+'</td>';});
  html+='<td class="mono text-right" style="background:rgba(16,185,129,.1)">'+fmt(netTotal)+'</td></tr>';

  if(empNames.length===0)html+='<tr><td colspan="'+colCount+'" style="text-align:center;color:var(--text-muted);padding:2rem">No employees or payroll data</td></tr>';
  html+='</tbody></table>';
  document.getElementById('salaryRecordsTable').innerHTML=html;

  var totalDeductions=grandTotal-netTotal;
  var erTotal=0;
  empNames.forEach(function(name){
    var data=fyMonthly[name];
    displayIndices.forEach(function(fi){if(data[fi])erTotal+=data[fi].totalErContributions;});
  });
  var monthsWithData=grandMonthly.filter(function(v){return v>0;}).length;
  var statsPrefix=srQuarter===-1?'Annual':'Quarter';
  document.getElementById('salaryRecordStats').innerHTML=
    '<div class="stat-card blue"><div class="label">'+statsPrefix+' Gross</div><div class="value mono">'+fmt(grandTotal)+'</div><div class="sub">'+periodLabel+' \u2014 '+monthsWithData+' month(s) recorded</div></div>'+
    '<div class="stat-card green"><div class="label">'+statsPrefix+' Net Pay</div><div class="value mono">'+fmt(netTotal)+'</div><div class="sub">After all employee deductions</div></div>'+
    '<div class="stat-card red"><div class="label">Employee Deductions</div><div class="value mono">'+fmt(totalDeductions)+'</div><div class="sub">NIS + Ed Tax + NHT + Income Tax</div></div>'+
    '<div class="stat-card gold"><div class="label">Employer Contributions</div><div class="value mono">'+fmt(erTotal)+'</div><div class="sub">NIS + Ed Tax + NHT + HEART</div></div>';

  renderSRQuarterlyTables(fyMonthly,empNames);
}

function renderSRQuarterlyTables(fyMonthly,empNames){
  var quarters=[
    {label:'Q1 (Apr\u2013Jun)',indices:[0,1,2]},
    {label:'Q2 (Jul\u2013Sep)',indices:[3,4,5]},
    {label:'Q3 (Oct\u2013Dec)',indices:[6,7,8]},
    {label:'Q4 (Jan\u2013Mar)',indices:[9,10,11]}
  ];

  if(srQuarter===-1){
    // Full year: aggregated quarterly summary
    document.getElementById('quarterlySummaryPanel').style.display='';
    document.getElementById('quarterlySummaryTitle').textContent='Quarterly Summary \u2014 '+getFYLabel(srFYStartYear);
    var qhtml='<table><thead><tr><th>Quarter</th><th class="text-right">Gross Pay</th><th class="text-right">NIS (Emp)</th><th class="text-right">Ed. Tax (Emp)</th><th class="text-right">NHT (Emp)</th><th class="text-right">Income Tax</th><th class="text-right">Total Emp Ded.</th><th class="text-right">Net Pay</th><th class="text-right">NIS (Er)</th><th class="text-right">Ed. Tax (Er)</th><th class="text-right">NHT (Er)</th><th class="text-right">HEART (Er)</th><th class="text-right">Total Er Contr.</th></tr></thead><tbody>';
    var annTotals={gross:0,nisE:0,edE:0,nhtE:0,it:0,empDed:0,net:0,nisR:0,edR:0,nhtR:0,heartR:0,erC:0};
    quarters.forEach(function(q){
      var t={gross:0,nisE:0,edE:0,nhtE:0,it:0,empDed:0,net:0,nisR:0,edR:0,nhtR:0,heartR:0,erC:0};
      empNames.forEach(function(name){
        var data=fyMonthly[name];
        q.indices.forEach(function(fi){
          if(data[fi]){
            t.gross+=data[fi].gross;t.nisE+=data[fi].nisEmp;t.edE+=data[fi].edTaxEmp;t.nhtE+=data[fi].nhtEmp;
            t.it+=data[fi].incomeTax;t.empDed+=data[fi].totalEmpDeductions;t.net+=data[fi].netPay;
            t.nisR+=data[fi].nisEr;t.edR+=data[fi].edTaxEr;t.nhtR+=data[fi].nhtEr;t.heartR+=data[fi].heartEr;
            t.erC+=data[fi].totalErContributions;
          }
        });
      });
      Object.keys(annTotals).forEach(function(k){annTotals[k]+=t[k];});
      var hd=t.gross>0;
      qhtml+='<tr><td style="font-weight:600">'+q.label+'</td>'+
        '<td class="mono text-right">'+(hd?fmt(t.gross):'\u2014')+'</td>'+
        '<td class="mono text-right">'+(hd?fmt(t.nisE):'\u2014')+'</td>'+
        '<td class="mono text-right">'+(hd?fmt(t.edE):'\u2014')+'</td>'+
        '<td class="mono text-right">'+(hd?fmt(t.nhtE):'\u2014')+'</td>'+
        '<td class="mono text-right">'+(hd?fmt(t.it):'\u2014')+'</td>'+
        '<td class="mono text-right">'+(hd?fmt(t.empDed):'\u2014')+'</td>'+
        '<td class="mono text-right" style="color:var(--green)">'+(hd?fmt(t.net):'\u2014')+'</td>'+
        '<td class="mono text-right">'+(hd?fmt(t.nisR):'\u2014')+'</td>'+
        '<td class="mono text-right">'+(hd?fmt(t.edR):'\u2014')+'</td>'+
        '<td class="mono text-right">'+(hd?fmt(t.nhtR):'\u2014')+'</td>'+
        '<td class="mono text-right">'+(hd?fmt(t.heartR):'\u2014')+'</td>'+
        '<td class="mono text-right">'+(hd?fmt(t.erC):'\u2014')+'</td></tr>';
    });
    qhtml+='<tr style="font-weight:700;border-top:2px solid var(--border)"><td>ANNUAL TOTAL</td>'+
      '<td class="mono text-right">'+fmt(annTotals.gross)+'</td><td class="mono text-right">'+fmt(annTotals.nisE)+'</td>'+
      '<td class="mono text-right">'+fmt(annTotals.edE)+'</td><td class="mono text-right">'+fmt(annTotals.nhtE)+'</td>'+
      '<td class="mono text-right">'+fmt(annTotals.it)+'</td><td class="mono text-right">'+fmt(annTotals.empDed)+'</td>'+
      '<td class="mono text-right" style="color:var(--green)">'+fmt(annTotals.net)+'</td>'+
      '<td class="mono text-right">'+fmt(annTotals.nisR)+'</td><td class="mono text-right">'+fmt(annTotals.edR)+'</td>'+
      '<td class="mono text-right">'+fmt(annTotals.nhtR)+'</td><td class="mono text-right">'+fmt(annTotals.heartR)+'</td>'+
      '<td class="mono text-right">'+fmt(annTotals.erC)+'</td></tr>';
    qhtml+='</tbody></table>';
    document.getElementById('quarterlyTable').innerHTML=qhtml;

    // Per-employee quarterly breakdown
    document.getElementById('empQuarterlyPanel').style.display='';
    document.getElementById('empQuarterlyTitle').textContent='Per-Employee Quarterly Breakdown \u2014 '+getFYLabel(srFYStartYear);
    var eqhtml='<table><thead><tr><th>Employee</th><th class="text-right">Q1 Gross</th><th class="text-right">Q1 Net</th><th class="text-right">Q2 Gross</th><th class="text-right">Q2 Net</th><th class="text-right">Q3 Gross</th><th class="text-right">Q3 Net</th><th class="text-right">Q4 Gross</th><th class="text-right">Q4 Net</th><th class="text-right">Annual Gross</th><th class="text-right">Annual Net</th></tr></thead><tbody>';
    var qTotals=[{gross:0,net:0},{gross:0,net:0},{gross:0,net:0},{gross:0,net:0}];
    var aTotals={gross:0,net:0};
    empNames.forEach(function(name){
      var emp=DATA.employees.find(function(e){return e.name===name;});
      var data=fyMonthly[name];
      var empAG=0,empAN=0;
      var typeTag=emp?'<span class="tag '+(emp.type==='FT'?'tag-ft':'tag-pt')+'" style="margin-left:.3rem">'+emp.type+'</span>':'';
      eqhtml+='<tr><td>'+name+' '+typeTag+'</td>';
      quarters.forEach(function(q,qi){
        var qg=0,qn=0;
        q.indices.forEach(function(fi){if(data[fi]){qg+=data[fi].gross;qn+=data[fi].netPay;}});
        empAG+=qg;empAN+=qn;
        qTotals[qi].gross+=qg;qTotals[qi].net+=qn;
        eqhtml+='<td class="mono text-right">'+(qg?fmt(qg):'\u2014')+'</td><td class="mono text-right" style="color:var(--green)">'+(qn?fmt(qn):'\u2014')+'</td>';
      });
      aTotals.gross+=empAG;aTotals.net+=empAN;
      eqhtml+='<td class="mono text-right" style="font-weight:600">'+fmt(empAG)+'</td><td class="mono text-right" style="font-weight:600;color:var(--green)">'+fmt(empAN)+'</td></tr>';
    });
    eqhtml+='<tr style="font-weight:700;border-top:2px solid var(--border)"><td>TOTAL</td>';
    quarters.forEach(function(q,qi){
      eqhtml+='<td class="mono text-right">'+fmt(qTotals[qi].gross)+'</td><td class="mono text-right" style="color:var(--green)">'+fmt(qTotals[qi].net)+'</td>';
    });
    eqhtml+='<td class="mono text-right">'+fmt(aTotals.gross)+'</td><td class="mono text-right" style="color:var(--green)">'+fmt(aTotals.net)+'</td></tr>';
    if(empNames.length===0)eqhtml+='<tr><td colspan="11" style="text-align:center;color:var(--text-muted);padding:2rem">No data</td></tr>';
    eqhtml+='</tbody></table>';
    document.getElementById('empQuarterlyTable').innerHTML=eqhtml;

  }else{
    // Quarter view: show per-employee deduction breakdown
    var q=quarters[srQuarter];
    var qDef=QUARTER_MONTHS[srQuarter];
    document.getElementById('quarterlySummaryPanel').style.display='';
    document.getElementById('quarterlySummaryTitle').textContent=qDef.label+' Deduction Summary \u2014 '+getFYLabel(srFYStartYear);
    var dhtml='<table><thead><tr><th>Employee</th><th class="text-right">Gross</th><th class="text-right">NIS</th><th class="text-right">Ed. Tax</th><th class="text-right">Income Tax</th><th class="text-right">NHT</th><th class="text-right">HEART</th><th class="text-right">Total Ded.</th><th class="text-right">Net Pay</th></tr></thead><tbody>';
    var totals={gross:0,nis:0,ed:0,it:0,nht:0,heart:0,ded:0,net:0};
    empNames.forEach(function(name){
      var emp=DATA.employees.find(function(e){return e.name===name;});
      var data=fyMonthly[name];
      var eg=0,en=0,eed=0,eit=0,enht=0,eh=0,ed=0,enet=0;
      q.indices.forEach(function(fi){
        if(data[fi]){eg+=data[fi].gross;en+=data[fi].nisEmp;eed+=data[fi].edTaxEmp;eit+=data[fi].incomeTax;enht+=data[fi].nhtEmp;eh+=data[fi].heartEr;ed+=data[fi].totalEmpDeductions;enet+=data[fi].netPay;}
      });
      totals.gross+=eg;totals.nis+=en;totals.ed+=eed;totals.it+=eit;totals.nht+=enht;totals.heart+=eh;totals.ded+=ed;totals.net+=enet;
      var typeTag=emp?'<span class="tag '+(emp.type==='FT'?'tag-ft':'tag-pt')+'" style="margin-left:.3rem">'+emp.type+'</span>':'';
      var hd=eg>0;
      dhtml+='<tr><td>'+name+' '+typeTag+'</td>'+
        '<td class="mono text-right">'+(hd?fmt(eg):'\u2014')+'</td>'+
        '<td class="mono text-right">'+(hd?fmt(en):'\u2014')+'</td>'+
        '<td class="mono text-right">'+(hd?fmt(eed):'\u2014')+'</td>'+
        '<td class="mono text-right">'+(hd?fmt(eit):'\u2014')+'</td>'+
        '<td class="mono text-right">'+(hd?fmt(enht):'\u2014')+'</td>'+
        '<td class="mono text-right">'+(hd?fmt(eh):'\u2014')+'</td>'+
        '<td class="mono text-right">'+(hd?fmt(ed):'\u2014')+'</td>'+
        '<td class="mono text-right" style="color:var(--green);font-weight:600">'+(hd?fmt(enet):'\u2014')+'</td></tr>';
    });
    dhtml+='<tr style="font-weight:700;border-top:2px solid var(--border)"><td>TOTAL</td>'+
      '<td class="mono text-right">'+fmt(totals.gross)+'</td><td class="mono text-right">'+fmt(totals.nis)+'</td>'+
      '<td class="mono text-right">'+fmt(totals.ed)+'</td><td class="mono text-right">'+fmt(totals.it)+'</td>'+
      '<td class="mono text-right">'+fmt(totals.nht)+'</td><td class="mono text-right">'+fmt(totals.heart)+'</td>'+
      '<td class="mono text-right">'+fmt(totals.ded)+'</td>'+
      '<td class="mono text-right" style="color:var(--green)">'+fmt(totals.net)+'</td></tr>';
    if(empNames.length===0)dhtml+='<tr><td colspan="9" style="text-align:center;color:var(--text-muted);padding:2rem">No data</td></tr>';
    dhtml+='</tbody></table>';
    document.getElementById('quarterlyTable').innerHTML=dhtml;
    document.getElementById('empQuarterlyPanel').style.display='none';
  }
}

function exportSalaryRecordsCSV(){
  var fyMonthly=getFYMonthlyData(srFYStartYear);
  var displayIndices,displayNames,fileLabel;
  if(srQuarter===-1){
    displayIndices=[0,1,2,3,4,5,6,7,8,9,10,11];
    displayNames=FY_MONTH_NAMES;
    fileLabel='FY'+srFYStartYear+'_'+(srFYStartYear+1);
  }else{
    var si=srQuarter*3;
    displayIndices=[si,si+1,si+2];
    displayNames=[FY_MONTH_NAMES[si],FY_MONTH_NAMES[si+1],FY_MONTH_NAMES[si+2]];
    fileLabel=QUARTER_MONTHS[srQuarter].label+'_FY'+srFYStartYear+'_'+(srFYStartYear+1);
  }
  var csv='Employee,Type,'+displayNames.join(',')+',Total\n';
  Object.keys(fyMonthly).forEach(function(name){
    var emp=DATA.employees.find(function(e){return e.name===name;});
    var data=fyMonthly[name];
    var total=0;
    csv+='"'+name+'",'+(emp?emp.type:'');
    displayIndices.forEach(function(fi){
      var val=data[fi]?data[fi].gross:0;
      total+=val;csv+=','+val.toFixed(2);
    });
    csv+=','+total.toFixed(2)+'\n';
  });
  var blob=new Blob([csv],{type:'text/csv'});
  var a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='CESTIS_SalaryRecords_'+fileLabel+'.csv';
  a.click();URL.revokeObjectURL(a.href);
}

// ==================== TAX SUMMARY ====================
function renderTaxSummary(){
  const runs=DATA.payrollRuns;
  let html='<table><thead><tr><th>Pay Date</th><th class="text-right">NIS (Emp+Er)</th><th class="text-right">Income Tax</th><th class="text-right">Ed. Tax (Emp+Er)</th><th class="text-right">NHT (Emp+Er)</th><th class="text-right">HEART (Er)</th><th class="text-right">Total Emp Ded.</th><th class="text-right">Total Er Contr.</th><th class="text-right">Grand Total</th></tr></thead><tbody>';
  if(runs.length===0)html+='<tr><td colspan="9" style="text-align:center;color:var(--text-muted);padding:2rem">No payroll data</td></tr>';
  runs.forEach(r=>{
    let nis=0,it=0,ed=0,nht=0,heart=0,empD=0,erC=0;
    r.results.forEach(x=>{nis+=x.nisEmp+x.nisEr;it+=x.incomeTax;ed+=x.edTaxEmp+x.edTaxEr;nht+=x.nhtEmp+x.nhtEr;heart+=(x.heartEr||0);empD+=x.totalEmpDeductions;erC+=x.totalErContributions;});
    html+=`<tr><td>${fmtDate(r.date)}</td><td class="mono text-right">${fmt(nis)}</td><td class="mono text-right">${fmt(it)}</td><td class="mono text-right">${fmt(ed)}</td><td class="mono text-right">${fmt(nht)}</td><td class="mono text-right">${fmt(heart)}</td><td class="mono text-right">${fmt(empD)}</td><td class="mono text-right">${fmt(erC)}</td><td class="mono text-right" style="font-weight:700">${fmt(empD+erC)}</td></tr>`;
  });
  html+='</tbody></table>';
  document.getElementById('taxSummaryTable').innerHTML=html;

  const sel=document.getElementById('taxCycleSelect');
  sel.innerHTML='<option value="">‚Äî Select ‚Äî</option>';
  runs.forEach((r,i)=>{sel.innerHTML+=`<option value="${i}">${fmtDate(r.date)}</option>`;});
}

function renderTaxBreakdown(){
  const idx=parseInt(document.getElementById('taxCycleSelect').value);
  if(isNaN(idx))return;
  const run=DATA.payrollRuns[idx];
  let html='<table><thead><tr><th>Employee</th><th class="text-right">NIS (Emp)</th><th class="text-right">NIS (Er)</th><th class="text-right">Income Tax</th><th class="text-right">Ed.Tax (Emp)</th><th class="text-right">Ed.Tax (Er)</th><th class="text-right">NHT (Emp)</th><th class="text-right">NHT (Er)</th><th class="text-right">HEART (Er)</th></tr></thead><tbody>';
  run.results.forEach(r=>{
    html+=`<tr><td>${r.empName}</td><td class="mono text-right">${fmt(r.nisEmp)}</td><td class="mono text-right">${fmt(r.nisEr)}</td><td class="mono text-right">${fmt(r.incomeTax)}</td><td class="mono text-right">${fmt(r.edTaxEmp)}</td><td class="mono text-right">${fmt(r.edTaxEr)}</td><td class="mono text-right">${fmt(r.nhtEmp)}</td><td class="mono text-right">${fmt(r.nhtEr)}</td><td class="mono text-right">${fmt(r.heartEr||0)}</td></tr>`;
  });
  html+='</tbody></table>';
  document.getElementById('taxBreakdownTable').innerHTML=html;
}

// ==================== SETTINGS ====================
function loadSettings(){
  const s=DATA.settings;
  document.getElementById('rateNISEmp').value=s.nisEmp;
  document.getElementById('rateNISEr').value=s.nisEr;
  document.getElementById('nisCeilingMonthly').value=s.nisCeilingMonthly||416667;
  document.getElementById('rateEdTaxEmp').value=s.edTaxEmp;
  document.getElementById('rateEdTaxEr').value=s.edTaxEr;
  document.getElementById('rateNHTEmp').value=s.nhtEmp;
  document.getElementById('rateNHTEr').value=s.nhtEr;
  document.getElementById('rateHeartEr').value=s.heartEr||3;
  document.getElementById('rateIncomeTax').value=s.incomeTax;
  document.getElementById('rateIncomeTaxHigher').value=s.incomeTaxHigher||30;
  document.getElementById('higherBracketAnnual').value=s.higherBracketAnnual||6000000;
  document.getElementById('annualThreshold').value=s.annualThreshold;
}

function saveSettings(){
  DATA.settings={
    nisEmp:parseFloat(document.getElementById('rateNISEmp').value)||3,
    nisEr:parseFloat(document.getElementById('rateNISEr').value)||3,
    nisCeilingMonthly:parseFloat(document.getElementById('nisCeilingMonthly').value)||416667,
    edTaxEmp:parseFloat(document.getElementById('rateEdTaxEmp').value)||2.25,
    edTaxEr:parseFloat(document.getElementById('rateEdTaxEr').value)||3.5,
    nhtEmp:parseFloat(document.getElementById('rateNHTEmp').value)||2,
    nhtEr:parseFloat(document.getElementById('rateNHTEr').value)||3,
    heartEr:parseFloat(document.getElementById('rateHeartEr').value)||3,
    incomeTax:parseFloat(document.getElementById('rateIncomeTax').value)||25,
    incomeTaxHigher:parseFloat(document.getElementById('rateIncomeTaxHigher').value)||30,
    higherBracketAnnual:parseFloat(document.getElementById('higherBracketAnnual').value)||6000000,
    annualThreshold:parseFloat(document.getElementById('annualThreshold').value)||1799376
  };
  saveStore();
  alert('Settings saved!');
}

// ==================== FETCH CURRENT RATES ====================
// Google Drive folder: https://drive.google.com/drive/folders/1JY8N-AXxxM_eQJ3Gfr0OKBoK4rKchdeV
// To set up: upload rates.json to the folder above, right-click ‚Üí Share ‚Üí "Anyone with the link",
// then paste the file's ID below (the long string from the share link between /d/ and /view).
const GDRIVE_RATES_FILE_ID = '1F_GCD8rM4SltmcyGMlUG-EXBsvTQLWWR';
const GITHUB_RATES_URL = 'https://raw.githubusercontent.com/stevebarrettsrha-ops/Staff-Payslip---Dashboard/main/rates.json';

function applyRatesData(data, sourceName, statusDiv){
  if (!data.rates) throw new Error('Invalid rates data format ‚Äî missing "rates" object');

  const r = data.rates;
  const fieldMap = {
    rateNISEmp: r.nisEmp,
    rateNISEr: r.nisEr,
    nisCeilingMonthly: r.nisCeilingMonthly,
    rateEdTaxEmp: r.edTaxEmp,
    rateEdTaxEr: r.edTaxEr,
    rateNHTEmp: r.nhtEmp,
    rateNHTEr: r.nhtEr,
    rateHeartEr: r.heartEr,
    rateIncomeTax: r.incomeTax,
    rateIncomeTaxHigher: r.incomeTaxHigher,
    higherBracketAnnual: r.higherBracketAnnual,
    annualThreshold: r.annualThreshold
  };

  let changedCount = 0;
  for (const [id, val] of Object.entries(fieldMap)) {
    if (val !== undefined && val !== null) {
      const el = document.getElementById(id);
      if (el && parseFloat(el.value) !== val) {
        el.value = val;
        el.style.outline = '2px solid var(--accent2)';
        setTimeout(() => { el.style.outline = ''; }, 3000);
        changedCount++;
      } else if (el) {
        el.value = val;
      }
    }
  }

  const fy = data.fiscalYear || 'N/A';
  const effective = data.effectiveDate || 'N/A';
  const updated = data.lastUpdated || 'N/A';
  statusDiv.style.background = 'rgba(16,185,129,0.1)';
  statusDiv.style.color = 'var(--accent2)';
  statusDiv.innerHTML = '‚úÖ Rates loaded from <strong>' + sourceName + '</strong> ‚Äî <strong>Fiscal Year ' + fy + '</strong> (effective ' + effective + ', last updated ' + updated + '). ' +
    (changedCount > 0 ? changedCount + ' field(s) updated.' : 'All fields already current.') +
    ' <em>Click "Save Settings" to apply.</em>';
}

async function tryFetchJSON(url){
  const response = await fetch(url, { cache: 'no-store' });
  if (!response.ok) throw new Error('HTTP ' + response.status);
  const text = await response.text();
  if (text.trimStart().startsWith('<')) throw new Error('Received HTML instead of JSON');
  return JSON.parse(text);
}

async function fetchCurrentRates(){
  const btn = document.getElementById('fetchRatesBtn');
  const statusDiv = document.getElementById('ratesFetchStatus');

  btn.disabled = true;
  btn.textContent = '‚è≥ Fetching...';
  statusDiv.style.display = 'block';
  statusDiv.style.background = 'var(--primary-glow)';
  statusDiv.style.color = 'var(--text)';

  // Build ordered list of sources to try
  const sources = [];
  if (GDRIVE_RATES_FILE_ID) {
    sources.push({
      name: 'Google Drive',
      url: 'https://drive.google.com/uc?export=download&id=' + GDRIVE_RATES_FILE_ID
    });
  }
  sources.push({ name: 'GitHub', url: GITHUB_RATES_URL });

  for (let i = 0; i < sources.length; i++) {
    const src = sources[i];
    statusDiv.textContent = 'Fetching latest rates from ' + src.name + '...';
    try {
      const data = await tryFetchJSON(src.url);
      applyRatesData(data, src.name, statusDiv);
      btn.disabled = false;
      btn.textContent = 'üåê Fetch Current Rates';
      return;
    } catch (err) {
      // If more sources remain, silently try the next one
      if (i < sources.length - 1) {
        statusDiv.textContent = src.name + ' unavailable, trying ' + sources[i+1].name + '...';
        continue;
      }
      // All sources exhausted
      statusDiv.style.background = 'rgba(239,68,68,0.1)';
      statusDiv.style.color = 'var(--danger)';
      statusDiv.textContent = '‚ùå Failed to fetch rates: ' + err.message + '. Please check your internet connection or update rates manually.';
    }
  }

  btn.disabled = false;
  btn.textContent = 'üåê Fetch Current Rates';
}

// ==================== PRESET DATA ====================
function loadPresetData(){
  if(DATA.employees.length>0&&!confirm('This will replace existing employees. Continue?'))return;
  DATA.employees=[
    {name:'Steve Barrett',designation:'Co-ordinator',type:'FT',mobile:'876-365-2325',dob:'1996-11-03',trn:'127-009-850',nis:'C-96-05-01',startDate:'2021-03-01',salary:37145},
    {name:'Rashaun Barrett',designation:'Administrative Assistant/ Assistant Coordinator',type:'FT',mobile:'876-530-9149',dob:'1998-10-05',trn:'127-009-817',nis:'C-98-03-73',startDate:'2022-10-01',salary:78000},
    {name:'Rohan Hamilton',designation:'Welding Instructor',type:'FT',mobile:'876-783-8616',dob:'1974-07-26',trn:'105-249-262',nis:'C-74-05-80',startDate:'2018-08-05',salary:95943.09},
    {name:'Richard Smith',designation:'Electrical Installation Instructor (BNV)',type:'FT',mobile:'876-986-3698',dob:'1971-03-07',trn:'102-183-511',nis:'C-71-08-24',startDate:'2020-04-01',salary:91374.37},
    {name:'Tracy-Ann Johnson',designation:'Cosmetology/Beauty Therapy Instructor',type:'FT',mobile:'876-879-6059',dob:'1986-01-16',trn:'115-862-331',nis:'C-86-39-20',startDate:'2019-04-01',salary:86190.64},
    {name:'Kevin Allen',designation:'Welding Instructor (BNV)',type:'FT',mobile:'876-536-5733',dob:'1964-04-08',trn:'100-861-229',nis:'M-64-10-13',startDate:'2020-04-01',salary:91374.37},
    {name:'Seyoum Blackwood',designation:'Electrical Installation Instructor',type:'FT',mobile:'876-853-7632',dob:'1998-06-01',trn:'127-288-945',nis:'C-98-07-79',startDate:'2022-03-01',salary:91374.37},
    {name:'Pamella Archer',designation:'Entrepreneurship Instructor (PT)',type:'PT',mobile:'876-454-8458',dob:'1971-09-07',trn:'102-062-072',nis:'C-71-80-34',startDate:'2021-08-05',salary:0},
    {name:'Fontanette Whittingham',designation:'Information Technology Instructor (PT)',type:'PT',mobile:'876-869-5329',dob:'1986-04-16',trn:'116-017-996',nis:'C-86-32-25',startDate:'2020-08-01',salary:0},
    {name:'Yves Bergeron',designation:'Personal Development Instructor (PT)',type:'PT',mobile:'876-319-8904',dob:'1963-11-17',trn:'112-579-477',nis:'N-63-15-58',startDate:'2020-08-01',salary:0},
    {name:'Glowmayne Rowe',designation:'Mathematics Instructor (PT)',type:'PT',mobile:'',dob:'',trn:'126-305-307',nis:'M-96-08-58',startDate:'',salary:0}
  ];
  saveStore();
  alert('Preset employee data loaded!');
  showPage('employees');
}

// ==================== IMPORT/EXPORT ====================
function exportAllData(){
  const exportObj={data:DATA,users:loadUsers(),permissions:loadPermissions(),version:'1.1',timestamp:new Date().toISOString(),savedBy:currentUser?currentUser.displayName:'Export'};
  const blob=new Blob([JSON.stringify(exportObj,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`CESTIS_Payroll_${new Date().toISOString().split('T')[0]}.json`;
  a.click();URL.revokeObjectURL(a.href);
}

function importData(evt){
  const file=evt.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      var parsed=JSON.parse(e.target.result);
      // Support both old format (direct DATA) and new format (wrapped with users/permissions)
      if(parsed.data&&parsed.version){
        DATA=parsed.data;
        if(parsed.users&&Array.isArray(parsed.users))saveUsers(parsed.users);
        if(parsed.permissions&&Array.isArray(parsed.permissions))savePermissions(parsed.permissions);
      }else{
        DATA=parsed;
      }
      saveStore();alert('Data imported!');location.reload();
    }catch(err){alert('Invalid file format');}
  };
  reader.readAsText(file);
  evt.target.value='';
}

// ============================================
// Google Drive Cloud Sync Integration
// ============================================

// Google Drive Configuration
const GOOGLE_DRIVE_CONFIG = {
    CLIENT_ID: '302497466088-0b619cqa9qno2c606k4rqp742lebc5o8.apps.googleusercontent.com',
    FOLDER_ID: '1JY8N-AXxxM_eQJ3Gfr0OKBoK4rKchdeV',
    BACKUP_FILE_NAME: 'employee_payroll_Backup.json',
    SCOPES: 'https://www.googleapis.com/auth/drive'
};

// Cloud sync state
let googleAccessToken = null;
let isCloudConnected = false;
let lastSyncTime = null;
let cloudFileId = null;
let lastSavedBy = null;
let cloudFileTimestamp = null;
let googleTokenClient = null;

// Initialize cloud sync from localStorage
function initializeCloudSync() {
    const savedToken = localStorage.getItem('schoolDashboardGoogleAccessToken');
    const savedExpiry = localStorage.getItem('schoolDashboardGoogleTokenExpiry');
    const savedLastSync = localStorage.getItem('schoolDashboardLastSyncTime');
    const savedFileId = localStorage.getItem('schoolDashboardCloudFileId');

    if (savedLastSync) {
        lastSyncTime = new Date(savedLastSync);
        updateLastSyncDisplay();
    }

    if (savedFileId) {
        cloudFileId = savedFileId;
    }

    if (savedToken && savedExpiry) {
        const expiry = new Date(savedExpiry);
        if (expiry > new Date()) {
            googleAccessToken = savedToken;
            isCloudConnected = true;
            updateCloudUI(true);
            return;
        }
    }

    updateCloudUI(false);
}

// Update cloud UI based on connection status
function updateCloudUI(connected) {
    const notConnectedDiv = document.getElementById('cloudNotConnected');
    const connectedDiv = document.getElementById('cloudConnected');
    const statusDot = document.getElementById('cloudStatusDot');
    const statusText = document.getElementById('cloudStatusText');

    if (connected) {
        notConnectedDiv.style.display = 'none';
        connectedDiv.style.display = 'block';
        if (statusDot) statusDot.className = 'cloud-status-dot connected';
        if (statusText) statusText.textContent = 'Connected';
        var bfnText = document.getElementById('backupFileNameText');
        if (bfnText) bfnText.textContent = GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME;
    } else {
        notConnectedDiv.style.display = 'block';
        connectedDiv.style.display = 'none';
        if (statusDot) statusDot.className = 'cloud-status-dot';
        if (statusText) statusText.textContent = 'Not connected';
    }
}

// Update syncing status
function setCloudSyncing(syncing) {
    const menuIcon = document.getElementById('cloudMenuIcon');
    const connectedDot = document.getElementById('cloudConnectedDot');
    const connectedText = document.getElementById('cloudConnectedText');
    const sidebarSync = document.getElementById('sidebarSyncInfo');

    if (syncing) {
        if (menuIcon) menuIcon.innerHTML = '<span class="spinning">üîÑ</span>';
        if (connectedDot) connectedDot.className = 'cloud-status-dot syncing';
        if (connectedText) { connectedText.textContent = 'Syncing...'; connectedText.className = 'cloud-status-label syncing nav-text'; }
        if (sidebarSync) sidebarSync.textContent = 'Syncing...';
    } else {
        if (menuIcon) menuIcon.textContent = '‚òÅÔ∏è';
        if (connectedDot) connectedDot.className = 'cloud-status-dot connected';
        if (connectedText) { connectedText.textContent = 'Connected'; connectedText.className = 'cloud-status-label connected nav-text'; }
        updateLastSyncDisplay();
    }
}

// Toggle cloud dropdown menu
function toggleCloudMenu() {
    const menu = document.getElementById('cloudDropdownMenu');
    menu.classList.toggle('show');
    setTimeout(() => {
        document.addEventListener('click', closeCloudMenuOnClickOutside);
    }, 0);
}

function closeCloudMenuOnClickOutside(e) {
    const menu = document.getElementById('cloudDropdownMenu');
    const dropdown = document.querySelector('.cloud-dropdown');
    if (!dropdown.contains(e.target)) {
        menu.classList.remove('show');
        document.removeEventListener('click', closeCloudMenuOnClickOutside);
    }
}

// Initialize Google Identity Services
function initGoogleAuth() {
    if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
        googleTokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_DRIVE_CONFIG.CLIENT_ID,
            scope: GOOGLE_DRIVE_CONFIG.SCOPES,
            callback: handleGoogleAuthCallback,
            error_callback: handleGoogleAuthError
        });
    }
}

// Connect to Google Drive
async function connectToGoogleDrive() {
    showGoogleAuthModal();
}

// Show authentication modal
function showGoogleAuthModal() {
    const modalHTML = `
        <div id="googleAuthModal" class="google-auth-modal" style="display:flex;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚òÅÔ∏è Connect to Google Drive</h2>
                    <button class="close-btn" onclick="closeGoogleAuthModal()">√ó</button>
                </div>
                <div style="padding:1.5rem;">
                    <p style="margin-bottom:1.25rem;color:var(--text-dim);">
                        Connect to Google Drive to save and sync your payroll data across devices. Choose your preferred connection method:
                    </p>

                    <!-- Option 1: Direct Google Sign-In -->
                    <div style="background:rgba(16,185,129,0.1);border:2px solid var(--green);border-radius:8px;padding:1.25rem;margin-bottom:1rem;">
                        <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem;">
                            <span style="font-size:1.5rem;">üîê</span>
                            <div>
                                <strong style="color:var(--green);font-size:1.1rem;">Direct Google Sign-In</strong>
                                <span style="background:var(--green);color:white;padding:2px 8px;border-radius:4px;font-size:0.7rem;margin-left:0.5rem;font-weight:600;">RECOMMENDED</span>
                            </div>
                        </div>
                        <p style="color:var(--text-dim);font-size:0.9rem;margin-bottom:1rem;">
                            A Google popup will appear for you to sign in with your Google account directly.
                        </p>
                        <button class="btn btn-success" onclick="triggerDirectGoogleSignIn()" style="width:100%;padding:0.75rem;">
                            Sign in with Google
                        </button>
                    </div>

                    <!-- Option 2: Manual Token Method -->
                    <div id="manualTokenSection" style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:1.25rem;">
                        <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem;">
                            <span style="font-size:1.5rem;">üîß</span>
                            <strong style="color:var(--text);font-size:1.1rem;">Manual Token Method</strong>
                        </div>
                        <p style="color:var(--text-dim);font-size:0.9rem;margin-bottom:1rem;">
                            If the popup doesn't work, you can use the OAuth Playground to get a token manually.
                        </p>
                        <button class="btn btn-ghost" onclick="showManualTokenForm()" id="showManualTokenBtn" style="width:100%;">
                            Use Manual Method
                        </button>

                        <div id="manualTokenForm" style="display:none;margin-top:1rem;">
                            <div style="background:rgba(59,130,246,0.1);border:1px solid var(--primary);border-radius:6px;padding:1rem;margin-bottom:1rem;">
                                <strong style="color:var(--primary);">How to get your access token:</strong>
                                <ol style="margin-top:0.5rem;margin-left:1rem;color:var(--text-dim);font-size:0.85rem;line-height:1.6;">
                                    <li>Click the link below to open Google OAuth Playground</li>
                                    <li>In Step 1, find and select <strong>"Drive API v3"</strong> ‚Üí check <strong>"../auth/drive"</strong></li>
                                    <li>Click <strong>"Authorize APIs"</strong></li>
                                    <li>Sign in with your Google account</li>
                                    <li>In Step 2, click <strong>"Exchange authorization code for tokens"</strong></li>
                                    <li>Copy the <strong>"Access token"</strong> value and paste below</li>
                                </ol>
                                <a href="https://developers.google.com/oauthplayground" target="_blank"
                                   style="display:inline-block;margin-top:0.75rem;padding:0.5rem 1rem;background:var(--primary);color:white;border-radius:6px;text-decoration:none;font-weight:600;font-size:0.875rem;">
                                    üîó Open OAuth Playground
                                </a>
                            </div>

                            <div class="form-group" style="margin-bottom:1rem;">
                                <label>Access Token</label>
                                <textarea id="googleAccessTokenInput" rows="4" style="width:100%;padding:0.75rem;resize:vertical;margin-top:0.5rem;" placeholder="Paste your access token here..."></textarea>
                            </div>

                            <button class="btn btn-success" onclick="submitGoogleToken()" style="width:100%;">
                                ‚òÅÔ∏è Connect with Token
                            </button>
                        </div>
                    </div>

                    <div style="margin-top:1rem;text-align:center;">
                        <button class="btn btn-ghost" onclick="closeGoogleAuthModal()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Trigger the direct Google Sign-In popup
function triggerDirectGoogleSignIn() {
    closeGoogleAuthModal();
    if (googleTokenClient) {
        googleTokenClient.requestAccessToken();
    } else {
        initGoogleAuth();
        setTimeout(() => {
            if (googleTokenClient) {
                googleTokenClient.requestAccessToken();
            } else {
                alert('Google Sign-In popup is not available. Please use the manual token method.');
                showGoogleAuthModal();
                setTimeout(() => showManualTokenForm(), 100);
            }
        }, 500);
    }
}

// Show the manual token form
function showManualTokenForm() {
    const form = document.getElementById('manualTokenForm');
    const btn = document.getElementById('showManualTokenBtn');
    if (form && btn) {
        form.style.display = 'block';
        btn.style.display = 'none';
    }
}

function closeGoogleAuthModal() {
    const modal = document.getElementById('googleAuthModal');
    if (modal) modal.remove();
}

async function submitGoogleToken() {
    const tokenInput = document.getElementById('googleAccessTokenInput');
    const token = tokenInput.value.trim();

    if (!token) {
        alert('Please enter an access token');
        return;
    }

    try {
        const response = await fetch('https://www.googleapis.com/drive/v3/about?fields=user', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Invalid token');

        const data = await response.json();

        googleAccessToken = token;
        isCloudConnected = true;

        const expiry = new Date();
        expiry.setHours(expiry.getHours() + 1);
        localStorage.setItem('schoolDashboardGoogleAccessToken', token);
        localStorage.setItem('schoolDashboardGoogleTokenExpiry', expiry.toISOString());

        closeGoogleAuthModal();
        updateCloudUI(true);

        alert('Connected to Google Drive as ' + (data.user.displayName || data.user.emailAddress));

        await findExistingBackupFile();

    } catch (error) {
        console.error('Token verification failed:', error);
        alert('Invalid access token. Please make sure you copied the correct token.');
    }
}

async function handleGoogleAuthCallback(tokenResponse) {
    googleAccessToken = tokenResponse.access_token;
    isCloudConnected = true;

    const expiry = new Date();
    expiry.setSeconds(expiry.getSeconds() + (tokenResponse.expires_in || 3600));
    localStorage.setItem('schoolDashboardGoogleAccessToken', googleAccessToken);
    localStorage.setItem('schoolDashboardGoogleTokenExpiry', expiry.toISOString());

    updateCloudUI(true);

    await findExistingBackupFile();

    alert('Connected to Google Drive successfully! You can now Save, Sync, or Merge your data.');
}

function handleGoogleAuthError(error) {
    console.error('Google auth error:', error);
    if (error.type === 'popup_closed') return;
    alert('Failed to authenticate with Google. Please try the manual token method.');
    showGoogleAuthModal();
}

// Disconnect from Google Drive
function disconnectFromGoogleDrive() {
    if (confirm('Are you sure you want to disconnect from Google Drive? Your local data will remain intact.')) {
        googleAccessToken = null;
        isCloudConnected = false;
        cloudFileId = null;

        localStorage.removeItem('schoolDashboardGoogleAccessToken');
        localStorage.removeItem('schoolDashboardGoogleTokenExpiry');
        localStorage.removeItem('schoolDashboardCloudFileId');

        updateCloudUI(false);
        const menu = document.getElementById('cloudDropdownMenu');
        if (menu) menu.classList.remove('show');

        alert('Disconnected from Google Drive');
    }
}

// Find existing backup file in the folder
async function findExistingBackupFile() {
    try {
        const query = `name='${GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME}' and '${GOOGLE_DRIVE_CONFIG.FOLDER_ID}' in parents and trashed=false`;
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,modifiedTime)&orderBy=modifiedTime desc&pageSize=1`,
            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );

        if (response.ok) {
            const data = await response.json();
            if (data.files && data.files.length > 0) {
                cloudFileId = data.files[0].id;
                localStorage.setItem('schoolDashboardCloudFileId', cloudFileId);
                console.log('Found existing backup file:', cloudFileId);
            } else {
                // No file found in the target folder ‚Äî clear any stale reference
                cloudFileId = null;
                localStorage.removeItem('schoolDashboardCloudFileId');
            }
        }
    } catch (error) {
        console.error('Error finding backup file:', error);
    }
}

// Check cloud file for changes before saving (conflict detection)
async function checkCloudForChanges() {
    if (!cloudFileId || !googleAccessToken) return null;

    try {
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );

        if (response.ok) {
            const backupData = await response.json();
            return {
                savedBy: backupData.savedBy || 'Unknown',
                timestamp: backupData.timestamp
            };
        }
    } catch (error) {
        console.error('Error checking cloud for changes:', error);
    }
    return null;
}

// Auto-save users to cloud (called when admin creates/edits/deletes a user)
async function autoSaveUsersToCloud(){
  if(!isCloudConnected||!googleAccessToken){
    console.log('[AutoCloudPush] Not connected to cloud, skipping');
    return;
  }
  setCloudSyncing(true);
  try{
    await findExistingBackupFile();
    var backupData={
      version:'1.1',
      timestamp:new Date().toISOString(),
      savedBy:currentUser?currentUser.displayName:'Dashboard User',
      data:DATA,
      users:loadUsers(),
      permissions:loadPermissions()
    };
    var jsonContent=JSON.stringify(backupData,null,2);
    var response;
    if(cloudFileId){
      var boundary='boundary_'+Date.now();
      var updateMetadata={name:GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME};
      var multipartBody='--'+boundary+'\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n'+JSON.stringify(updateMetadata)+'\r\n--'+boundary+'\r\nContent-Type: application/json\r\n\r\n'+jsonContent+'\r\n--'+boundary+'--';
      response=await fetch('https://www.googleapis.com/upload/drive/v3/files/'+cloudFileId+'?uploadType=multipart&fields=id,name,parents',{
        method:'PATCH',
        headers:{'Authorization':'Bearer '+googleAccessToken,'Content-Type':'multipart/related; boundary='+boundary},
        body:multipartBody
      });
      if(response.status===404){cloudFileId=null;localStorage.removeItem('schoolDashboardCloudFileId');}
    }
    if(!cloudFileId){
      var boundary2='boundary_'+Date.now();
      var metadata={name:GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME,parents:[GOOGLE_DRIVE_CONFIG.FOLDER_ID],mimeType:'application/json'};
      var multipartBody2='--'+boundary2+'\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n'+JSON.stringify(metadata)+'\r\n--'+boundary2+'\r\nContent-Type: application/json\r\n\r\n'+jsonContent+'\r\n--'+boundary2+'--';
      response=await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,parents',{
        method:'POST',
        headers:{'Authorization':'Bearer '+googleAccessToken,'Content-Type':'multipart/related; boundary='+boundary2},
        body:multipartBody2
      });
      if(response.ok){
        var result=await response.json();
        cloudFileId=result.id;
        localStorage.setItem('schoolDashboardCloudFileId',cloudFileId);
      }
    }
    if(response&&response.ok){
      lastSyncTime=new Date();
      localStorage.setItem('schoolDashboardLastSyncTime',lastSyncTime.toISOString());
      updateLastSyncDisplay();
      lastSavedBy=currentUser?currentUser.displayName:'Dashboard User';
      cloudFileTimestamp=new Date().toISOString();
      console.log('[AutoCloudPush] User data auto-saved to cloud');
    }else{
      console.log('[AutoCloudPush] Cloud save failed');
    }
  }catch(err){
    console.log('[AutoCloudPush] Error:',err.message);
  }
  setCloudSyncing(false);
}

// ============ SAVE TO CLOUD ============
async function saveToCloud() {
    if (!isCloudConnected || !googleAccessToken) {
        alert('Please connect to Google Drive first');
        return;
    }

    const menu = document.getElementById('cloudDropdownMenu');
    menu.classList.remove('show');

    const cloudInfo = await checkCloudForChanges();

    let confirmMessage = 'MULTI-USER CLOUD SYNC\n\n';
    confirmMessage += 'You are about to save to a shared cloud backup.\n\n';

    if (cloudInfo && cloudInfo.savedBy) {
        const cloudTime = new Date(cloudInfo.timestamp);
        const timeSinceLastSave = getTimeAgo(cloudTime);

        const hasConflict = lastSyncTime && cloudTime > lastSyncTime;

        if (hasConflict) {
            confirmMessage += 'WARNING: ' + cloudInfo.savedBy + ' saved changes ' + timeSinceLastSave + '!\n';
            confirmMessage += 'Your local data may not include their changes.\n\n';
            confirmMessage += 'Recommendation: Click Cancel, then "Sync from Cloud" first.\n\n';
        } else {
            confirmMessage += 'Last saved by: ' + cloudInfo.savedBy + ' (' + timeSinceLastSave + ')\n\n';
        }
    }

    confirmMessage += 'This will overwrite the cloud backup. Continue?';

    if (!confirm(confirmMessage)) return;

    setCloudSyncing(true);

    try {
        // Always search the correct folder so a stale cloudFileId from an
        // old/different folder is replaced with the right one.
        await findExistingBackupFile();

        const backupData = {
            version: '1.1',
            timestamp: new Date().toISOString(),
            savedBy: currentUser?currentUser.displayName:'Dashboard User',
            data: DATA,
            users: loadUsers(),
            permissions: loadPermissions()
        };

        const jsonContent = JSON.stringify(backupData, null, 2);

        let response;

        if (cloudFileId) {
            // Update existing file ‚Äî use multipart/related to update both metadata and content
            const boundary = 'boundary_' + Date.now();
            const updateMetadata = {
                name: GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME
            };

            const multipartBody =
                '--' + boundary + '\r\n' +
                'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                JSON.stringify(updateMetadata) + '\r\n' +
                '--' + boundary + '\r\n' +
                'Content-Type: application/json\r\n\r\n' +
                jsonContent + '\r\n' +
                '--' + boundary + '--';

            response = await fetch(
                `https://www.googleapis.com/upload/drive/v3/files/${cloudFileId}?uploadType=multipart&fields=id,name,parents`,
                {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`,
                        'Content-Type': 'multipart/related; boundary=' + boundary
                    },
                    body: multipartBody
                }
            );

            if (response.ok) {
                // Verify the file is actually in the correct folder
                const result = await response.json();
                const parents = result.parents || [];
                if (!parents.includes(GOOGLE_DRIVE_CONFIG.FOLDER_ID)) {
                    console.warn('File saved to wrong folder. Creating new file in correct folder.');
                    cloudFileId = null;
                    localStorage.removeItem('schoolDashboardCloudFileId');
                }
            }

            // If the file no longer exists, clear the stale reference and create a new one
            if (response.status === 404) {
                console.warn('Stored cloud file not found (deleted?). Creating a new backup file.');
                cloudFileId = null;
                localStorage.removeItem('schoolDashboardCloudFileId');
            }
        }

        if (!cloudFileId) {
            // Create new file in the target folder
            const boundary = 'boundary_' + Date.now();
            const metadata = {
                name: GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME,
                parents: [GOOGLE_DRIVE_CONFIG.FOLDER_ID],
                mimeType: 'application/json'
            };

            const multipartBody =
                '--' + boundary + '\r\n' +
                'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                JSON.stringify(metadata) + '\r\n' +
                '--' + boundary + '\r\n' +
                'Content-Type: application/json\r\n\r\n' +
                jsonContent + '\r\n' +
                '--' + boundary + '--';

            response = await fetch(
                'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,parents',
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`,
                        'Content-Type': 'multipart/related; boundary=' + boundary
                    },
                    body: multipartBody
                }
            );

            if (response.ok) {
                const result = await response.json();
                cloudFileId = result.id;
                localStorage.setItem('schoolDashboardCloudFileId', cloudFileId);
            }
        }

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'Upload failed');
        }

        lastSyncTime = new Date();
        localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
        updateLastSyncDisplay();

        lastSavedBy = currentUser?currentUser.displayName:'Dashboard User';
        cloudFileTimestamp = new Date().toISOString();
        updateLastSavedByDisplay();

        setCloudSyncing(false);
        alert('Data saved to Google Drive successfully!\n\nTip: Let other users know to sync from cloud to get your changes.');

    } catch (error) {
        console.error('Error saving to cloud:', error);
        setCloudSyncing(false);

        if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
            alert('Your session has expired. Please reconnect to Google Drive.');
            disconnectFromGoogleDrive();
        } else {
            alert('Failed to save to cloud: ' + error.message);
        }
    }
}

// ============ SYNC FROM CLOUD ============
async function syncFromCloud() {
    if (!isCloudConnected || !googleAccessToken) {
        alert('Please connect to Google Drive first');
        return;
    }

    const menu = document.getElementById('cloudDropdownMenu');
    menu.classList.remove('show');

    if (!cloudFileId) {
        await findExistingBackupFile();
    }

    if (!cloudFileId) {
        alert('No backup file found in Google Drive. Save your data first to create a backup.');
        return;
    }

    if (!confirm('This will replace your local data with the cloud backup. Are you sure you want to continue?')) {
        return;
    }

    setCloudSyncing(true);

    try {
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );

        if (!response.ok) throw new Error('Failed to download backup');

        const backupData = await response.json();

        if (!backupData.data || !backupData.version) {
            throw new Error('Invalid backup file format');
        }

        // Restore data
        DATA = backupData.data;
        saveStore();

        // Restore users and permissions from cloud if available
        if(backupData.users&&Array.isArray(backupData.users)&&backupData.users.length>0){
          // Ensure default admin always exists
          var cloudUsers=backupData.users;
          if(!cloudUsers.some(function(u){return u.username.toLowerCase()==='cestisadmin';})){
            cloudUsers.push(getDefaultUsers()[0]);
          }
          saveUsers(cloudUsers);
        }
        if(backupData.permissions&&Array.isArray(backupData.permissions)){
          savePermissions(backupData.permissions);
        }

        // Update last sync time
        lastSyncTime = new Date();
        localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
        updateLastSyncDisplay();

        // Refresh UI
        renderDashboard();
        if(currentPageName==='usermanagement')renderUserManagement();
        if(currentPageName==='permissions')renderPermissions();

        setCloudSyncing(false);

        lastSavedBy = backupData.savedBy || 'Unknown';
        cloudFileTimestamp = backupData.timestamp;
        updateLastSavedByDisplay();

        const backupTime = new Date(backupData.timestamp).toLocaleString();
        const savedByInfo = backupData.savedBy ? '\nLast saved by: ' + backupData.savedBy : '';
        alert('Data synced from cloud successfully!\n\nBackup was created: ' + backupTime + savedByInfo);

    } catch (error) {
        console.error('Error syncing from cloud:', error);
        setCloudSyncing(false);

        if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
            alert('Your session has expired. Please reconnect to Google Drive.');
            disconnectFromGoogleDrive();
        } else {
            alert('Failed to sync from cloud: ' + error.message);
        }
    }
}

// ============ MERGE FROM CLOUD ============
async function mergeFromCloud() {
    if (!isCloudConnected || !googleAccessToken) {
        alert('Please connect to Google Drive first');
        return;
    }

    const menu = document.getElementById('cloudDropdownMenu');
    menu.classList.remove('show');

    if (!cloudFileId) {
        await findExistingBackupFile();
    }

    if (!cloudFileId) {
        alert('No backup file found in Google Drive. Save your data first to create a backup.');
        return;
    }

    if (!confirm('MERGE FROM CLOUD\n\nThis will merge cloud data with your local data:\n\n' +
        '- New employees from cloud will be ADDED to your local data\n' +
        '- New payroll runs from cloud will be ADDED\n' +
        '- Existing items will be kept as-is (local version preserved)\n' +
        '- No local data will be removed\n\nContinue?')) {
        return;
    }

    setCloudSyncing(true);

    try {
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );

        if (!response.ok) throw new Error('Failed to download backup');

        const backupData = await response.json();

        if (!backupData.data || !backupData.version) {
            throw new Error('Invalid backup file format');
        }

        let mergeStats = { employeesAdded: 0, payrollRunsAdded: 0, settingsMerged: false };

        // Merge employees - add cloud employees that don't exist locally (match by name, case-insensitive)
        if (backupData.data.employees) {
            const localNames = DATA.employees.map(e => e.name.toLowerCase());
            backupData.data.employees.forEach(cloudEmp => {
                if (!localNames.includes(cloudEmp.name.toLowerCase())) {
                    DATA.employees.push(cloudEmp);
                    mergeStats.employeesAdded++;
                }
            });
        }

        // Merge payroll runs - add cloud runs that don't exist locally (match by date)
        // Also reconcile employee names in merged runs to match local employee list
        if (backupData.data.payrollRuns) {
            const localDates = DATA.payrollRuns.map(r => r.date);
            const localNameMap = {};
            DATA.employees.forEach(e => { localNameMap[e.name.trim().toLowerCase()] = e.name; });
            backupData.data.payrollRuns.forEach(cloudRun => {
                if (!localDates.includes(cloudRun.date)) {
                    // Reconcile employee names and filter to only current employees
                    cloudRun.results = cloudRun.results.filter(r => {
                        if (!r.empName) return false;
                        const match = localNameMap[r.empName.trim().toLowerCase()];
                        if (match) { r.empName = match; return true; }
                        return false; // Skip employees not in current list
                    });
                    if (cloudRun.results.length > 0) {
                        DATA.payrollRuns.push(cloudRun);
                        mergeStats.payrollRunsAdded++;
                    }
                }
            });
        }

        // Merge settings - only update if local settings match defaults
        if (backupData.data.settings) {
            const defaults = defaultData().settings;
            const isDefault = DATA.settings.nisEmp === defaults.nisEmp &&
                              DATA.settings.annualThreshold === defaults.annualThreshold &&
                              DATA.employees.length === 0;
            if (isDefault) {
                DATA.settings = backupData.data.settings;
                mergeStats.settingsMerged = true;
            }
        }

        saveStore();

        // Merge users from cloud ‚Äî add new users, update existing (keep local passwords if user exists)
        if(backupData.users&&Array.isArray(backupData.users)){
          var localUsers=loadUsers();
          var usersAdded=0;
          backupData.users.forEach(function(cloudUser){
            var existing=localUsers.find(function(u){return u.username.toLowerCase()===cloudUser.username.toLowerCase();});
            if(!existing){
              localUsers.push(cloudUser);
              usersAdded++;
            }else{
              // Update fields from cloud (except password ‚Äî keep local password if it exists)
              existing.displayName=cloudUser.displayName;
              existing.role=cloudUser.role;
              if(!existing.password&&cloudUser.password)existing.password=cloudUser.password;
            }
          });
          // Ensure default admin always exists
          if(!localUsers.some(function(u){return u.username.toLowerCase()==='cestisadmin';})){
            localUsers.push(getDefaultUsers()[0]);
          }
          saveUsers(localUsers);
          mergeStats.usersAdded=usersAdded;
        }

        // Merge permissions from cloud ‚Äî add new permission records
        if(backupData.permissions&&Array.isArray(backupData.permissions)){
          var localPerms=loadPermissions();
          var permsAdded=0;
          backupData.permissions.forEach(function(cloudPerm){
            if(!localPerms.some(function(p){return p.id===cloudPerm.id;})){
              localPerms.push(cloudPerm);
              permsAdded++;
            }
          });
          savePermissions(localPerms);
          mergeStats.permsAdded=permsAdded;
        }

        // Update last sync time
        lastSyncTime = new Date();
        localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
        updateLastSyncDisplay();

        lastSavedBy = backupData.savedBy || 'Unknown';
        cloudFileTimestamp = backupData.timestamp;
        updateLastSavedByDisplay();

        // Refresh UI
        renderDashboard();
        if(currentPageName==='usermanagement')renderUserManagement();
        if(currentPageName==='permissions')renderPermissions();

        setCloudSyncing(false);

        // Build summary message
        let summary = 'Merge from cloud completed!\n\n';
        summary += 'Merge Summary:\n';
        summary += '- Employees added: ' + mergeStats.employeesAdded + '\n';
        summary += '- Payroll runs added: ' + mergeStats.payrollRunsAdded + '\n';
        summary += '- Users synced: ' + (mergeStats.usersAdded||0) + ' new\n';
        summary += '- Settings updated: ' + (mergeStats.settingsMerged ? 'Yes' : 'No (local settings preserved)') + '\n';

        const totalAdded = mergeStats.employeesAdded + mergeStats.payrollRunsAdded + (mergeStats.usersAdded||0);
        if (totalAdded === 0 && !mergeStats.settingsMerged) {
            summary += '\nNo new data found ‚Äî your local data already contains everything from the cloud.';
        } else {
            summary += '\nTip: Save to Cloud to push the merged data back for other users.';
        }

        const savedByInfo = backupData.savedBy ? '\nCloud backup was saved by: ' + backupData.savedBy : '';
        summary += savedByInfo;

        alert(summary);

    } catch (error) {
        console.error('Error merging from cloud:', error);
        setCloudSyncing(false);

        if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
            alert('Your session has expired. Please reconnect to Google Drive.');
            disconnectFromGoogleDrive();
        } else {
            alert('Failed to merge from cloud: ' + error.message);
        }
    }
}

// ============ BROWSE CLOUD FOLDER ============
async function browseCloudFolder() {
    if (!isCloudConnected || !googleAccessToken) {
        alert('Please connect to Google Drive first');
        return;
    }

    const menu = document.getElementById('cloudDropdownMenu');
    menu.classList.remove('show');

    // Show modal with loading state
    const modalHTML = `
        <div id="browseCloudModal" class="browse-cloud-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìÇ Cloud Folder ‚Äî All Backups</h2>
                    <button class="close-btn" onclick="closeBrowseCloudModal()">&times;</button>
                </div>
                <div class="browse-body" id="browseCloudBody">
                    <div class="browse-loading">
                        <span style="font-size:1.5rem;display:block;margin-bottom:0.5rem;">‚òÅÔ∏è</span>
                        Loading files from Google Drive...
                    </div>
                </div>
            </div>
        </div>`;

    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Fetch files from the folder
    try {
        const query = `'${GOOGLE_DRIVE_CONFIG.FOLDER_ID}' in parents and trashed=false`;
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,size,modifiedTime,mimeType,createdTime)&orderBy=modifiedTime desc&pageSize=50`,
            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );

        if (!response.ok) {
            if (response.status === 401) {
                throw new Error('Session expired. Please reconnect to Google Drive.');
            }
            throw new Error('Failed to list files (HTTP ' + response.status + ')');
        }

        const data = await response.json();
        const body = document.getElementById('browseCloudBody');

        if (!data.files || data.files.length === 0) {
            body.innerHTML = `
                <div class="browse-empty">
                    <span style="font-size:2rem;display:block;margin-bottom:0.5rem;">üì≠</span>
                    No files found in the cloud folder.<br>
                    <span style="font-size:0.8rem;color:var(--text-muted);">Use "Save to Cloud" to create your first backup.</span>
                </div>`;
            return;
        }

        let listHTML = '<ul class="browse-file-list">';
        data.files.forEach(file => {
            const modified = new Date(file.modifiedTime);
            const timeAgo = getTimeAgo(modified);
            const dateStr = modified.toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' });
            const timeStr = modified.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit' });
            const sizeStr = file.size ? formatFileSize(parseInt(file.size)) : '--';
            const isBackup = file.name === GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME;
            const icon = isBackup ? '‚≠ê' : (file.mimeType === 'application/json' ? 'üìÑ' : 'üìé');

            listHTML += `
                <li class="browse-file-item" ${isBackup ? 'style="border-color:var(--accent);background:rgba(245,158,11,0.05);"' : ''}>
                    <div class="browse-file-info">
                        <span class="browse-file-icon">${icon}</span>
                        <div class="browse-file-details">
                            <div class="browse-file-name">${file.name}${isBackup ? ' <span style="font-size:0.65rem;background:var(--accent);color:#000;padding:1px 6px;border-radius:3px;font-weight:700;margin-left:4px;">ACTIVE</span>' : ''}</div>
                            <div class="browse-file-meta">${dateStr} at ${timeStr} ¬∑ ${timeAgo} ¬∑ ${sizeStr}</div>
                        </div>
                    </div>
                    <div class="browse-file-actions">
                        <button class="btn-browse-download" onclick="downloadCloudFile('${file.id}', '${file.name.replace(/'/g, "\\'")}')">‚¨á Download</button>
                        ${!isBackup ? '<button class="btn-browse-delete" onclick="deleteCloudFile(\'' + file.id + '\', \'' + file.name.replace(/'/g, "\\'") + '\')">üóë</button>' : ''}
                    </div>
                </li>`;
        });
        listHTML += '</ul>';

        listHTML += `<a class="browse-folder-link" href="https://drive.google.com/drive/folders/${GOOGLE_DRIVE_CONFIG.FOLDER_ID}" target="_blank" rel="noopener">
            üîó Open folder in Google Drive
        </a>`;

        body.innerHTML = listHTML;

    } catch (error) {
        console.error('Error browsing cloud folder:', error);
        const body = document.getElementById('browseCloudBody');
        if (body) {
            body.innerHTML = `
                <div class="browse-empty" style="color:var(--danger);">
                    <span style="font-size:2rem;display:block;margin-bottom:0.5rem;">‚ö†Ô∏è</span>
                    ${error.message}
                </div>`;
        }

        if (error.message.includes('Session expired') || error.message.includes('invalid_token')) {
            disconnectFromGoogleDrive();
        }
    }
}

function closeBrowseCloudModal() {
    const modal = document.getElementById('browseCloudModal');
    if (modal) modal.remove();
}

async function downloadCloudFile(fileId, fileName) {
    try {
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );

        if (!response.ok) throw new Error('Download failed');

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error('Error downloading file:', error);
        alert('Failed to download file: ' + error.message);
    }
}

async function deleteCloudFile(fileId, fileName) {
    if (!confirm('Delete "' + fileName + '" from cloud?\n\nThis cannot be undone.')) return;

    try {
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileId}`,
            {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${googleAccessToken}` }
            }
        );

        if (!response.ok) throw new Error('Delete failed');

        alert('"' + fileName + '" has been deleted.');
        closeBrowseCloudModal();
        browseCloudFolder();
    } catch (error) {
        console.error('Error deleting file:', error);
        alert('Failed to delete file: ' + error.message);
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const units = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return (bytes / Math.pow(1024, i)).toFixed(i > 0 ? 1 : 0) + ' ' + units[i];
}

// ============ HELPER FUNCTIONS ============
function updateLastSyncDisplay() {
    const lastSyncInfo = document.getElementById('lastSyncInfo');
    const sidebarSync = document.getElementById('sidebarSyncInfo');
    const syncText = lastSyncTime ? 'Last sync: ' + getTimeAgo(lastSyncTime) : 'Last sync: Never';
    if (lastSyncInfo) lastSyncInfo.textContent = syncText;
    if (sidebarSync) sidebarSync.textContent = syncText;
}

function updateLastSavedByDisplay() {
    const lastSavedByInfo = document.getElementById('lastSavedByInfo');
    if (lastSavedByInfo) {
        if (lastSavedBy && cloudFileTimestamp) {
            lastSavedByInfo.textContent = 'Last saved by: ' + lastSavedBy + ' (' + getTimeAgo(new Date(cloudFileTimestamp)) + ')';
        } else if (lastSavedBy) {
            lastSavedByInfo.textContent = 'Last saved by: ' + lastSavedBy;
        } else {
            lastSavedByInfo.textContent = 'Last saved by: --';
        }
    }
}

function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return diffMins + ' min' + (diffMins > 1 ? 's' : '') + ' ago';
    if (diffHours < 24) return diffHours + ' hour' + (diffHours > 1 ? 's' : '') + ' ago';
    return diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ago';
}

// ==================== CLOUD CONNECTIVITY NOTIFICATIONS ====================
let cloudNotifyTimer = null;
let cloudCheckInterval = null;

function showCloudNotification(type, title, message, showConnect, autoDismissSec){
  // Remove any existing notification
  dismissCloudNotification();

  const el = document.createElement('div');
  el.id = 'cloudNotifyPopup';
  el.className = 'cloud-notify ' + type;
  const icon = type === 'error' ? '‚ö†Ô∏è' : type === 'warn' ? 'üîå' : '‚òÅÔ∏è';
  el.innerHTML =
    '<div class="cloud-notify-bar"></div>' +
    '<div class="cloud-notify-body">' +
      '<div class="cloud-notify-icon">' + icon + '</div>' +
      '<div class="cloud-notify-content">' +
        '<div class="cloud-notify-title">' + title + '</div>' +
        '<div class="cloud-notify-msg">' + message + '</div>' +
      '</div>' +
      '<button class="cloud-notify-close" onclick="dismissCloudNotification()">&times;</button>' +
    '</div>' +
    '<div class="cloud-notify-actions">' +
      (showConnect ? '<button class="btn btn-success" onclick="dismissCloudNotification();connectToGoogleDrive()">Connect Now</button>' : '') +
      '<button class="btn btn-ghost" onclick="dismissCloudNotification()">Dismiss</button>' +
    '</div>' +
    (autoDismissSec ? '<div class="cloud-notify-timer" style="animation:notifyCountdown ' + autoDismissSec + 's linear forwards"></div>' : '');

  document.body.appendChild(el);
  // Trigger slide-in
  requestAnimationFrame(function(){ requestAnimationFrame(function(){ el.classList.add('show'); }); });

  if (autoDismissSec) {
    cloudNotifyTimer = setTimeout(dismissCloudNotification, autoDismissSec * 1000);
  }
}

function dismissCloudNotification(){
  clearTimeout(cloudNotifyTimer);
  cloudNotifyTimer = null;
  const el = document.getElementById('cloudNotifyPopup');
  if (el) {
    el.classList.remove('show');
    setTimeout(function(){ el.remove(); }, 400);
  }
}

// Check cloud connection state and notify if needed
function checkCloudAndNotify(reason){
  // Don't nag if user has never connected (no saved token at all and no saved file)
  const hasEverConnected = localStorage.getItem('schoolDashboardGoogleAccessToken') ||
                           localStorage.getItem('schoolDashboardCloudFileId') ||
                           localStorage.getItem('schoolDashboardLastSyncTime');
  if (!hasEverConnected) return;

  if (!navigator.onLine) {
    showCloudNotification('error', 'You Are Offline',
      'Your internet connection is unavailable. Data changes will only be saved locally. Please reconnect to sync with Google Drive.',
      false, 0);
    return;
  }

  if (!isCloudConnected) {
    const savedExpiry = localStorage.getItem('schoolDashboardGoogleTokenExpiry');
    const lastSync = localStorage.getItem('schoolDashboardLastSyncTime');
    let detail = '';

    if (savedExpiry && new Date(savedExpiry) <= new Date()) {
      detail = 'Your Google Drive session has expired.';
    } else if (reason === 'page_load') {
      detail = 'Google Drive is not connected.';
    } else if (reason === 'token_expired') {
      detail = 'Your Google Drive session has expired.';
    } else {
      detail = 'Google Drive connection was lost.';
    }

    if (lastSync) {
      detail += ' Last sync: ' + getTimeAgo(new Date(lastSync)) + '.';
    }

    showCloudNotification('warn', 'Cloud Sync Disconnected',
      detail + ' Your data is only saved locally. Connect to Google Drive to back up and sync your data.',
      true, 30);
  }
}

// Monitor token expiry in real time
function startCloudMonitor(){
  // Clear any previous interval
  if (cloudCheckInterval) clearInterval(cloudCheckInterval);

  // Check every 60 seconds if the token has expired
  cloudCheckInterval = setInterval(function(){
    if (isCloudConnected && googleAccessToken) {
      const savedExpiry = localStorage.getItem('schoolDashboardGoogleTokenExpiry');
      if (savedExpiry && new Date(savedExpiry) <= new Date()) {
        // Token just expired
        googleAccessToken = null;
        isCloudConnected = false;
        updateCloudUI(false);
        checkCloudAndNotify('token_expired');
      }
    }
  }, 60000);
}

// Listen for browser online/offline events
window.addEventListener('offline', function(){
  showCloudNotification('error', 'You Are Offline',
    'Internet connection lost. Data changes will only be saved locally until you reconnect.',
    false, 0);
});

window.addEventListener('online', function(){
  dismissCloudNotification();
  if (!isCloudConnected) {
    // Back online but cloud not connected ‚Äî prompt to reconnect
    setTimeout(function(){
      checkCloudAndNotify('reconnected');
    }, 1500);
  } else {
    showCloudNotification('warn', 'Back Online',
      'Internet connection restored. Your cloud sync is active.',
      false, 8);
  }
});

// ==================== AUTH & USER MANAGEMENT ====================
// XSS Protection Utility
function escapeHtml(text){
  if(!text)return '';
  var div=document.createElement('div');
  div.textContent=text;
  return div.innerHTML;
}

// Storage keys ‚Äî matching CESTIS-MAIN-DASHBOARD
const USERS_KEY='dashboardUsers';
const PERMS_KEY='cestisPermissions';
let currentUser=null;
let pendingTwoFAUser=null;
let permTimerInterval=null;

// 2FA temporary storage
let pendingTwoFASecret=null;
let pendingBackupCodes=null;

// EmailJS Configuration for OTP emails
window.EMAILJS_PUBLIC_KEY='z_6Ya8J_WGJjRIGuX';
window.EMAILJS_SERVICE_ID='service_v49btoq';
window.EMAILJS_TEMPLATE_ID='template_80h43gm';

// Password Reset OTP variables
let currentOTP=null;
let otpExpiry=null;
let pendingResetUser=null;

// Default admin user ‚Äî matching CESTIS-MAIN-DASHBOARD
const defaultUsers=[{
  id:'admin_001',
  username:'Cestisadmin',
  password:'cestisadmin123$',
  displayName:'System Administrator',
  email:'admin@cestis.com',
  role:'Administrator',
  isAdmin:true,
  createdAt:new Date().toISOString()
}];

function getDefaultUsers(){return JSON.parse(JSON.stringify(defaultUsers));}

// Migrate from old cestisUsers key to new dashboardUsers key
(function migrateUsersKey(){
  var oldKey='cestisUsers';
  var oldData=localStorage.getItem(oldKey);
  var newData=localStorage.getItem(USERS_KEY);
  if(oldData&&!newData){
    localStorage.setItem(USERS_KEY,oldData);
    localStorage.removeItem(oldKey);
    console.log('[Migration] Migrated user data from cestisUsers to dashboardUsers');
  }
})();

// Also migrate session from old localStorage to sessionStorage if needed
(function migrateSession(){
  var oldSessionKey='cestisSession';
  var oldSession=localStorage.getItem(oldSessionKey);
  if(oldSession&&sessionStorage.getItem('isLoggedIn')!=='true'){
    try{
      var s=JSON.parse(oldSession);
      sessionStorage.setItem('isLoggedIn','true');
      sessionStorage.setItem('loggedInUser',JSON.stringify({
        username:s.username,displayName:s.displayName,
        role:s.role,isAdmin:s.role==='admin'||s.role==='Administrator',
        twoFactorEnabled:false
      }));
    }catch(e){}
    localStorage.removeItem(oldSessionKey);
    console.log('[Migration] Migrated session from localStorage to sessionStorage');
  }
})();

let users=JSON.parse(localStorage.getItem(USERS_KEY)||'null')||getDefaultUsers();

function loadUsers(){
  try{const d=localStorage.getItem(USERS_KEY);return d?JSON.parse(d):getDefaultUsers();}
  catch(e){return getDefaultUsers();}
}
function saveUsers(usrs){
  if(usrs)users=usrs;
  localStorage.setItem(USERS_KEY,JSON.stringify(users));
}

function loadPermissions(){
  try{const d=localStorage.getItem(PERMS_KEY);return d?JSON.parse(d):[];}
  catch(e){return [];}
}
function savePermissions(perms){localStorage.setItem(PERMS_KEY,JSON.stringify(perms));}

// ==================== LOGIN HANDLER (CESTIS-MAIN-DASHBOARD PATTERN) ====================
async function handleLogin(event){
  if(event)event.preventDefault();
  var username=document.getElementById('username').value.trim();
  var password=document.getElementById('password').value.trim();
  var loginError=document.getElementById('loginError');
  var loginBtnEl=document.getElementById('loginBtn');

  if(!username||!password){
    document.getElementById('loginErrorText').textContent='Please enter username and password';
    loginError.classList.add('show');
    return;
  }
  loginBtnEl.disabled=true;

  // Ensure users are persisted before checking
  if(!localStorage.getItem(USERS_KEY))saveUsers(loadUsers());
  users=loadUsers();

  // Case-insensitive username match
  var user=users.find(function(u){
    return u.username.toLowerCase()===username.toLowerCase()&&u.password===password;
  });

  var usernameExists=users.find(function(u){
    return u.username.toLowerCase()===username.toLowerCase();
  });

  if(user){
    loginError.classList.remove('show');
    if(user.twoFactorEnabled&&user.twoFactorSecret){
      // Show 2FA step
      pendingTwoFAUser=user;
      document.getElementById('loginStep1').style.display='none';
      document.getElementById('loginStep2FA').style.display='block';
      document.getElementById('login2FACode').focus();
      loginBtnEl.disabled=false;
    }else{
      completeLogin(user);
    }
  }else if(!usernameExists){
    // Username not found locally ‚Äî try cloud sync
    loginError.classList.add('show');
    var savedToken=localStorage.getItem('schoolDashboardGoogleAccessToken');
    var savedExpiry=localStorage.getItem('schoolDashboardGoogleTokenExpiry');
    var hasValidToken=savedToken&&savedExpiry&&new Date(savedExpiry)>new Date();

    if(hasValidToken){
      document.getElementById('loginErrorText').textContent='Account not found locally. Syncing from cloud...';
      await autoSyncAndRetryLogin(username,password);
    }else{
      document.getElementById('loginErrorText').innerHTML='<strong>Account not found</strong>. Please use "Sync from Cloud" to load your account.';
      showFirstTimeSection();
    }
    loginBtnEl.disabled=false;
  }else{
    loginError.classList.add('show');
    document.getElementById('loginErrorText').textContent='Invalid password. Please try again.';
    loginBtnEl.disabled=false;
  }
}

// Cloud Auto-Sync & Retry Login (CESTIS-MAIN-DASHBOARD pattern)
async function autoSyncAndRetryLogin(username,password){
  var loginError=document.getElementById('loginError');
  try{
    var savedToken=localStorage.getItem('schoolDashboardGoogleAccessToken');
    if(savedToken){
      googleAccessToken=savedToken;
      isCloudConnected=true;
    }
    if(!cloudFileId){
      var savedFileId=localStorage.getItem('schoolDashboardCloudFileId');
      if(savedFileId)cloudFileId=savedFileId;
      else await findExistingBackupFile();
    }
    if(!cloudFileId){
      document.getElementById('loginErrorText').textContent='No cloud backup found. Please contact your administrator.';
      return;
    }
    showLoginSyncOverlay('Syncing from cloud...','Checking for your account credentials');

    var response=await fetch(
      'https://www.googleapis.com/drive/v3/files/'+cloudFileId+'?alt=media',
      {headers:{'Authorization':'Bearer '+googleAccessToken}}
    );
    if(!response.ok)throw new Error('Failed to download from cloud');
    var backup=await response.json();
    if(!backup.users&&!backup.data)throw new Error('Invalid backup format');

    // Restore data from cloud
    if(backup.users){users=backup.users;localStorage.setItem(USERS_KEY,JSON.stringify(users));}
    if(backup.data){DATA=backup.data;saveStore();}
    if(backup.permissions&&Array.isArray(backup.permissions))savePermissions(backup.permissions);

    lastSyncTime=new Date();
    localStorage.setItem('schoolDashboardLastSyncTime',lastSyncTime.toISOString());
    hideLoginSyncOverlay();

    // Retry login with synced data
    var user=users.find(function(u){
      return u.username.toLowerCase()===username.toLowerCase()&&u.password===password;
    });
    if(user){
      loginError.classList.remove('show');
      if(user.twoFactorEnabled&&user.twoFactorSecret){
        pendingTwoFAUser=user;
        document.getElementById('loginStep1').style.display='none';
        document.getElementById('loginStep2FA').style.display='block';
      }else{
        completeLogin(user);
      }
    }else{
      var usernameExistsAfterSync=users.find(function(u){return u.username.toLowerCase()===username.toLowerCase();});
      document.getElementById('loginErrorText').textContent=usernameExistsAfterSync
        ?'Cloud data synced, but the password is incorrect.'
        :'Account not found even after syncing from cloud.';
    }
  }catch(error){
    console.error('Auto-sync error:',error);
    hideLoginSyncOverlay();
    if(error.message.includes('invalid_token')||error.message.includes('Invalid Credentials')){
      document.getElementById('loginErrorText').textContent='Cloud session expired. Please reconnect.';
      localStorage.removeItem('schoolDashboardGoogleAccessToken');
      localStorage.removeItem('schoolDashboardGoogleTokenExpiry');
    }else{
      document.getElementById('loginErrorText').textContent='Could not sync: '+error.message;
    }
    showFirstTimeSection();
  }
}

// Complete Login (CESTIS-MAIN-DASHBOARD pattern ‚Äî uses sessionStorage)
function completeLogin(user){
  currentUser=user;
  sessionStorage.setItem('isLoggedIn','true');
  sessionStorage.setItem('loggedInUser',JSON.stringify({
    username:user.username,displayName:user.displayName,
    role:user.role,isAdmin:user.isAdmin||user.role==='admin'||user.role==='Administrator',
    twoFactorEnabled:user.twoFactorEnabled||false
  }));
  sessionStorage.setItem('cestisAttendanceCurrentUser',JSON.stringify(user));

  pendingTwoFAUser=null;
  document.getElementById('loginStep1').style.display='block';
  document.getElementById('loginStep2FA').style.display='none';
  var backupSection=document.getElementById('backupCodeSection');
  if(backupSection)backupSection.style.display='none';
  var login2FA=document.getElementById('login2FACode');
  if(login2FA)login2FA.value='';
  var loginBackup=document.getElementById('loginBackupCode');
  if(loginBackup)loginBackup.value='';
  var loginBtnEl=document.getElementById('loginBtn');
  if(loginBtnEl)loginBtnEl.disabled=false;

  checkAuth();
  showNotification('Welcome, '+(user.displayName||user.username)+'!');
  promptSyncOnLogin();
}

// Check Auth & Session Management (CESTIS-MAIN-DASHBOARD pattern)
function checkAuth(){
  var isLoggedIn=sessionStorage.getItem('isLoggedIn')==='true';
  var loginPage=document.getElementById('loginPage');
  var dashboardContainer=document.getElementById('dashboardContainer');
  var settingsBtn=document.querySelector('.settings-btn');

  if(isLoggedIn){
    // Hide login page, show dashboard ‚Äî use direct style for reliability
    loginPage.style.display='none';
    loginPage.classList.add('hidden');
    dashboardContainer.style.display='flex';
    dashboardContainer.classList.add('visible');
    updateUserDisplay();

    var loggedInUser=JSON.parse(sessionStorage.getItem('loggedInUser'));
    if(loggedInUser){
      currentUser=users.find(function(u){return u.username.toLowerCase()===loggedInUser.username.toLowerCase();})||loggedInUser;
    }

    // Show/hide settings based on user role
    if(loggedInUser&&(isAdminRole(loggedInUser.role)||loggedInUser.isAdmin)){
      if(settingsBtn)settingsBtn.classList.remove('hidden');
    }else{
      if(settingsBtn)settingsBtn.classList.add('hidden');
    }

    // Update sidebar user info
    document.getElementById('sidebarUser').style.display='';
    if(currentUser&&currentUser.displayName){
      document.getElementById('sidebarAvatar').textContent=currentUser.displayName.charAt(0).toUpperCase();
      document.getElementById('sidebarUserName').textContent=currentUser.displayName;
    }
    var roleDisplay=(currentUser&&isAdminRole(currentUser.role))?'Administrator':(currentUser&&currentUser.role==='viewer')?'Viewer':'User';
    document.getElementById('sidebarUserRole').textContent=roleDisplay;
    // Show/hide admin-only nav
    document.getElementById('navUserMgmt').style.display=(currentUser&&(isAdminRole(currentUser.role)||currentUser.isAdmin))?'':'none';
    updatePermBadge();
    startPermTimer();
    renderDashboard();
  }else{
    // Show login page, hide dashboard
    loginPage.style.display='';
    loginPage.classList.remove('hidden');
    dashboardContainer.style.display='none';
    dashboardContainer.classList.remove('visible');
    currentUser=null;
  }
}

// Update user display from sessionStorage
function updateUserDisplay(){
  var loggedInUser=JSON.parse(sessionStorage.getItem('loggedInUser'));
  if(loggedInUser){
    document.getElementById('loggedInUserName').textContent=loggedInUser.displayName;
    document.getElementById('loggedInUserRole').textContent=loggedInUser.role;
  }
}

// Show notification helper
function showNotification(message){
  // Simple notification ‚Äî auto-dismiss after 3 seconds
  var notif=document.createElement('div');
  notif.style.cssText='position:fixed;top:1rem;right:1rem;z-index:99999;background:var(--card);border:1px solid var(--green);border-radius:10px;padding:.8rem 1.2rem;color:var(--green);font-size:.85rem;font-weight:600;box-shadow:0 8px 30px rgba(0,0,0,.3);transition:opacity .3s;';
  notif.textContent=message;
  document.body.appendChild(notif);
  setTimeout(function(){notif.style.opacity='0';setTimeout(function(){notif.remove();},300);},3000);
}

// Mandatory Post-Login Cloud Sync (CESTIS-MAIN-DASHBOARD pattern)
function promptSyncOnLogin(){
  var savedToken=localStorage.getItem('schoolDashboardGoogleAccessToken');
  var savedExpiry=localStorage.getItem('schoolDashboardGoogleTokenExpiry');
  setTimeout(function(){
    if(!savedToken||!savedExpiry){showConnectCloudOnLoginModal();return;}
    if(new Date(savedExpiry)<=new Date()){showConnectCloudOnLoginModal();return;}
    showSyncOnLoginModal();
  },500);
}

// Modal: prompt to connect to Google Drive after login
function showConnectCloudOnLoginModal(){
  var existing=document.getElementById('connectCloudOnLoginModal');
  if(existing)existing.remove();
  var modal=document.createElement('div');
  modal.id='connectCloudOnLoginModal';
  modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:10001;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)';
  modal.innerHTML='<div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:2rem;max-width:420px;width:90%;text-align:center;box-shadow:0 25px 50px rgba(0,0,0,.5)">'
    +'<div style="font-size:2rem;margin-bottom:.75rem">‚òÅÔ∏è</div>'
    +'<h3 style="font-size:1.1rem;font-weight:700;color:var(--text);margin-bottom:.5rem">Connect to Google Cloud</h3>'
    +'<p style="font-size:.85rem;color:var(--text-dim);line-height:1.5;margin-bottom:1.25rem">To keep your data synchronized across devices, please connect to Google Drive. This ensures your payroll data is backed up and always available.</p>'
    +'<button onclick="closeConnectCloudOnLoginModal(true)" style="display:inline-flex;align-items:center;gap:.5rem;padding:.7rem 1.5rem;background:var(--primary);color:#fff;border:none;border-radius:10px;font-family:inherit;font-size:.88rem;font-weight:600;cursor:pointer;box-shadow:0 4px 15px rgba(59,130,246,.3)">‚òÅÔ∏è Connect & Sync with Google</button>'
    +'<button onclick="closeConnectCloudOnLoginModal(false)" style="display:block;margin:.75rem auto 0;background:none;border:none;color:var(--text-muted);font-size:.78rem;cursor:pointer;font-family:inherit">Skip for now</button>'
    +'</div>';
  document.body.appendChild(modal);
}

function closeConnectCloudOnLoginModal(shouldConnect){
  document.getElementById('connectCloudOnLoginModal')?.remove();
  if(shouldConnect)connectToGoogleDrive();
}

// Modal: prompt to merge from cloud after login
function showSyncOnLoginModal(){
  var existing=document.getElementById('syncOnLoginModal');
  if(existing)existing.remove();
  var modal=document.createElement('div');
  modal.id='syncOnLoginModal';
  modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:10001;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)';
  modal.innerHTML='<div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:2rem;max-width:420px;width:90%;text-align:center;box-shadow:0 25px 50px rgba(0,0,0,.5)">'
    +'<div style="font-size:2rem;margin-bottom:.75rem">üîÄ</div>'
    +'<h3 style="font-size:1.1rem;font-weight:700;color:var(--text);margin-bottom:.5rem">Sync from Cloud</h3>'
    +'<p style="font-size:.85rem;color:var(--text-dim);line-height:1.5;margin-bottom:1.25rem">Merge the latest data from Google Drive to ensure you have the most up-to-date payroll records and user accounts.</p>'
    +'<button id="syncOnLoginMergeBtn" onclick="closeSyncOnLoginModal(true)" style="display:inline-flex;align-items:center;gap:.5rem;padding:.7rem 1.5rem;background:var(--primary);color:#fff;border:none;border-radius:10px;font-family:inherit;font-size:.88rem;font-weight:600;cursor:pointer;box-shadow:0 4px 15px rgba(59,130,246,.3)">üîÄ Merge from Cloud</button>'
    +'<button onclick="closeSyncOnLoginModal(false)" style="display:block;margin:.75rem auto 0;background:none;border:none;color:var(--text-muted);font-size:.78rem;cursor:pointer;font-family:inherit">Skip for now</button>'
    +'</div>';
  document.body.appendChild(modal);
}

async function closeSyncOnLoginModal(shouldSync){
  if(!shouldSync){document.getElementById('syncOnLoginModal')?.remove();return;}
  var mergeBtn=document.getElementById('syncOnLoginMergeBtn');
  if(mergeBtn){mergeBtn.disabled=true;mergeBtn.textContent='‚è≥ Merging...';}
  var success=await performAutoSyncOnLogin();
  if(success){
    document.getElementById('syncOnLoginModal')?.remove();
    sessionStorage.setItem('cloudSyncCompleted','true');
    showNotification('Cloud data merged successfully!');
  }else{
    if(mergeBtn){mergeBtn.disabled=false;mergeBtn.textContent='üîÄ Retry Merge';}
  }
}

async function performAutoSyncOnLogin(){
  try{
    var token=localStorage.getItem('schoolDashboardGoogleAccessToken');
    if(!token)return false;
    var fileId=localStorage.getItem('schoolDashboardCloudFileId');
    if(!fileId){
      // Search for backup file
      var query="name='"+GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME+"' and '"+GOOGLE_DRIVE_CONFIG.FOLDER_ID+"' in parents and trashed=false";
      var searchResp=await fetch('https://www.googleapis.com/drive/v3/files?q='+encodeURIComponent(query)+'&fields=files(id,name)&orderBy=modifiedTime%20desc&pageSize=1',{headers:{'Authorization':'Bearer '+token}});
      if(searchResp.ok){
        var searchData=await searchResp.json();
        if(searchData.files&&searchData.files.length>0){
          fileId=searchData.files[0].id;
          localStorage.setItem('schoolDashboardCloudFileId',fileId);
        }
      }
    }
    if(!fileId)return false;
    var resp=await fetch('https://www.googleapis.com/drive/v3/files/'+fileId+'?alt=media',{headers:{'Authorization':'Bearer '+token}});
    if(!resp.ok)return false;
    var backup=await resp.json();

    // Merge data from cloud
    if(backup.users&&Array.isArray(backup.users)){
      var localUsers=loadUsers();
      backup.users.forEach(function(cu){
        var existing=localUsers.find(function(u){return u.username.toLowerCase()===cu.username.toLowerCase();});
        if(!existing)localUsers.push(cu);
        else{existing.displayName=cu.displayName;existing.role=cu.role;if(cu.password)existing.password=cu.password;}
      });
      users=localUsers;
      saveUsers(localUsers);
    }
    if(backup.data){DATA=backup.data;saveStore();}
    if(backup.permissions&&Array.isArray(backup.permissions))savePermissions(backup.permissions);
    lastSyncTime=new Date();
    localStorage.setItem('schoolDashboardLastSyncTime',lastSyncTime.toISOString());
    return true;
  }catch(err){
    console.error('[SyncOnLogin] Error:',err);
    return false;
  }
}

// findExistingBackupFile is defined in the cloud sync section above

// Debug panel: show stored accounts on login screen
function toggleLoginDebug(){
  var panel=document.getElementById('loginDebugPanel');
  if(!panel)return;
  if(panel.style.display==='none'){
    panel.style.display='block';
    var users=loadUsers();
    if(!users||users.length===0){
      panel.innerHTML='<div style="color:var(--text-muted)">No accounts stored in browser. Use Sync with Google Cloud below to load accounts.</div>';
      return;
    }
    var html='<div style="margin-bottom:.4rem;font-weight:600;color:var(--text)">'+users.length+' stored account(s):</div>';
    users.forEach(function(u){
      var pwPreview=u.password?(u.password.charAt(0)+'***'+u.password.charAt(u.password.length-1)+' ('+u.password.length+' chars)'):'<span style="color:var(--danger)">NO PASSWORD</span>';
      html+='<div style="padding:.3rem 0;border-bottom:1px solid var(--border)">';
      html+='<span style="color:var(--primary);font-weight:600">'+u.username+'</span>';
      html+=' <span style="color:var(--text-muted)">('+u.role+')</span>';
      html+='<br><span style="color:var(--text-muted);font-size:.65rem">Password: '+pwPreview+'</span>';
      html+='</div>';
    });
    panel.innerHTML=html;
  }else{
    panel.style.display='none';
  }
}

// Helper: format user list for display in sync banners
function formatSyncedUserList(users){
  if(!users||!users.length)return '0 accounts';
  var names=users.map(function(u){return u.username;});
  return '<strong>'+users.length+'</strong> account(s): <strong>'+names.join('</strong>, <strong>')+'</strong>';
}

function showLoginSyncOverlay(text,sub){
  var overlay=document.getElementById('loginSyncOverlay');
  if(!overlay)return;
  document.getElementById('loginSyncOverlayText').textContent=text||'Syncing from cloud...';
  document.getElementById('loginSyncOverlaySub').textContent=sub||'';
  overlay.classList.add('show');
  var btn=document.getElementById('loginBtn');if(btn)btn.disabled=true;
}
function hideLoginSyncOverlay(){
  var overlay=document.getElementById('loginSyncOverlay');
  if(overlay)overlay.classList.remove('show');
  var btn=document.getElementById('loginBtn');if(btn)btn.disabled=false;
}

function updateLoginCloudBanner(type,message){
  var banner=document.getElementById('loginCloudBanner');
  var icon=document.getElementById('loginBannerIcon');
  var text=document.getElementById('loginBannerText');
  if(!banner)return;
  banner.style.display='flex';
  banner.className='login-cloud-banner '+(type||'');
  if(type==='synced'){icon.textContent='‚úÖ';}
  else if(type==='syncing'){icon.textContent='üîÑ';}
  else if(type==='error'){icon.textContent='‚ö†Ô∏è';}
  else{icon.textContent='‚òÅÔ∏è';}
  text.innerHTML=message||'';
}

function handleLogout(){
  sessionStorage.removeItem('isLoggedIn');
  sessionStorage.removeItem('loggedInUser');
  sessionStorage.removeItem('firstTimeSyncDismissed');
  sessionStorage.removeItem('cloudSyncCompleted');
  sessionStorage.removeItem('cestisAttendanceCurrentUser');
  currentUser=null;
  pendingTwoFAUser=null;
  if(permTimerInterval){clearInterval(permTimerInterval);permTimerInterval=null;}
  checkAuth();
  document.getElementById('username').value='';
  document.getElementById('password').value='';
  document.getElementById('loginError').classList.remove('show');
  // Reset all login steps to step 1
  document.getElementById('loginStep1').style.display='block';
  document.getElementById('loginStep2FA').style.display='none';
  document.getElementById('loginStepForgotPassword').style.display='none';
  document.getElementById('loginStepOTP').style.display='none';
  document.getElementById('loginStepNewPassword').style.display='none';
  var backupSection=document.getElementById('backupCodeSection');
  if(backupSection)backupSection.style.display='none';
  currentOTP=null;otpExpiry=null;pendingResetUser=null;
  // Reset first-time card to default state
  var ftCard=document.getElementById('firstTimeCard');
  if(ftCard)ftCard.className='first-time-card';
  var ftBtn=document.getElementById('ftSyncBtn');
  if(ftBtn){ftBtn.classList.remove('loading');ftBtn.disabled=false;}
  var ftLabel=document.getElementById('ftBtnLabel');
  if(ftLabel)ftLabel.textContent='Sync with Google Cloud';
  var ftStatus=document.getElementById('ftStatus');
  if(ftStatus){ftStatus.className='ft-status';ftStatus.textContent='';}
  document.getElementById('ftCloudIcon').textContent='\u2601';
  document.getElementById('ftTitle').textContent='Sync with Google Cloud';
  document.getElementById('ftDesc').textContent='Sign in with Google to load your credentials and data directly from the school\'s Google Drive folder.';
  document.getElementById('ftGoogleAccount').style.display='none';
  checkFirstTimeSyncPrompt();
}

// Legacy alias
function doLogout(){handleLogout();}

// Check if first-time sync prompt should be shown
function checkFirstTimeSyncPrompt(){
  // Show cloud sync prompt if only default admin exists
  var localUsers=loadUsers();
  var hasOnlyDefault=localUsers.length<=1&&localUsers[0]&&(localUsers[0].username.toLowerCase()==='cestisadmin');
  var dismissed=sessionStorage.getItem('firstTimeSyncDismissed');
  if(hasOnlyDefault&&!dismissed){
    showFirstTimeSection();
  }else{
    autoSyncCredentialsOnLoad();
  }
}

// Legacy loginCloudSync ‚Äî redirects to the new First Time Google sync
async function loginCloudSync(){
  showFirstTimeSection();
  firstTimeGoogleSync();
}

// ==================== FIRST TIME GOOGLE SYNC ====================

// First-Time Google Sign-In & Sync ‚Äî prominent card on login screen
async function firstTimeGoogleSync(){
  var btn=document.getElementById('ftSyncBtn');
  var label=document.getElementById('ftBtnLabel');
  var status=document.getElementById('ftStatus');
  var card=document.getElementById('firstTimeCard');
  var accountEl=document.getElementById('ftGoogleAccount');

  // Set connecting state
  btn.classList.add('loading');
  btn.disabled=true;
  label.textContent='Connecting...';
  status.className='ft-status info';
  status.textContent='Waiting for Google sign-in...';
  card.className='first-time-card connecting';

  var token=null;
  // Try to get token via Google Identity Services
  if(typeof google!=='undefined'&&google.accounts&&google.accounts.oauth2){
    try{
      token=await new Promise(function(resolve,reject){
        var client=google.accounts.oauth2.initTokenClient({
          client_id:GOOGLE_DRIVE_CONFIG.CLIENT_ID,
          scope:GOOGLE_DRIVE_CONFIG.SCOPES,
          callback:function(resp){
            if(resp.error)reject(new Error(resp.error));
            else resolve(resp.access_token);
          }
        });
        client.requestAccessToken();
      });
      // Save token
      googleAccessToken=token;
      var tokenExpiry=new Date(Date.now()+3500*1000);
      localStorage.setItem('schoolDashboardGoogleAccessToken',token);
      localStorage.setItem('schoolDashboardGoogleTokenExpiry',tokenExpiry.toISOString());
    }catch(err){
      btn.classList.remove('loading');
      btn.disabled=false;
      label.textContent='Sync with Google Cloud';
      status.className='ft-status error';
      status.textContent='Google sign-in cancelled or failed. Try again.';
      card.className='first-time-card error';
      return;
    }
  }else{
    btn.classList.remove('loading');
    btn.disabled=false;
    label.textContent='Sync with Google Cloud';
    status.className='ft-status error';
    status.textContent='Google API not loaded. Please refresh the page.';
    card.className='first-time-card error';
    return;
  }

  // Fetch Google account info to show who signed in
  try{
    var aboutResp=await fetch('https://www.googleapis.com/drive/v3/about?fields=user',{
      headers:{'Authorization':'Bearer '+token}
    });
    if(aboutResp.ok){
      var aboutData=await aboutResp.json();
      var gUser=aboutData.user;
      if(gUser){
        var displayName=gUser.displayName||'Google User';
        var email=gUser.emailAddress||'';
        document.getElementById('ftAccountName').textContent=displayName;
        document.getElementById('ftAccountEmail').textContent=email;
        document.getElementById('ftAvatar').textContent=displayName.charAt(0).toUpperCase();
        accountEl.style.display='flex';
      }
    }
  }catch(e){/* non-critical */}

  // Now sync data from Google Drive
  label.textContent='Syncing data...';
  status.className='ft-status info';
  status.textContent='Searching for backup in Google Drive...';
  card.className='first-time-card syncing';

  try{
    // Always search fresh for the most recent backup (ignore stale cached ID)
    var fileId=null;
    {
      var query="name='"+GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME+"' and '"+GOOGLE_DRIVE_CONFIG.FOLDER_ID+"' in parents and trashed=false";
      var searchResp=await fetch(
        'https://www.googleapis.com/drive/v3/files?q='+encodeURIComponent(query)+'&fields=files(id,name)&orderBy=modifiedTime%20desc&pageSize=1',
        {headers:{'Authorization':'Bearer '+token}}
      );
      if(searchResp.ok){
        var searchData=await searchResp.json();
        if(searchData.files&&searchData.files.length>0){
          fileId=searchData.files[0].id;
          localStorage.setItem('schoolDashboardCloudFileId',fileId);
        }
      }
    }

    if(!fileId){
      btn.classList.remove('loading');
      btn.disabled=false;
      label.textContent='Sync with Google Cloud';
      status.className='ft-status error';
      status.textContent='No backup file found in Google Drive. Ask your admin to save data to cloud first.';
      card.className='first-time-card error';
      return;
    }

    status.textContent='Downloading data from Google Drive...';

    var resp=await fetch(
      'https://www.googleapis.com/drive/v3/files/'+fileId+'?alt=media',
      {headers:{'Authorization':'Bearer '+token}}
    );
    if(!resp.ok)throw new Error('Download failed ('+resp.status+')');
    var backupData=await resp.json();

    // Log cloud backup contents for debugging
    console.log('[FirstTimeSync] Cloud backup has',backupData.users?backupData.users.length:0,'users:',
      backupData.users?backupData.users.map(function(u){return u.username+'(pw:'+(u.password?u.password.length+'chars':'NONE')+')';}):[]
    );

    // Merge users
    var synced=false;
    if(backupData.users&&Array.isArray(backupData.users)&&backupData.users.length>0){
      var localUsers=loadUsers();
      var added=0;
      backupData.users.forEach(function(cu){
        var existing=localUsers.find(function(u){return u.username.toLowerCase()===cu.username.toLowerCase();});
        if(!existing){localUsers.push(cu);added++;}
        else{existing.displayName=cu.displayName;existing.role=cu.role;if(cu.password)existing.password=cu.password;}
      });
      if(!localUsers.some(function(u){return u.username.toLowerCase()==='cestisadmin';}))localUsers.push(getDefaultUsers()[0]);
      saveUsers(localUsers);
      synced=true;

      // Verify the save by re-reading
      var verify=loadUsers();
      console.log('[FirstTimeSync] Verified localStorage has',verify.length,'users:',
        verify.map(function(u){return u.username+'(pw:'+(u.password?u.password.length+'chars':'NONE')+')';}));
    }
    // Sync main data & permissions
    if(backupData.data){DATA=backupData.data;saveStore();}
    if(backupData.permissions&&Array.isArray(backupData.permissions))savePermissions(backupData.permissions);

    // Update cloud state so the main app recognizes the connection
    isCloudConnected=true;
    cloudFileId=fileId;
    lastSyncTime=new Date();
    localStorage.setItem('schoolDashboardLastSyncTime',lastSyncTime.toISOString());

    btn.classList.remove('loading');
    if(synced){
      var syncedUsers=loadUsers();
      var syncedNames=syncedUsers.map(function(u){return u.username;}).join(', ');
      label.textContent='Synced!';
      btn.disabled=true;
      status.className='ft-status success';
      status.textContent=syncedUsers.length+' account(s) loaded: '+syncedNames+'. You can now sign in above.';
      card.className='first-time-card synced';
      document.getElementById('ftCloudIcon').textContent='\u2705';
      document.getElementById('ftTitle').textContent='Cloud Data Loaded';
      document.getElementById('ftDesc').textContent='Your credentials and payroll data have been synced from Google Drive. Enter your username and password above to sign in.';
      updateLoginCloudBanner('synced','Cloud synced ‚Äî '+formatSyncedUserList(syncedUsers)+'. Sign in above.');
    }else{
      label.textContent='Sync with Google Cloud';
      btn.disabled=false;
      status.className='ft-status';
      status.textContent='Connected to cloud but no user accounts found in backup.';
      card.className='first-time-card';
    }
  }catch(err){
    btn.classList.remove('loading');
    btn.disabled=false;
    label.textContent='Retry Sync';
    status.className='ft-status error';
    status.textContent='Sync failed: '+err.message;
    card.className='first-time-card error';
  }
}

function dismissFirstTime(){
  var section=document.getElementById('firstTimeSection');
  if(section)section.style.display='none';
  localStorage.setItem('cestisFirstTimeDismissed','1');
}

function showFirstTimeSection(){
  var section=document.getElementById('firstTimeSection');
  if(section)section.style.display='';
}
function hideFirstTimeSection(){
  var section=document.getElementById('firstTimeSection');
  if(section)section.style.display='none';
}

// Auto-sync credentials from cloud on page load (silent, non-blocking)
async function autoSyncCredentialsOnLoad(){
  var token=localStorage.getItem('schoolDashboardGoogleAccessToken');
  var expiry=localStorage.getItem('schoolDashboardGoogleTokenExpiry');
  var fileId=localStorage.getItem('schoolDashboardCloudFileId');
  var statusEl=document.getElementById('loginCloudStatus');
  var dismissed=localStorage.getItem('cestisFirstTimeDismissed');

  if(!token||!expiry||new Date(expiry)<=new Date()){
    // No valid token ‚Äî show the First Time section unless dismissed
    var hasEverConnected=localStorage.getItem('schoolDashboardCloudFileId')||localStorage.getItem('schoolDashboardLastSyncTime');
    if(hasEverConnected){
      updateLoginCloudBanner('error','Cloud session expired. Click <strong>Sync with Google Cloud</strong> below to reconnect.');
      // Show first time section with reconnect messaging
      showFirstTimeSection();
      document.getElementById('ftTitle').textContent='Reconnect to Google Cloud';
      document.getElementById('ftDesc').textContent='Your previous session has expired. Sign in with Google again to sync the latest data from the school\'s Drive folder.';
    }else if(!dismissed){
      showFirstTimeSection();
    }else{
      hideFirstTimeSection();
    }
    return;
  }

  // Valid token exists ‚Äî hide First Time section and auto-sync silently
  hideFirstTimeSection();
  updateLoginCloudBanner('syncing','Auto-syncing credentials from cloud...');
  if(statusEl){statusEl.style.display='block';statusEl.style.color='var(--text-muted)';statusEl.textContent='Auto-syncing credentials from cloud...';}
  try{
    // Always search for the most recent backup file (clear stale cached ID)
    fileId=null;
    {
      var query="name='"+GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME+"' and '"+GOOGLE_DRIVE_CONFIG.FOLDER_ID+"' in parents and trashed=false";
      var searchResp=await fetch('https://www.googleapis.com/drive/v3/files?q='+encodeURIComponent(query)+'&fields=files(id,name)&orderBy=modifiedTime%20desc&pageSize=1',{headers:{'Authorization':'Bearer '+token}});
      if(searchResp.ok){var searchData=await searchResp.json();if(searchData.files&&searchData.files.length>0){fileId=searchData.files[0].id;localStorage.setItem('schoolDashboardCloudFileId',fileId);}}
    }
    if(!fileId){
      updateLoginCloudBanner('error','No cloud backup found. Ask your admin to save data to cloud.');
      showFirstTimeSection();
      if(statusEl){statusEl.textContent='';statusEl.style.display='none';}
      return;
    }
    var resp=await fetch('https://www.googleapis.com/drive/v3/files/'+fileId+'?alt=media',{headers:{'Authorization':'Bearer '+token}});
    if(!resp.ok){
      updateLoginCloudBanner('error','Could not reach cloud backup. Try syncing again.');
      showFirstTimeSection();
      if(statusEl){statusEl.textContent='';statusEl.style.display='none';}
      return;
    }
    var backupData=await resp.json();
    if(backupData.users&&Array.isArray(backupData.users)&&backupData.users.length>0){
      var localUsers=loadUsers();
      var added=0;
      backupData.users.forEach(function(cu){
        var existing=localUsers.find(function(u){return u.username.toLowerCase()===cu.username.toLowerCase();});
        if(!existing){localUsers.push(cu);added++;}
        else{existing.displayName=cu.displayName;existing.role=cu.role;if(cu.password)existing.password=cu.password;}
      });
      if(!localUsers.some(function(u){return u.username.toLowerCase()==='cestisadmin';}))localUsers.push(getDefaultUsers()[0]);
      saveUsers(localUsers);
      if(backupData.data){DATA=backupData.data;saveStore();}
      if(backupData.permissions&&Array.isArray(backupData.permissions))savePermissions(backupData.permissions);
      updateLoginCloudBanner('synced','Cloud synced ‚Äî '+formatSyncedUserList(localUsers));
      if(statusEl){statusEl.style.color='var(--green)';statusEl.textContent='Cloud synced ‚Äî '+localUsers.map(function(u){return u.username;}).join(', ');}
      console.log('[AutoSync] Credentials synced from cloud:',localUsers.length,'users,',added,'new');
    }else{
      updateLoginCloudBanner('','Cloud connected ‚Äî no user accounts in backup.');
      if(statusEl){statusEl.textContent='';statusEl.style.display='none';}
    }
  }catch(err){
    console.log('[AutoSync] Silent sync failed:',err.message);
    updateLoginCloudBanner('error','Auto-sync failed. Try syncing again below.');
    showFirstTimeSection();
    if(statusEl){statusEl.textContent='';statusEl.style.display='none';}
  }
}

function checkSession(){
  try{
    var isLoggedIn=sessionStorage.getItem('isLoggedIn')==='true';
    if(isLoggedIn){
      var loggedInUser=JSON.parse(sessionStorage.getItem('loggedInUser'));
      if(loggedInUser){
        currentUser=users.find(function(u){return u.username.toLowerCase()===loggedInUser.username.toLowerCase();})||loggedInUser;
        return true;
      }
    }
  }catch(e){}
  return false;
}

function showApp(){
  checkAuth();
}

// ==================== USER MANAGEMENT (Admin) ====================
let editingUserId=null;

function openAddUserModal(){
  editingUserId=null;
  document.getElementById('userModalTitle').textContent='Add User';
  document.getElementById('newUserDisplayName').value='';
  document.getElementById('newUserUsername').value='';
  document.getElementById('newUserEmail').value='';
  document.getElementById('newUserPassword').value='';
  document.getElementById('newUserRole').value='user';
  document.getElementById('addUserModal').classList.add('show');
}
function closeAddUserModal(){document.getElementById('addUserModal').classList.remove('show');}

function editUser(uid){
  const users=loadUsers();
  const u=users.find(x=>x.id===uid);
  if(!u)return;
  editingUserId=uid;
  document.getElementById('userModalTitle').textContent='Edit User';
  document.getElementById('newUserDisplayName').value=u.displayName;
  document.getElementById('newUserUsername').value=u.username;
  document.getElementById('newUserEmail').value=u.email||'';
  document.getElementById('newUserPassword').value='';
  document.getElementById('newUserRole').value=u.role;
  document.getElementById('addUserModal').classList.add('show');
}

function saveUser(){
  const displayName=document.getElementById('newUserDisplayName').value.trim();
  const username=document.getElementById('newUserUsername').value.trim().toLowerCase();
  const email=document.getElementById('newUserEmail').value.trim();
  const password=document.getElementById('newUserPassword').value.trim();
  const role=document.getElementById('newUserRole').value;
  if(!displayName||!username){alert('Display name and username are required');return;}
  // Always ensure localStorage has users before modifying
  if(!localStorage.getItem(USERS_KEY))saveUsers(loadUsers());
  const users=loadUsers();
  if(editingUserId){
    const idx=users.findIndex(u=>u.id===editingUserId);
    if(idx<0)return;
    if(users.some(u=>u.id!==editingUserId&&u.username.toLowerCase()===username)){alert('Username already taken');return;}
    users[idx].displayName=displayName;
    users[idx].username=username;
    users[idx].email=email;
    users[idx].role=role;
    if(password)users[idx].password=password;
  }else{
    if(!password){alert('Password is required for new users');return;}
    if(users.some(u=>u.username.toLowerCase()===username)){alert('Username already taken');return;}
    users.push({
      id:'user_'+Date.now(),username:username,password:password,
      displayName:displayName,email:email,role:role,createdAt:new Date().toISOString()
    });
  }
  saveUsers(users);
  closeAddUserModal();
  renderUserManagement();
  var isNew=!editingUserId||password;
  var msg='User "'+displayName+'" saved successfully.\n\nUsername: '+username+'\nRole: '+role;
  if(email)msg+='\nEmail: '+email;
  if(isNew)msg+='\nPassword: '+password;

  // Auto-push to cloud if connected
  if(isCloudConnected&&googleAccessToken){
    msg+='\n\nAuto-syncing to cloud so this user can log in on other devices...';
    alert(msg);
    autoSaveUsersToCloud();
  }else{
    msg+='\n\nIMPORTANT: Connect to Cloud and Save so this user can log in on other devices.';
    alert(msg);
  }
}

function deleteUser(uid){
  const users=loadUsers();
  const u=users.find(x=>x.id===uid);
  if(!u)return;
  if(u.username.toLowerCase()==='cestisadmin'){alert('Cannot delete the main administrator account');return;}
  if(!confirm('Delete user "'+u.displayName+'"?'))return;
  saveUsers(users.filter(x=>x.id!==uid));
  renderUserManagement();
  // Auto-sync deletion to cloud
  if(isCloudConnected&&googleAccessToken)autoSaveUsersToCloud();
}

function isAdminRole(role){return role==='admin'||role==='Administrator';}
function renderUserManagement(){
  if(!currentUser||!isAdminRole(currentUser.role))return;
  const allUsers=loadUsers();
  const admins=allUsers.filter(u=>isAdminRole(u.role)).length;
  const userCount=allUsers.filter(u=>u.role==='user'||u.role==='User').length;
  const viewers=allUsers.filter(u=>u.role==='viewer').length;
  const twoFACount=allUsers.filter(u=>u.twoFactorEnabled).length;
  document.getElementById('userStats').innerHTML=
    '<div class="stat-card red"><div class="label">Admins</div><div class="value">'+admins+'</div><div class="sub">Full system access</div></div>'+
    '<div class="stat-card blue"><div class="label">Users</div><div class="value">'+userCount+'</div><div class="sub">Limited access</div></div>'+
    '<div class="stat-card gold"><div class="label">Viewers</div><div class="value">'+viewers+'</div><div class="sub">View only access</div></div>'+
    '<div class="stat-card green"><div class="label">Total Users</div><div class="value">'+allUsers.length+'</div><div class="sub">2FA enabled: '+twoFACount+'</div></div>';
  var html='<table><thead><tr><th>Name</th><th>Username</th><th>Email</th><th>Role</th><th>2FA</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
  allUsers.forEach(function(u){
    var roleClass=isAdminRole(u.role)?'admin':u.role==='viewer'?'viewer':'user';
    var roleLabel=isAdminRole(u.role)?'Admin':u.role==='viewer'?'Viewer':'User';
    var isMain=u.username.toLowerCase()==='cestisadmin';
    var twofaBadge=u.twoFactorEnabled?
      '<span class="twofa-status-badge enabled">üîí On</span>':
      '<span class="twofa-status-badge disabled">Off</span>';
    html+='<tr><td>'+u.displayName+(isMain?' <span style="color:var(--accent);font-size:.7rem">MAIN</span>':'')+'</td>'+
      '<td><code style="background:var(--surface);padding:.15rem .4rem;border-radius:4px;font-size:.8rem">'+u.username+'</code></td>'+
      '<td style="color:var(--text-muted);font-size:.8rem">'+(u.email||'‚Äî')+'</td>'+
      '<td><span class="role-tag '+roleClass+'">'+roleLabel+'</span></td>'+
      '<td>'+twofaBadge+'</td>'+
      '<td style="color:var(--text-muted);font-size:.8rem">'+(u.createdAt?fmtDate(u.createdAt):'‚Äî')+'</td>'+
      '<td><div class="btn-group">'+
        '<button class="btn btn-ghost btn-sm" onclick="editUser(\''+u.id+'\')">Edit</button>'+
        (isMain?'':'<button class="btn btn-danger btn-sm" onclick="deleteUser(\''+u.id+'\')">Delete</button>')+
      '</div></td></tr>';
  });
  if(allUsers.length===0)html+='<tr><td colspan="7" style="text-align:center;color:var(--text-muted);padding:2rem">No users</td></tr>';
  html+='</tbody></table>';

  // Add 2FA section for current user
  html+='<div style="margin-top:2rem;padding-top:1.5rem;border-top:1px solid var(--border)">';
  html+='<h3 style="font-size:1rem;font-weight:600;color:var(--text);margin-bottom:1rem">üîê Two-Factor Authentication (Your Account)</h3>';
  var fullUser=allUsers.find(function(u){return u.id===currentUser.id||u.username.toLowerCase()===currentUser.username.toLowerCase();});
  if(fullUser&&fullUser.twoFactorEnabled){
    var unusedCodes=fullUser.backupCodes?fullUser.backupCodes.filter(function(bc){return !bc.used;}).length:0;
    html+='<div class="twofa-success"><strong>Two-Factor Authentication is ENABLED</strong>';
    html+='<p style="margin-top:.4rem">Your account is protected with an authenticator app.</p>';
    html+='<p style="margin-top:.2rem;font-size:.8rem">Backup codes remaining: '+unusedCodes+'/8</p></div>';
    html+='<div class="btn-group" style="margin-top:1rem">';
    html+='<button class="btn btn-ghost btn-sm" onclick="showBackupCodes()">View Backup Codes</button>';
    html+='<button class="btn btn-warning btn-sm" onclick="regenerateBackupCodes()">Regenerate Codes</button>';
    html+='<button class="btn btn-danger btn-sm" onclick="openTwoFADisable()">Disable 2FA</button>';
    html+='</div>';
  }else{
    html+='<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:1rem;margin-bottom:1rem">';
    html+='<strong>Two-Factor Authentication is DISABLED</strong>';
    html+='<p style="margin-top:.4rem;color:var(--text-dim);font-size:.82rem">Add an extra layer of security using Google Authenticator or any TOTP-compatible app.</p></div>';
    html+='<button class="btn btn-success btn-sm" onclick="openTwoFASetup()">Enable 2FA</button>';
  }
  html+='</div>';

  document.getElementById('usersTable').innerHTML=html;
}

// ==================== TWO-FACTOR AUTHENTICATION (2FA) ====================

// Generate a random base32 secret for TOTP
function generateTOTPSecret(){
  var chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
  var secret='';
  for(var i=0;i<32;i++){secret+=chars.charAt(Math.floor(Math.random()*chars.length));}
  return secret;
}

// Verify TOTP code
function verifyTOTPCode(secret,code){
  try{
    var totp=new OTPAuth.TOTP({issuer:'CESTIS Payroll',label:'User',algorithm:'SHA1',digits:6,period:30,secret:secret});
    var delta=totp.validate({token:code,window:1});
    return delta!==null;
  }catch(e){console.error('Error verifying TOTP:',e);return false;}
}

// Generate TOTP URI for QR code
function generateTOTPUri(secret,username){
  var issuer='CESTIS%20Payroll';
  var label=encodeURIComponent(username);
  return 'otpauth://totp/'+issuer+':'+label+'?secret='+secret+'&issuer='+issuer+'&algorithm=SHA1&digits=6&period=30';
}

// Generate backup codes
function generateBackupCodes(){
  var codes=[];
  var chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  for(var i=0;i<8;i++){
    var code='';
    for(var j=0;j<8;j++){code+=chars.charAt(Math.floor(Math.random()*chars.length));}
    codes.push({code:code,used:false});
  }
  return codes;
}

// Open 2FA setup modal
function openTwoFASetup(){
  pendingTwoFASecret=generateTOTPSecret();
  document.getElementById('twofaSecretKey').textContent=pendingTwoFASecret.match(/.{1,4}/g).join(' ');
  var qrContainer=document.getElementById('twofaQRCode');
  qrContainer.innerHTML='';
  var uri=generateTOTPUri(pendingTwoFASecret,currentUser.username);
  new QRCode(qrContainer,{text:uri,width:200,height:200,colorDark:'#1a2540',colorLight:'#ffffff',correctLevel:QRCode.CorrectLevel.M});
  document.getElementById('twofaSetupCode').value='';
  document.getElementById('twofaSetupModal').style.display='flex';
}

function closeTwoFASetup(){
  document.getElementById('twofaSetupModal').style.display='none';
  pendingTwoFASecret=null;
}

// Confirm 2FA setup
function confirmTwoFASetup(){
  var code=document.getElementById('twofaSetupCode').value.trim();
  if(!code||code.length!==6){alert('Please enter the 6-digit code from your authenticator app');return;}
  if(!pendingTwoFASecret){alert('Setup session expired. Please try again.');closeTwoFASetup();return;}
  if(verifyTOTPCode(pendingTwoFASecret,code)){
    pendingBackupCodes=generateBackupCodes();
    var users=loadUsers();
    var userIndex=users.findIndex(function(u){return u.id===currentUser.id;});
    if(userIndex!==-1){
      users[userIndex].twoFactorEnabled=true;
      users[userIndex].twoFactorSecret=pendingTwoFASecret;
      users[userIndex].backupCodes=pendingBackupCodes;
      saveUsers(users);
    }
    closeTwoFASetup();
    showBackupCodesModal();
    renderUserManagement();
    if(isCloudConnected&&googleAccessToken)autoSaveUsersToCloud();
  }else{
    alert('Invalid code. Please check your authenticator app and try again.');
    document.getElementById('twofaSetupCode').value='';
    document.getElementById('twofaSetupCode').focus();
  }
}

// Show backup codes modal
function showBackupCodesModal(){
  var container=document.getElementById('twofaBackupCodes');
  var codes=pendingBackupCodes||(function(){var users=loadUsers();var u=users.find(function(x){return x.id===currentUser.id;});return u?u.backupCodes:[];})()||[];
  container.innerHTML=codes.map(function(bc){return '<div class="twofa-backup-code'+(bc.used?' used':'')+'">'+bc.code+'</div>';}).join('');
  document.getElementById('twofaBackupModal').style.display='flex';
}

function showBackupCodes(){pendingBackupCodes=null;showBackupCodesModal();}

function closeBackupCodesModal(){
  document.getElementById('twofaBackupModal').style.display='none';
  pendingBackupCodes=null;
}

// Copy backup codes to clipboard
function copyBackupCodes(){
  var users=loadUsers();
  var u=users.find(function(x){return x.id===currentUser.id;});
  var codes=pendingBackupCodes||(u?u.backupCodes:[])||[];
  var codesText=codes.map(function(bc,i){return(i+1)+'. '+bc.code+(bc.used?' (USED)':'');}).join('\n');
  var fullText='CESTIS Payroll - Backup Codes for '+currentUser.username+'\nGenerated: '+new Date().toLocaleString()+'\n\n'+codesText+'\n\nKeep these codes in a safe place. Each code can only be used once.';
  navigator.clipboard.writeText(fullText).then(function(){alert('Backup codes copied to clipboard!');}).catch(function(){alert('Failed to copy. Please manually select and copy the codes.');});
}

// Regenerate backup codes
function regenerateBackupCodes(){
  if(!confirm('This will invalidate all existing backup codes. Continue?'))return;
  pendingBackupCodes=generateBackupCodes();
  var users=loadUsers();
  var userIndex=users.findIndex(function(u){return u.id===currentUser.id;});
  if(userIndex!==-1){
    users[userIndex].backupCodes=pendingBackupCodes;
    saveUsers(users);
  }
  showBackupCodesModal();
  renderUserManagement();
  if(isCloudConnected&&googleAccessToken)autoSaveUsersToCloud();
}

// Open disable 2FA modal
function openTwoFADisable(){
  document.getElementById('twofaDisableCode').value='';
  document.getElementById('twofaDisableModal').style.display='flex';
}
function closeTwoFADisable(){document.getElementById('twofaDisableModal').style.display='none';}

// Confirm disable 2FA
function confirmTwoFADisable(){
  var code=document.getElementById('twofaDisableCode').value.trim();
  if(!code||code.length!==6){alert('Please enter the 6-digit code from your authenticator app');return;}
  var users=loadUsers();
  var u=users.find(function(x){return x.id===currentUser.id;});
  if(!u||!u.twoFactorSecret){alert('2FA is not enabled for this account.');closeTwoFADisable();return;}
  if(verifyTOTPCode(u.twoFactorSecret,code)){
    var userIndex=users.findIndex(function(x){return x.id===currentUser.id;});
    if(userIndex!==-1){
      users[userIndex].twoFactorEnabled=false;
      users[userIndex].twoFactorSecret=null;
      users[userIndex].backupCodes=null;
      saveUsers(users);
    }
    closeTwoFADisable();
    alert('Two-Factor Authentication has been disabled.');
    renderUserManagement();
    if(isCloudConnected&&googleAccessToken)autoSaveUsersToCloud();
  }else{
    alert('Invalid code. Please check your authenticator app and try again.');
    document.getElementById('twofaDisableCode').value='';
    document.getElementById('twofaDisableCode').focus();
  }
}

// Verify 2FA code during login
function verify2FALogin(){
  var code=document.getElementById('login2FACode').value.trim();
  var loginError=document.getElementById('loginError');
  if(!code||code.length!==6){document.getElementById('loginErrorText').textContent='Please enter a 6-digit code';loginError.classList.add('show');return;}
  if(!pendingTwoFAUser){document.getElementById('loginErrorText').textContent='Session expired. Please try again.';loginError.classList.add('show');cancelTwoFALogin();return;}
  if(verifyTOTPCode(pendingTwoFAUser.twoFactorSecret,code)){
    loginError.classList.remove('show');
    completeLogin(pendingTwoFAUser);
  }else{
    document.getElementById('loginErrorText').textContent='Invalid code. Please try again.';
    loginError.classList.add('show');
    document.getElementById('login2FACode').value='';
    document.getElementById('login2FACode').focus();
  }
}

// Verify backup code during login
function verifyBackupCodeLogin(){
  var backupCode=document.getElementById('loginBackupCode').value.trim().toUpperCase();
  var loginError=document.getElementById('loginError');
  if(!backupCode){document.getElementById('loginErrorText').textContent='Please enter a backup code';loginError.classList.add('show');return;}
  if(!pendingTwoFAUser){document.getElementById('loginErrorText').textContent='Session expired. Please try again.';loginError.classList.add('show');cancelTwoFALogin();return;}
  var codeIndex=pendingTwoFAUser.backupCodes?
    pendingTwoFAUser.backupCodes.findIndex(function(bc){return bc.code===backupCode&&!bc.used;}):
    -1;
  if(codeIndex!==-1){
    var allUsers=loadUsers();
    var userIndex=allUsers.findIndex(function(u){return u.id===pendingTwoFAUser.id;});
    if(userIndex!==-1){
      allUsers[userIndex].backupCodes[codeIndex].used=true;
      saveUsers(allUsers);
      pendingTwoFAUser=allUsers[userIndex];
    }
    loginError.classList.remove('show');
    completeLogin(pendingTwoFAUser);
  }else{
    document.getElementById('loginErrorText').textContent='Invalid or already used backup code';
    loginError.classList.add('show');
    document.getElementById('loginBackupCode').value='';
    document.getElementById('loginBackupCode').focus();
  }
}

// Show backup code input on login
function showBackupCodeInput(){document.getElementById('backupCodeSection').style.display='block';}

// Cancel 2FA login and go back
function cancelTwoFALogin(){
  pendingTwoFAUser=null;
  document.getElementById('loginStep1').style.display='block';
  document.getElementById('loginStep2FA').style.display='none';
  var backupSection=document.getElementById('backupCodeSection');
  if(backupSection)backupSection.style.display='none';
  document.getElementById('login2FACode').value='';
  var loginBackup=document.getElementById('loginBackupCode');
  if(loginBackup)loginBackup.value='';
  document.getElementById('password').value='';
  document.getElementById('loginError').classList.remove('show');
}

// ==================== FORGOT PASSWORD / OTP EMAIL ====================

// Generate a 6-digit OTP
function generateOTP(){return Math.floor(100000+Math.random()*900000).toString();}

// Show forgot password step
function showForgotPassword(){
  document.getElementById('loginStep1').style.display='none';
  document.getElementById('loginStepForgotPassword').style.display='block';
  document.getElementById('forgotPasswordEmail').value='';
  document.getElementById('forgotPasswordError').style.display='none';
  document.getElementById('loginError').classList.remove('show');
  document.getElementById('forgotPasswordEmail').focus();
}

// Cancel forgot password and return to login
function cancelForgotPassword(){
  document.getElementById('loginStep1').style.display='block';
  document.getElementById('loginStepForgotPassword').style.display='none';
  document.getElementById('loginStepOTP').style.display='none';
  document.getElementById('loginStepNewPassword').style.display='none';
  document.getElementById('username').value='';
  document.getElementById('password').value='';
  document.getElementById('loginError').classList.remove('show');
  currentOTP=null;otpExpiry=null;pendingResetUser=null;
}

// Show forgot password error
function showForgotPasswordError(message){
  var errorDiv=document.getElementById('forgotPasswordError');
  document.getElementById('forgotPasswordErrorText').textContent=message;
  errorDiv.style.display='flex';
}

// Show OTP error
function showOTPError(message){
  var errorDiv=document.getElementById('otpError');
  document.getElementById('otpErrorText').textContent=message;
  errorDiv.style.display='flex';
}

// Show new password error
function showNewPasswordError(message){
  var errorDiv=document.getElementById('newPasswordError');
  document.getElementById('newPasswordErrorText').textContent=message;
  errorDiv.style.display='flex';
}

// Send OTP to email
function sendOTPEmail(){
  var email=document.getElementById('forgotPasswordEmail').value.trim();
  if(!email){showForgotPasswordError('Please enter your email address');return;}
  var emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if(!emailRegex.test(email)){showForgotPasswordError('Please enter a valid email address');return;}
  var users=loadUsers();
  var user=users.find(function(u){return u.email&&u.email.toLowerCase()===email.toLowerCase();});
  if(!user){showForgotPasswordError('No account found with this email address');return;}
  currentOTP=generateOTP();
  otpExpiry=Date.now()+(10*60*1000);
  pendingResetUser=user;
  sendOTPViaEmail(user.email,currentOTP,user.displayName);
}

// Send OTP via EmailJS or show demo message
function sendOTPViaEmail(email,otp,userName){
  var emailJSConfigured=typeof emailjs!=='undefined'&&
    window.EMAILJS_PUBLIC_KEY&&window.EMAILJS_SERVICE_ID&&window.EMAILJS_TEMPLATE_ID;
  if(emailJSConfigured){
    emailjs.send(window.EMAILJS_SERVICE_ID,window.EMAILJS_TEMPLATE_ID,{
      email:email,passcode:otp,time:'10 minutes'
    }).then(function(response){
      console.log('Email sent successfully:',response);
      showOTPStep();
      alert('OTP sent to your email address');
    },function(error){
      console.error('Email failed:',error);
      alert('Email sending failed: '+(error.text||error.message||'Unknown error')+'\n\nFalling back to demo mode.');
      showDemoOTP(otp);
    });
  }else{
    console.log('EmailJS not configured, using demo mode');
    showDemoOTP(otp);
  }
}

// Show OTP in demo mode
function showDemoOTP(otp){
  showOTPStep();
  alert('DEMO MODE\n\nYour One-Time Password is:\n\n'+otp+'\n\n(In production, this would be sent to your email)\n\nThis code expires in 10 minutes.');
}

// Show OTP entry step
function showOTPStep(){
  document.getElementById('loginStepForgotPassword').style.display='none';
  document.getElementById('loginStepOTP').style.display='block';
  document.getElementById('otpCode').value='';
  document.getElementById('otpError').style.display='none';
  document.getElementById('otpCode').focus();
}

// Resend OTP
function resendOTP(){
  if(!pendingResetUser){cancelForgotPassword();return;}
  currentOTP=generateOTP();
  otpExpiry=Date.now()+(10*60*1000);
  sendOTPViaEmail(pendingResetUser.email,currentOTP,pendingResetUser.displayName);
}

// Verify OTP
function verifyOTP(){
  var enteredOTP=document.getElementById('otpCode').value.trim();
  if(!enteredOTP){showOTPError('Please enter the OTP code');return;}
  if(enteredOTP.length!==6){showOTPError('OTP must be 6 digits');return;}
  if(Date.now()>otpExpiry){showOTPError('OTP has expired. Please request a new one.');return;}
  if(enteredOTP===currentOTP){
    showNewPasswordStep();
  }else{
    showOTPError('Invalid OTP. Please check and try again.');
    document.getElementById('otpCode').value='';
    document.getElementById('otpCode').focus();
  }
}

// Show new password step
function showNewPasswordStep(){
  document.getElementById('loginStepOTP').style.display='none';
  document.getElementById('loginStepNewPassword').style.display='block';
  document.getElementById('newPassword').value='';
  document.getElementById('confirmNewPassword').value='';
  document.getElementById('newPasswordError').style.display='none';
  document.getElementById('newPassword').focus();
}

// Reset password
function resetPassword(){
  var newPw=document.getElementById('newPassword').value;
  var confirmPw=document.getElementById('confirmNewPassword').value;
  if(!newPw){showNewPasswordError('Please enter a new password');return;}
  if(newPw.length<6){showNewPasswordError('Password must be at least 6 characters long');return;}
  if(newPw!==confirmPw){showNewPasswordError('Passwords do not match');return;}
  if(!pendingResetUser){showNewPasswordError('Session expired. Please try again.');cancelForgotPassword();return;}
  var users=loadUsers();
  var userIndex=users.findIndex(function(u){return u.username.toLowerCase()===pendingResetUser.username.toLowerCase();});
  if(userIndex!==-1){
    users[userIndex].password=newPw;
    saveUsers(users);
    currentOTP=null;otpExpiry=null;pendingResetUser=null;
    alert('Password reset successful! You can now log in with your new password.');
    cancelForgotPassword();
    if(isCloudConnected&&googleAccessToken)autoSaveUsersToCloud();
  }else{
    showNewPasswordError('User not found. Please try again.');
  }
}

// ==================== PERMISSION REQUEST SYSTEM ====================
const PERM_DURATION_MS=20*60*1000; // 20 minutes

function submitPermissionRequest(){
  if(!currentUser){alert('Please log in');return;}
  if(isAdminRole(currentUser.role)){alert('Admins have full access ‚Äî no permission needed');return;}
  const reason=document.getElementById('permRequestReason').value.trim();
  if(!reason){alert('Please enter a reason for the request');return;}
  // Check for existing pending request
  const perms=loadPermissions();
  const hasPending=perms.some(p=>p.userId===currentUser.id&&p.status==='pending');
  if(hasPending){alert('You already have a pending request. Please wait for admin approval.');return;}
  perms.push({
    id:'perm_'+Date.now(),userId:currentUser.id,username:currentUser.username,
    displayName:currentUser.displayName,role:currentUser.role,
    reason:reason,status:'pending',
    requestedAt:new Date().toISOString(),
    grantedAt:null,expiresAt:null,handledBy:null
  });
  savePermissions(perms);
  document.getElementById('permRequestReason').value='';
  renderPermissions();
  updatePermBadge();
}

function grantPermission(permId){
  if(!currentUser||!isAdminRole(currentUser.role))return;
  const perms=loadPermissions();
  const p=perms.find(x=>x.id===permId);
  if(!p)return;
  const now=new Date();
  p.status='approved';
  p.grantedAt=now.toISOString();
  p.expiresAt=new Date(now.getTime()+PERM_DURATION_MS).toISOString();
  p.handledBy=currentUser.displayName;
  savePermissions(perms);
  renderPermissions();
  updatePermBadge();
}

function denyPermission(permId){
  if(!currentUser||!isAdminRole(currentUser.role))return;
  const perms=loadPermissions();
  const p=perms.find(x=>x.id===permId);
  if(!p)return;
  p.status='denied';
  p.handledBy=currentUser.displayName;
  savePermissions(perms);
  renderPermissions();
  updatePermBadge();
}

function hasPayrollEditPermission(){
  if(!currentUser)return false;
  if(isAdminRole(currentUser.role))return true;
  if(currentUser.role==='viewer')return false;
  // Check for active (non-expired) approved permission
  const perms=loadPermissions();
  const now=new Date();
  return perms.some(p=>p.userId===currentUser.id&&p.status==='approved'&&p.expiresAt&&new Date(p.expiresAt)>now);
}

function getActivePermission(){
  if(!currentUser)return null;
  const perms=loadPermissions();
  const now=new Date();
  return perms.find(p=>p.userId===currentUser.id&&p.status==='approved'&&p.expiresAt&&new Date(p.expiresAt)>now)||null;
}

function checkPayrollPermission(action){
  if(hasPayrollEditPermission())return true;
  if(!currentUser)return false;
  if(currentUser.role==='viewer'){
    alert('View-only access: You do not have permission to '+action+'.\nContact your administrator.');
    return false;
  }
  alert('Permission required to '+action+'.\n\nPlease go to the Permissions page to submit a request.\nOnce approved by an admin, you will have 20 minutes of editing access.');
  return false;
}

function closePermExpiredModal(){document.getElementById('permExpiredModal').classList.remove('show');}

function startPermTimer(){
  if(permTimerInterval)clearInterval(permTimerInterval);
  permTimerInterval=setInterval(function(){
    if(!currentUser||isAdminRole(currentUser.role))return;
    // Check if any approved permission just expired
    const perms=loadPermissions();
    const now=new Date();
    let anyExpired=false;
    perms.forEach(function(p){
      if(p.userId===currentUser.id&&p.status==='approved'&&p.expiresAt){
        const exp=new Date(p.expiresAt);
        if(exp<=now){
          p.status='expired';
          anyExpired=true;
        }
      }
    });
    if(anyExpired){
      savePermissions(perms);
      document.getElementById('permExpiredModal').classList.add('show');
      if(currentPageName==='permissions')renderPermissions();
    }
    // Update banner if on permissions page
    if(currentPageName==='permissions')updatePermStatusBanner();
  },5000); // check every 5 seconds
}

function updatePermBadge(){
  const badge=document.getElementById('permNotifBadge');
  if(!badge)return;
  if(currentUser&&isAdminRole(currentUser.role)){
    const perms=loadPermissions();
    const pending=perms.filter(p=>p.status==='pending').length;
    badge.textContent=pending;
    badge.style.display=pending>0?'':'none';
  }else{
    badge.style.display='none';
  }
}

function updatePermStatusBanner(){
  const banner=document.getElementById('permStatusBanner');
  if(!currentUser||isAdminRole(currentUser.role)){banner.style.display='none';return;}
  const activePerm=getActivePermission();
  if(activePerm){
    const remaining=Math.max(0,Math.ceil((new Date(activePerm.expiresAt)-new Date())/1000));
    const mins=Math.floor(remaining/60);
    const secs=remaining%60;
    banner.innerHTML='<div class="perm-banner granted"><div><strong>Payroll Edit Permission Active</strong><br><span style="font-size:.78rem;color:var(--text-dim)">You can edit, add, and delete payroll runs</span></div><div class="perm-timer">'+mins+':'+String(secs).padStart(2,'0')+' remaining</div></div>';
    banner.style.display='';
  }else{
    const perms=loadPermissions();
    const hasPending=perms.some(p=>p.userId===currentUser.id&&p.status==='pending');
    if(hasPending){
      banner.innerHTML='<div class="perm-banner"><div><strong>Permission Request Pending</strong><br><span style="font-size:.78rem;color:var(--text-dim)">Waiting for administrator approval...</span></div><div style="color:var(--accent)">Pending</div></div>';
      banner.style.display='';
    }else{
      banner.innerHTML='<div class="perm-banner expired"><div><strong>No Active Permission</strong><br><span style="font-size:.78rem;color:var(--text-dim)">Submit a request below to edit payroll data</span></div><div class="perm-timer">Expired</div></div>';
      banner.style.display='';
    }
  }
}

function renderPermissions(){
  const isAdmin=currentUser&&isAdminRole(currentUser.role);
  const perms=loadPermissions();
  const now=new Date();

  // Expire any overdue approved permissions
  let changed=false;
  perms.forEach(function(p){
    if(p.status==='approved'&&p.expiresAt&&new Date(p.expiresAt)<=now){p.status='expired';changed=true;}
  });
  if(changed)savePermissions(perms);

  // Show/hide panels based on role
  document.getElementById('permRequestPanel').style.display=isAdmin?'none':'';
  document.getElementById('adminRequestsPanel').style.display=isAdmin?'':'none';
  updatePermStatusBanner();

  // Admin: render incoming requests
  if(isAdmin){
    const pending=perms.filter(p=>p.status==='pending');
    document.getElementById('pendingRequestCount').textContent=pending.length+' pending';
    var reqHtml='';
    if(pending.length===0){
      reqHtml='<p style="text-align:center;color:var(--text-muted);padding:1.5rem">No pending permission requests</p>';
    }else{
      pending.forEach(function(p){
        reqHtml+='<div class="perm-request-card">'+
          '<div class="req-header"><span class="req-user">'+p.displayName+' <span class="role-tag user">'+p.role+'</span></span><span class="req-time">'+fmtDate(p.requestedAt)+'</span></div>'+
          '<div class="req-reason">'+p.reason+'</div>'+
          '<div class="req-actions">'+
            '<button class="btn btn-success btn-sm" onclick="grantPermission(\''+p.id+'\')">Approve (20 min)</button>'+
            '<button class="btn btn-danger btn-sm" onclick="denyPermission(\''+p.id+'\')">Deny</button>'+
          '</div></div>';
      });
    }
    document.getElementById('adminRequestsList').innerHTML=reqHtml;
  }

  // History table (all users see their own, admin sees all)
  var historyPerms=isAdmin?perms:perms.filter(function(p){return p.userId===currentUser.id;});
  historyPerms.sort(function(a,b){return new Date(b.requestedAt)-new Date(a.requestedAt);});
  var html='<table><thead><tr>'+(isAdmin?'<th>User</th>':'')+'<th>Reason</th><th>Status</th><th>Requested</th><th>Expires</th>'+(isAdmin?'<th>Handled By</th>':'')+'</tr></thead><tbody>';
  historyPerms.forEach(function(p){
    var statusClass=p.status;
    var statusLabel=p.status.charAt(0).toUpperCase()+p.status.slice(1);
    var expStr='‚Äî';
    if(p.expiresAt){
      var exp=new Date(p.expiresAt);
      if(exp>now){
        var rem=Math.ceil((exp-now)/1000);var mins=Math.floor(rem/60);var secs=rem%60;
        expStr='<span style="color:var(--green);font-weight:600">'+mins+':'+String(secs).padStart(2,'0')+'</span>';
      }else{
        expStr='<span style="color:var(--text-muted)">Expired</span>';
      }
    }
    html+='<tr>'+(isAdmin?'<td>'+p.displayName+'</td>':'')+'<td style="max-width:300px;white-space:normal;font-size:.82rem">'+p.reason+'</td>'+
      '<td><span class="req-status '+statusClass+'">'+statusLabel+'</span></td>'+
      '<td style="font-size:.8rem;color:var(--text-muted)">'+fmtDate(p.requestedAt)+'</td>'+
      '<td>'+expStr+'</td>'+(isAdmin?'<td style="font-size:.8rem;color:var(--text-muted)">'+(p.handledBy||'‚Äî')+'</td>':'')+'</tr>';
  });
  if(historyPerms.length===0)html+='<tr><td colspan="'+(isAdmin?6:4)+'" style="text-align:center;color:var(--text-muted);padding:2rem">No permission requests yet</td></tr>';
  html+='</tbody></table>';
  document.getElementById('permHistoryTable').innerHTML=html;
  updatePermBadge();
}

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded',function(){
    // Ensure users are always persisted to localStorage
    users=loadUsers();
    var needsSave=!localStorage.getItem(USERS_KEY);
    // Ensure default admin always exists (case-insensitive check)
    if(!users.some(function(u){return u.username.toLowerCase()==='cestisadmin';})){
      users.push(getDefaultUsers()[0]);
      needsSave=true;
    }
    if(needsSave)saveUsers(users);

    // Check for existing session (CESTIS-MAIN-DASHBOARD uses sessionStorage)
    if(checkSession()){
      checkAuth();
    }else{
      // On login screen: auto-sync credentials from cloud if token is available
      autoSyncCredentialsOnLoad();
    }

    initializeCloudSync();
    setTimeout(function(){ initGoogleAuth(); }, 500);

    // 2FA input event listeners ‚Äî restrict to numeric and handle Enter key
    ['login2FACode','twofaSetupCode','twofaDisableCode','otpCode'].forEach(function(inputId){
      var input=document.getElementById(inputId);
      if(input){
        input.addEventListener('input',function(){this.value=this.value.replace(/[^0-9]/g,'');});
        input.addEventListener('keypress',function(e){
          if(e.key==='Enter'){
            e.preventDefault();
            if(inputId==='login2FACode')verify2FALogin();
            else if(inputId==='twofaSetupCode')confirmTwoFASetup();
            else if(inputId==='twofaDisableCode')confirmTwoFADisable();
            else if(inputId==='otpCode')verifyOTP();
          }
        });
      }
    });
    // Backup code input ‚Äî allow alphanumeric, convert to uppercase
    var backupCodeInput=document.getElementById('loginBackupCode');
    if(backupCodeInput){
      backupCodeInput.addEventListener('input',function(){this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'');});
      backupCodeInput.addEventListener('keypress',function(e){if(e.key==='Enter'){e.preventDefault();verifyBackupCodeLogin();}});
    }
    // Escape key to close 2FA modals
    document.addEventListener('keydown',function(e){
      if(e.key==='Escape'){
        closeTwoFASetup();closeBackupCodesModal();closeTwoFADisable();
      }
    });

    // After init, check cloud status and notify if disconnected
    setTimeout(function(){
      checkCloudAndNotify('page_load');
      startCloudMonitor();
    }, 2000);
});
</script>
</body>
</html>
